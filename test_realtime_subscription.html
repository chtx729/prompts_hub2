<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶è®¢é˜…æµ‹è¯• - AIæç¤ºè¯å®åº“</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
            background: var(--background-color);
        }
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            background: var(--surface-color);
        }
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-connected {
            background: var(--success-50);
            color: var(--success-600);
            border: 1px solid var(--success-200);
        }
        .status-disconnected {
            background: var(--error-50);
            color: var(--error-600);
            border: 1px solid var(--error-200);
        }
        .status-connecting {
            background: var(--warning-50);
            color: var(--warning-600);
            border: 1px solid var(--warning-200);
        }
        .log-container {
            background: var(--gray-900);
            color: var(--gray-100);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .log-entry {
            margin-bottom: var(--space-1);
        }
        .log-timestamp {
            color: var(--gray-400);
        }
        .log-info { color: var(--blue-400); }
        .log-success { color: var(--success-400); }
        .log-warning { color: var(--warning-400); }
        .log-error { color: var(--error-400); }
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: var(--space-2);
            transition: var(--transition-fast);
        }
        button:hover { 
            background: var(--primary-hover);
            transform: translateY(-1px);
        }
        button:disabled {
            background: var(--gray-400);
            cursor: not-allowed;
            transform: none;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/performance.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/prompts.js"></script>
</head>
<body>
    <h1>ğŸ“¡ å®æ—¶è®¢é˜…åŠŸèƒ½æµ‹è¯•</h1>
    <p>æ­¤å·¥å…·ç”¨äºæµ‹è¯•promptsè¡¨çš„å®æ—¶è®¢é˜…åŠŸèƒ½ã€‚</p>

    <div class="test-section">
        <h3>ğŸ“Š è®¢é˜…çŠ¶æ€</h3>
        <div>
            <strong>è¿æ¥çŠ¶æ€ï¼š</strong>
            <span class="status-indicator status-connecting" id="connection-status">
                <i class="fas fa-circle-notch fa-spin"></i>
                æ£€æŸ¥ä¸­...
            </span>
        </div>
        <div style="margin-top: var(--space-2);">
            <strong>PromptsManagerï¼š</strong>
            <span id="manager-status">æœªåˆå§‹åŒ–</span>
        </div>
        <div style="margin-top: var(--space-2);">
            <strong>å½“å‰æç¤ºè¯æ•°é‡ï¼š</strong>
            <span id="prompts-count">0</span>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ›ï¸ æ§åˆ¶é¢æ¿</h3>
        <button onclick="checkSupabase()" id="check-btn">æ£€æŸ¥Supabase</button>
        <button onclick="initializeManager()" id="init-btn">åˆå§‹åŒ–PromptsManager</button>
        <button onclick="testSubscription()" id="test-btn">æµ‹è¯•è®¢é˜…</button>
        <button onclick="simulateUpdate()" id="simulate-btn">æ¨¡æ‹Ÿæ•°æ®æ›´æ–°</button>
        <button onclick="clearLogs()" id="clear-btn">æ¸…ç©ºæ—¥å¿—</button>
        <button onclick="refreshStatus()" id="refresh-btn">åˆ·æ–°çŠ¶æ€</button>
    </div>

    <div class="test-section">
        <h3>ğŸ“ å®æ—¶æ—¥å¿—</h3>
        <div class="log-container" id="log-container">
            <div class="log-entry">
                <span class="log-timestamp">[ç­‰å¾…åˆå§‹åŒ–]</span>
                <span class="log-info">å‡†å¤‡å¼€å§‹å®æ—¶è®¢é˜…æµ‹è¯•...</span>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
        <ol>
            <li><strong>æ£€æŸ¥Supabase</strong>ï¼šç‚¹å‡»"æ£€æŸ¥Supabase"æŒ‰é’®éªŒè¯é…ç½®</li>
            <li><strong>åˆå§‹åŒ–ç®¡ç†å™¨</strong>ï¼šç‚¹å‡»"åˆå§‹åŒ–PromptsManager"æŒ‰é’®</li>
            <li><strong>æ£€æŸ¥è®¢é˜…çŠ¶æ€</strong>ï¼šè§‚å¯Ÿè¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨</li>
            <li><strong>ç›‘æ§æ—¥å¿—</strong>ï¼šæŸ¥çœ‹å®æ—¶æ—¥å¿—ä¸­çš„è®¢é˜…äº‹ä»¶</li>
            <li><strong>æµ‹è¯•æ›´æ–°</strong>ï¼šåœ¨å¦ä¸€ä¸ªçª—å£ä¿®æ”¹promptsè¡¨æ•°æ®</li>
            <li><strong>éªŒè¯å“åº”</strong>ï¼šç¡®è®¤é¡µé¢æ”¶åˆ°å®æ—¶æ›´æ–°é€šçŸ¥</li>
        </ol>
    </div>

    <script>
        let logContainer;
        let connectionStatus;
        let managerStatus;
        let promptsCount;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            logContainer = document.getElementById('log-container');
            connectionStatus = document.getElementById('connection-status');
            managerStatus = document.getElementById('manager-status');
            promptsCount = document.getElementById('prompts-count');

            // æ‹¦æˆªconsole.logæ¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
            interceptConsoleLog();
            
            // å®šæœŸæ›´æ–°çŠ¶æ€
            setInterval(refreshStatus, 3000);
            
            addLog('info', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•å®æ—¶è®¢é˜…åŠŸèƒ½');
        });

        function addLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-${type}">${message}</span>
            `;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            logContainer.innerHTML = '';
            addLog('info', 'æ—¥å¿—å·²æ¸…ç©º');
        }

        function interceptConsoleLog() {
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;

            console.log = function(...args) {
                originalLog.apply(console, args);
                if (args[0] && typeof args[0] === 'string') {
                    if (args[0].includes('å®æ—¶è®¢é˜…') || args[0].includes('ğŸ“¡') || args[0].includes('âœ…') || args[0].includes('âŒ')) {
                        addLog('info', args.join(' '));
                    }
                }
            };

            console.error = function(...args) {
                originalError.apply(console, args);
                if (args[0] && typeof args[0] === 'string') {
                    addLog('error', args.join(' '));
                }
            };

            console.warn = function(...args) {
                originalWarn.apply(console, args);
                if (args[0] && typeof args[0] === 'string') {
                    addLog('warning', args.join(' '));
                }
            };
        }

        function checkSupabase() {
            addLog('info', 'æ£€æŸ¥Supabaseé…ç½®...');

            // æ£€æŸ¥Supabaseæ˜¯å¦åŠ è½½
            if (!window.supabase) {
                addLog('error', 'SupabaseæœªåŠ è½½');
                return;
            }

            addLog('success', 'Supabaseå·²åŠ è½½');

            // æ£€æŸ¥é…ç½®
            if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
                addLog('error', 'Supabaseé…ç½®ç¼ºå¤±');
                return;
            }

            addLog('success', `Supabase URL: ${window.SUPABASE_URL}`);
            addLog('info', 'Supabaseé…ç½®æ­£å¸¸');

            // æµ‹è¯•è¿æ¥
            supabase.from('prompts').select('count', { count: 'exact', head: true })
                .then(({ error, count }) => {
                    if (error) {
                        addLog('error', `Supabaseè¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`);
                    } else {
                        addLog('success', `Supabaseè¿æ¥æ­£å¸¸ï¼Œpromptsè¡¨æœ‰ ${count} æ¡è®°å½•`);
                    }
                })
                .catch(err => {
                    addLog('error', `è¿æ¥æµ‹è¯•å¼‚å¸¸: ${err.message}`);
                });
        }

        async function initializeManager() {
            const btn = document.getElementById('init-btn');
            btn.disabled = true;
            btn.textContent = 'åˆå§‹åŒ–ä¸­...';

            try {
                addLog('info', 'å¼€å§‹åˆå§‹åŒ–PromptsManager...');
                
                // åˆ›å»ºPromptsManagerå®ä¾‹
                if (!window.promptsManager) {
                    window.promptsManager = new PromptsManager();
                }

                // åˆå§‹åŒ–
                await window.promptsManager.init();
                
                addLog('success', 'PromptsManageråˆå§‹åŒ–å®Œæˆ');
                refreshStatus();
                
            } catch (error) {
                addLog('error', `åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'åˆå§‹åŒ–PromptsManager';
            }
        }

        function testSubscription() {
            addLog('info', 'æµ‹è¯•è®¢é˜…åŠŸèƒ½...');
            
            if (!window.promptsManager) {
                addLog('error', 'PromptsManageræœªåˆå§‹åŒ–');
                return;
            }

            if (!window.promptsManager.subscription) {
                addLog('error', 'è®¢é˜…æœªå»ºç«‹');
                return;
            }

            addLog('success', 'è®¢é˜…åŠŸèƒ½æ­£å¸¸ï¼Œç­‰å¾…æ•°æ®å˜åŒ–...');
            addLog('info', 'è¯·åœ¨å¦ä¸€ä¸ªçª—å£ä¿®æ”¹promptsè¡¨æ•°æ®æ¥æµ‹è¯•å®æ—¶æ›´æ–°');
        }

        function simulateUpdate() {
            addLog('info', 'æ¨¡æ‹Ÿæ•°æ®æ›´æ–°...');
            
            // æ¨¡æ‹Ÿæ”¶åˆ°å®æ—¶æ›´æ–°
            const mockPayload = {
                eventType: 'INSERT',
                new: {
                    prompt_id: 999,
                    title: 'æµ‹è¯•æç¤ºè¯',
                    status: 'published',
                    is_public: true,
                    created_at: new Date().toISOString()
                }
            };

            if (window.promptsManager && window.promptsManager.handleRealtimeUpdate) {
                window.promptsManager.handleRealtimeUpdate(mockPayload);
                addLog('success', 'æ¨¡æ‹Ÿæ›´æ–°å·²å‘é€');
            } else {
                addLog('error', 'PromptsManageræœªå‡†å¤‡å¥½');
            }
        }

        function refreshStatus() {
            // æ£€æŸ¥Supabase
            if (!window.supabase) {
                addLog('error', 'Supabaseæœªåˆå§‹åŒ–');
                connectionStatus.className = 'status-indicator status-disconnected';
                connectionStatus.innerHTML = '<i class="fas fa-times-circle"></i> Supabaseæœªåˆå§‹åŒ–';
                return;
            }

            // æ›´æ–°è¿æ¥çŠ¶æ€
            if (window.promptsManager && window.promptsManager.subscription) {
                // æ£€æŸ¥è®¢é˜…çŠ¶æ€
                const subscription = window.promptsManager.subscription;
                if (subscription.state === 'joined') {
                    connectionStatus.className = 'status-indicator status-connected';
                    connectionStatus.innerHTML = '<i class="fas fa-check-circle"></i> å·²è¿æ¥';
                } else {
                    connectionStatus.className = 'status-indicator status-connecting';
                    connectionStatus.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> è¿æ¥ä¸­...';
                }
            } else if (window.promptsManager) {
                connectionStatus.className = 'status-indicator status-disconnected';
                connectionStatus.innerHTML = '<i class="fas fa-times-circle"></i> è®¢é˜…æœªå»ºç«‹';
            } else {
                connectionStatus.className = 'status-indicator status-disconnected';
                connectionStatus.innerHTML = '<i class="fas fa-times-circle"></i> ç®¡ç†å™¨æœªåˆå§‹åŒ–';
            }

            // æ›´æ–°ç®¡ç†å™¨çŠ¶æ€
            if (window.promptsManager) {
                managerStatus.textContent = 'å·²åˆå§‹åŒ–';
                managerStatus.style.color = 'var(--success-color)';

                // æ›´æ–°æç¤ºè¯æ•°é‡
                if (window.promptsManager.currentPrompts) {
                    promptsCount.textContent = window.promptsManager.currentPrompts.length;
                }
            } else {
                managerStatus.textContent = 'æœªåˆå§‹åŒ–';
                managerStatus.style.color = 'var(--error-color)';
            }
        }

        // ç›‘å¬é¡µé¢å¸è½½
        window.addEventListener('beforeunload', () => {
            if (window.promptsManager) {
                window.promptsManager.cleanup();
                addLog('info', 'é¡µé¢å¸è½½ï¼Œæ¸…ç†è®¢é˜…èµ„æº');
            }
        });
    </script>
</body>
</html>
