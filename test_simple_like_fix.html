<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•ç‚¹èµä¿®å¤æµ‹è¯•</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--background-color);
        }
        .test-container {
            background: var(--surface-color);
            padding: 2rem;
            border-radius: var(--radius-xl);
            margin-bottom: 2rem;
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
        }
        .test-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: 0.5rem;
        }
        .test-button:hover {
            background: var(--primary-hover);
        }
        .count-display {
            background: var(--info-50);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            border: 1px solid var(--info-200);
            font-family: monospace;
        }
        .log-output {
            background: var(--gray-900);
            color: var(--gray-100);
            padding: 1rem;
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 1rem 0;
        }
        .success {
            color: var(--success-600);
            font-weight: bold;
        }
        .error {
            color: var(--error-600);
            font-weight: bold;
        }
        .demo-like-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s ease;
        }
        .demo-like-btn:hover {
            background: var(--primary-hover);
        }
        .demo-like-btn.liked {
            background: var(--error-color);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/api.js"></script>
    <script src="js/prompts.js"></script>
    <script src="js/myspace.js"></script>
    <script src="js/main.js"></script>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ ç®€å•ç‚¹èµä¿®å¤æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¿®å¤åçš„ç‚¹èµè®¡æ•°å‡†ç¡®æ€§</p>
    </div>

    <div class="test-container">
        <div class="test-section">
            <h3>æµ‹è¯•è®¾ç½®</h3>
            <label for="test-prompt-id">æµ‹è¯•æç¤ºè¯ID:</label>
            <input type="number" id="test-prompt-id" value="1" min="1" style="margin: 0 1rem; padding: 0.5rem;">
            <button class="test-button" onclick="selectPrompt()">é€‰æ‹©</button>
            <button class="test-button" onclick="resetPromptCounts()">é‡ç½®è®¡æ•°</button>
        </div>

        <div class="test-section">
            <h3>å½“å‰çŠ¶æ€</h3>
            <div id="count-display" class="count-display">
                æç¤ºè¯ID: <span id="current-prompt-id">1</span><br>
                user_likesè®°å½•æ•°: <span id="user-likes-count">-</span><br>
                prompts.like_count: <span id="prompts-like-count">-</span><br>
                ä¸€è‡´æ€§: <span id="consistency-status">-</span>
            </div>
            <button class="test-button" onclick="checkCounts()">åˆ·æ–°çŠ¶æ€</button>
        </div>

        <div class="test-section">
            <h3>ç‚¹èµæµ‹è¯•</h3>
            <div style="text-align: center; margin: 2rem 0;">
                <button class="demo-like-btn" id="demo-like-btn" onclick="testLike()">
                    <i class="fas fa-heart"></i>
                    ç‚¹èµ
                </button>
            </div>
            <button class="test-button" onclick="testMultipleLikes()">è¿ç»­ç‚¹èµæµ‹è¯•</button>
            <button class="test-button" onclick="testTogglePattern()">åˆ‡æ¢æ¨¡å¼æµ‹è¯•</button>
        </div>

        <div class="test-section">
            <h3>æ“ä½œæ—¥å¿—</h3>
            <button class="test-button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="operation-log" class="log-output">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script>
        let logElement;
        let currentPromptId = 1;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (logElement) {
                logElement.innerHTML += `<span class="${className}">${logMessage}</span>`;
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(logMessage);
        }

        function selectPrompt() {
            const input = document.getElementById('test-prompt-id');
            currentPromptId = parseInt(input.value) || 1;
            document.getElementById('current-prompt-id').textContent = currentPromptId;
            log(`é€‰æ‹©æµ‹è¯•æç¤ºè¯ID: ${currentPromptId}`);
            checkCounts();
        }

        async function checkCounts() {
            log('æ£€æŸ¥å½“å‰è®¡æ•°çŠ¶æ€...');
            
            try {
                // æŸ¥è¯¢user_likesè¡¨è®°å½•æ•°
                const { data: likesData, error: likesError } = await supabase
                    .from('user_likes')
                    .select('like_id', { count: 'exact' })
                    .eq('prompt_id', currentPromptId);

                if (likesError) throw likesError;

                const userLikesCount = likesData ? likesData.length : 0;
                document.getElementById('user-likes-count').textContent = userLikesCount;

                // æŸ¥è¯¢promptsè¡¨like_count
                const { data: promptData, error: promptError } = await supabase
                    .from('prompts')
                    .select('like_count')
                    .eq('prompt_id', currentPromptId)
                    .single();

                if (promptError) throw promptError;

                const promptsLikeCount = promptData ? (promptData.like_count || 0) : 0;
                document.getElementById('prompts-like-count').textContent = promptsLikeCount;

                // æ£€æŸ¥ä¸€è‡´æ€§
                const isConsistent = userLikesCount === promptsLikeCount;
                const statusElement = document.getElementById('consistency-status');
                
                if (isConsistent) {
                    statusElement.textContent = 'âœ… ä¸€è‡´';
                    statusElement.className = 'success';
                    log(`æ•°æ®ä¸€è‡´: user_likes=${userLikesCount}, like_count=${promptsLikeCount}`, 'success');
                } else {
                    statusElement.textContent = 'âŒ ä¸ä¸€è‡´';
                    statusElement.className = 'error';
                    log(`æ•°æ®ä¸ä¸€è‡´: user_likes=${userLikesCount}, like_count=${promptsLikeCount}`, 'error');
                }

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateButtonState();

            } catch (error) {
                log(`æ£€æŸ¥è®¡æ•°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function updateButtonState() {
            try {
                const isLiked = await apiManager.isLiked(currentPromptId);
                const btn = document.getElementById('demo-like-btn');
                btn.classList.toggle('liked', isLiked);
                btn.innerHTML = `
                    <i class="fas fa-heart"></i>
                    ${isLiked ? 'å·²èµ' : 'ç‚¹èµ'}
                `;
            } catch (error) {
                log(`æ›´æ–°æŒ‰é’®çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testLike() {
            log('=== æ‰§è¡Œç‚¹èµæ“ä½œ ===');
            
            try {
                // è®°å½•æ“ä½œå‰çŠ¶æ€
                const beforeUserLikes = parseInt(document.getElementById('user-likes-count').textContent);
                const beforePromptsCount = parseInt(document.getElementById('prompts-like-count').textContent);
                
                log(`æ“ä½œå‰: user_likes=${beforeUserLikes}, like_count=${beforePromptsCount}`);

                // æ‰§è¡Œç‚¹èµæ“ä½œ
                const result = await apiManager.toggleLike(currentPromptId);
                log(`ç‚¹èµæ“ä½œç»“æœ: ${JSON.stringify(result)}`);

                if (result.success) {
                    // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿æ•°æ®åº“æ›´æ–°å®Œæˆ
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // æ£€æŸ¥æ“ä½œåçŠ¶æ€
                    await checkCounts();
                    
                    const afterUserLikes = parseInt(document.getElementById('user-likes-count').textContent);
                    const afterPromptsCount = parseInt(document.getElementById('prompts-like-count').textContent);
                    
                    log(`æ“ä½œå: user_likes=${afterUserLikes}, like_count=${afterPromptsCount}`);

                    // éªŒè¯å˜åŒ–
                    const userLikesChange = afterUserLikes - beforeUserLikes;
                    const promptsCountChange = afterPromptsCount - beforePromptsCount;

                    if (userLikesChange === promptsCountChange) {
                        log(`âœ… è®¡æ•°å˜åŒ–ä¸€è‡´: éƒ½å˜åŒ–äº†${userLikesChange}`, 'success');
                    } else {
                        log(`âŒ è®¡æ•°å˜åŒ–ä¸ä¸€è‡´: user_likeså˜åŒ–${userLikesChange}, like_countå˜åŒ–${promptsCountChange}`, 'error');
                    }
                } else {
                    log(`ç‚¹èµæ“ä½œå¤±è´¥: ${result.error}`, 'error');
                }

            } catch (error) {
                log(`ç‚¹èµæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testMultipleLikes() {
            log('=== è¿ç»­ç‚¹èµæµ‹è¯• ===');
            
            for (let i = 0; i < 5; i++) {
                log(`ç¬¬${i + 1}æ¬¡ç‚¹èµ:`);
                await testLike();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        async function testTogglePattern() {
            log('=== åˆ‡æ¢æ¨¡å¼æµ‹è¯• ===');
            
            // æ‰§è¡Œç‚¹èµ-å–æ¶ˆ-ç‚¹èµ-å–æ¶ˆçš„æ¨¡å¼
            const operations = ['ç‚¹èµ', 'å–æ¶ˆ', 'ç‚¹èµ', 'å–æ¶ˆ', 'ç‚¹èµ'];
            
            for (let i = 0; i < operations.length; i++) {
                log(`ç¬¬${i + 1}æ­¥: ${operations[i]}`);
                await testLike();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        async function resetPromptCounts() {
            log('=== é‡ç½®æç¤ºè¯è®¡æ•° ===');
            
            try {
                // åˆ é™¤æ‰€æœ‰ç‚¹èµè®°å½•
                const { error: deleteError } = await supabase
                    .from('user_likes')
                    .delete()
                    .eq('prompt_id', currentPromptId);

                if (deleteError) throw deleteError;

                // é‡ç½®è®¡æ•°
                const { error: updateError } = await supabase
                    .from('prompts')
                    .update({ like_count: 0 })
                    .eq('prompt_id', currentPromptId);

                if (updateError) throw updateError;

                log(`âœ… æç¤ºè¯${currentPromptId}çš„è®¡æ•°å·²é‡ç½®`, 'success');
                await checkCounts();

            } catch (error) {
                log(`é‡ç½®è®¡æ•°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            if (logElement) {
                logElement.innerHTML = '';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ç®€å•ç‚¹èµä¿®å¤æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            logElement = document.getElementById('operation-log');
            
            setTimeout(() => {
                log('æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
                selectPrompt();
            }, 1000);
        });
    </script>
</body>
</html>
