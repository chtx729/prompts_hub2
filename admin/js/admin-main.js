// ÁÆ°ÁêÜÂêéÂè∞‰∏ªÂ∫îÁî®
class AdminMain {
    constructor() {
        this.currentPage = 'dashboard';
        this.sidebarCollapsed = false;
        this.charts = {};
        this.refreshInterval = null;
        
        // Á≠âÂæÖËÆ§ËØÅÊàêÂäüÂêéÂàùÂßãÂåñ
        this.initialized = false;
    }
    
    // ÂàùÂßãÂåñÁÆ°ÁêÜÂêéÂè∞
    init() {
        if (this.initialized) {
            return;
        }
        
        console.log('üéõÔ∏è ÂàùÂßãÂåñÁÆ°ÁêÜÂêéÂè∞‰∏ªÂ∫îÁî®...');
        
        try {
            // ÁªëÂÆö‰∫ã‰ª∂
            this.bindEvents();
            
            // ÂàùÂßãÂåñÂØºËà™
            this.initNavigation();
            
            // ÂàùÂßãÂåñÊï∞ÊçÆÁúãÊùø
            this.initDashboard();
            
            // ÂêØÂä®Êï∞ÊçÆÂà∑Êñ∞
            this.startDataRefresh();
            
            this.initialized = true;
            console.log('‚úÖ ÁÆ°ÁêÜÂêéÂè∞‰∏ªÂ∫îÁî®ÂàùÂßãÂåñÂÆåÊàê');
            
        } catch (error) {
            console.error('‚ùå ÁÆ°ÁêÜÂêéÂè∞ÂàùÂßãÂåñÂ§±Ë¥•:', error);
        }
    }
    
    // ÁªëÂÆö‰∫ã‰ª∂
    bindEvents() {
        // ‰æßËæπÊ†èÂàáÊç¢
        const sidebarToggle = document.getElementById('sidebar-toggle');
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => {
                this.toggleSidebar();
            });
        }
        
        // ÁôªÂá∫ÊåâÈíÆ
        const logoutBtn = document.getElementById('admin-logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                this.handleLogout();
            });
        }
        
        // ÂØºËà™ÈìæÊé•
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.getAttribute('data-page');
                if (page) {
                    this.navigateToPage(page);
                }
            });
        });
        
        // Âø´Êç∑Êìç‰ΩúÊåâÈíÆ
        const refreshBtn = document.querySelector('.quick-action-btn[title="Âà∑Êñ∞Êï∞ÊçÆ"]');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                this.refreshData();
            });
        }
        
        // ÂìçÂ∫îÂºè‰æßËæπÊ†èÔºàÁßªÂä®Á´ØÔºâ
        if (window.innerWidth <= 768) {
            this.initMobileSidebar();
        }
        
        // Á™óÂè£Â§ßÂ∞èÂèòÂåñ
        window.addEventListener('resize', () => {
            this.handleResize();
        });
    }
    
    // ÂàùÂßãÂåñÂØºËà™
    initNavigation() {
        // ËÆæÁΩÆÈªòËÆ§È°µÈù¢
        this.navigateToPage('dashboard');
        
        // Â§ÑÁêÜÂìàÂ∏åË∑ØÁî±
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.slice(1);
            if (hash && this.isValidPage(hash)) {
                this.navigateToPage(hash);
            }
        });
        
        // Â§ÑÁêÜÂàùÂßãÂìàÂ∏å
        const initialHash = window.location.hash.slice(1);
        if (initialHash && this.isValidPage(initialHash)) {
            this.navigateToPage(initialHash);
        }
    }
    
    // È°µÈù¢ÂØºËà™
    navigateToPage(pageId) {
        if (!this.isValidPage(pageId)) {
            console.warn('Êó†ÊïàÁöÑÈ°µÈù¢ID:', pageId);
            return;
        }
        
        // Ê£ÄÊü•ÊùÉÈôê
        if (!this.hasPagePermission(pageId)) {
            console.warn('Ê≤°ÊúâËÆøÈóÆÊùÉÈôê:', pageId);
            return;
        }
        
        // ÈöêËóèÊâÄÊúâÈ°µÈù¢
        document.querySelectorAll('.admin-page').forEach(page => {
            page.classList.remove('active');
        });
        
        // ÊòæÁ§∫ÁõÆÊ†áÈ°µÈù¢
        const targetPage = document.getElementById(`${pageId}-page`);
        if (targetPage) {
            targetPage.classList.add('active');
        }
        
        // Êõ¥Êñ∞ÂØºËà™Áä∂ÊÄÅ
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        
        const activeLink = document.querySelector(`[data-page="${pageId}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
        
        // Êõ¥Êñ∞URL
        window.location.hash = pageId;
        
        // Êõ¥Êñ∞ÂΩìÂâçÈ°µÈù¢
        this.currentPage = pageId;
        
        // È°µÈù¢ÁâπÂÆöÂàùÂßãÂåñ
        this.handlePageInit(pageId);
        
        console.log(`üìÑ ÂØºËà™Âà∞È°µÈù¢: ${pageId}`);
    }
    
    // Ê£ÄÊü•È°µÈù¢ÊòØÂê¶ÊúâÊïà
    isValidPage(pageId) {
        const validPages = ['dashboard', 'users', 'prompts', 'categories', 'system', 'logs'];
        return validPages.includes(pageId);
    }
    
    // Ê£ÄÊü•È°µÈù¢ÊùÉÈôê
    hasPagePermission(pageId) {
        if (!window.adminAuth || !window.adminAuth.isAuthenticated()) {
            return false;
        }
        
        // ËøôÈáåÂèØ‰ª•Ê†πÊçÆÂÖ∑‰ΩìÈúÄÊ±ÇÂÆûÁé∞Êõ¥ÁªÜÁ≤íÂ∫¶ÁöÑÊùÉÈôêÊéßÂà∂
        return true;
    }
    
    // È°µÈù¢ÂàùÂßãÂåñÂ§ÑÁêÜ
    handlePageInit(pageId) {
        switch (pageId) {
            case 'dashboard':
                this.initDashboard();
                break;
            case 'users':
                this.initUsersPage();
                break;
            case 'prompts':
                this.initPromptsPage();
                break;
            case 'categories':
                this.initCategoriesPage();
                break;
            case 'system':
                this.initSystemPage();
                break;
            case 'logs':
                this.initLogsPage();
                break;
        }
    }
    
    // ÂàùÂßãÂåñÊï∞ÊçÆÁúãÊùø
    async initDashboard() {
        if (this.currentPage !== 'dashboard') {
            return;
        }
        
        console.log('üìä ÂàùÂßãÂåñÊï∞ÊçÆÁúãÊùø...');
        
        try {
            // Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
            await this.loadDashboardStats();
            
            // ÂàùÂßãÂåñÂõæË°®
            this.initCharts();
            
        } catch (error) {
            console.error('Êï∞ÊçÆÁúãÊùøÂàùÂßãÂåñÂ§±Ë¥•:', error);
        }
    }
    
    // Âä†ËΩΩÊï∞ÊçÆÁúãÊùøÁªüËÆ°Êï∞ÊçÆ
    async loadDashboardStats() {
        try {
            const { data, error } = await supabase
                .from('admin_dashboard_stats')
                .select('*')
                .single();
                
            if (error) {
                throw error;
            }
            
            // Êõ¥Êñ∞ÁªüËÆ°Âç°Áâá
            this.updateStatCard('total-users', data.total_users || 0);
            this.updateStatCard('total-prompts', data.total_prompts || 0);
            this.updateStatCard('today-active-users', data.today_active_users || 0);
            this.updateStatCard('pending-review', data.pending_review || 0);
            
            console.log('‚úÖ Êï∞ÊçÆÁúãÊùøÁªüËÆ°Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê');
            
        } catch (error) {
            console.error('Âä†ËΩΩÊï∞ÊçÆÁúãÊùøÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', error);
            
            // ÊòæÁ§∫ÈîôËØØÁä∂ÊÄÅ
            this.updateStatCard('total-users', 'Error');
            this.updateStatCard('total-prompts', 'Error');
            this.updateStatCard('today-active-users', 'Error');
            this.updateStatCard('pending-review', 'Error');
        }
    }
    
    // Êõ¥Êñ∞ÁªüËÆ°Âç°Áâá
    updateStatCard(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            // Ê∑ªÂä†Âä®ÁîªÊïàÊûú
            element.style.opacity = '0.5';
            setTimeout(() => {
                element.textContent = this.formatNumber(value);
                element.style.opacity = '1';
            }, 150);
        }
    }
    
    // Ê†ºÂºèÂåñÊï∞Â≠ó
    formatNumber(num) {
        if (typeof num !== 'number') {
            return num;
        }
        
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        
        return num.toString();
    }
    
    // ÂàùÂßãÂåñÂõæË°®
    initCharts() {
        this.initUserGrowthChart();
        this.initPromptGrowthChart();
    }
    
    // ÂàùÂßãÂåñÁî®Êà∑Â¢ûÈïøÂõæË°®
    async initUserGrowthChart() {
        const canvas = document.getElementById('user-growth-chart');
        if (!canvas) return;
        
        try {
            // Ëé∑ÂèñÁî®Êà∑Â¢ûÈïøÊï∞ÊçÆ
            const { data, error } = await supabase
                .from('user_growth_trend')
                .select('*')
                .order('date');
                
            if (error) throw error;
            
            const ctx = canvas.getContext('2d');
            
            // ÈîÄÊØÅÁé∞ÊúâÂõæË°®
            if (this.charts.userGrowth) {
                this.charts.userGrowth.destroy();
            }
            
            this.charts.userGrowth = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => new Date(item.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Êñ∞Â¢ûÁî®Êà∑',
                        data: data.map(item => item.new_users),
                        borderColor: 'rgb(124, 58, 237)',
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
        } catch (error) {
            console.error('Áî®Êà∑Â¢ûÈïøÂõæË°®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
        }
    }
    
    // ÂàùÂßãÂåñÊèêÁ§∫ËØçÂ¢ûÈïøÂõæË°®
    async initPromptGrowthChart() {
        const canvas = document.getElementById('prompt-growth-chart');
        if (!canvas) return;
        
        try {
            // Ëé∑ÂèñÊèêÁ§∫ËØçÂ¢ûÈïøÊï∞ÊçÆ
            const { data, error } = await supabase
                .from('prompt_growth_trend')
                .select('*')
                .order('date');
                
            if (error) throw error;
            
            const ctx = canvas.getContext('2d');
            
            // ÈîÄÊØÅÁé∞ÊúâÂõæË°®
            if (this.charts.promptGrowth) {
                this.charts.promptGrowth.destroy();
            }
            
            this.charts.promptGrowth = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => new Date(item.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Êñ∞Â¢ûÊèêÁ§∫ËØç',
                        data: data.map(item => item.new_prompts),
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
        } catch (error) {
            console.error('ÊèêÁ§∫ËØçÂ¢ûÈïøÂõæË°®ÂàùÂßãÂåñÂ§±Ë¥•:', error);
        }
    }
    
    // ÂÖ∂‰ªñÈ°µÈù¢ÂàùÂßãÂåñÔºàÂç†‰ΩçÁ¨¶Ôºâ
    initUsersPage() {
        console.log('üë• ÂàùÂßãÂåñÁî®Êà∑ÁÆ°ÁêÜÈ°µÈù¢');
    }
    
    initPromptsPage() {
        console.log('üìù ÂàùÂßãÂåñÊèêÁ§∫ËØçÁÆ°ÁêÜÈ°µÈù¢');
    }
    
    initCategoriesPage() {
        console.log('üè∑Ô∏è ÂàùÂßãÂåñÂàÜÁ±ªÁÆ°ÁêÜÈ°µÈù¢');
    }
    
    initSystemPage() {
        console.log('‚öôÔ∏è ÂàùÂßãÂåñÁ≥ªÁªüÈÖçÁΩÆÈ°µÈù¢');
    }
    
    initLogsPage() {
        console.log('üìã ÂàùÂßãÂåñÊìç‰ΩúÊó•ÂøóÈ°µÈù¢');
    }
    
    // ÂàáÊç¢‰æßËæπÊ†è
    toggleSidebar() {
        const sidebar = document.getElementById('admin-sidebar');
        if (sidebar) {
            this.sidebarCollapsed = !this.sidebarCollapsed;
            
            if (window.innerWidth <= 768) {
                // ÁßªÂä®Á´ØÔºöÊòæÁ§∫/ÈöêËóè‰æßËæπÊ†è
                sidebar.classList.toggle('open');
            } else {
                // Ê°åÈù¢Á´ØÔºöÊäòÂè†/Â±ïÂºÄ‰æßËæπÊ†è
                sidebar.classList.toggle('collapsed');
            }
        }
    }
    
    // ÂàùÂßãÂåñÁßªÂä®Á´Ø‰æßËæπÊ†è
    initMobileSidebar() {
        // ÁÇπÂáª‰∏ªÂÜÖÂÆπÂå∫ÂüüÊó∂ÂÖ≥Èó≠‰æßËæπÊ†è
        const mainContent = document.querySelector('.admin-main');
        if (mainContent) {
            mainContent.addEventListener('click', () => {
                const sidebar = document.getElementById('admin-sidebar');
                if (sidebar && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                }
            });
        }
    }
    
    // Â§ÑÁêÜÁ™óÂè£Â§ßÂ∞èÂèòÂåñ
    handleResize() {
        // ÈáçÊñ∞Ë∞ÉÊï¥ÂõæË°®Â§ßÂ∞è
        Object.values(this.charts).forEach(chart => {
            if (chart && typeof chart.resize === 'function') {
                chart.resize();
            }
        });
    }
    
    // Âà∑Êñ∞Êï∞ÊçÆ
    async refreshData() {
        console.log('üîÑ Âà∑Êñ∞Êï∞ÊçÆ...');
        
        const refreshBtn = document.querySelector('.quick-action-btn[title="Âà∑Êñ∞Êï∞ÊçÆ"]');
        if (refreshBtn) {
            const icon = refreshBtn.querySelector('i');
            if (icon) {
                icon.classList.add('fa-spin');
            }
        }
        
        try {
            if (this.currentPage === 'dashboard') {
                await this.loadDashboardStats();
                this.initCharts();
            }
            
            console.log('‚úÖ Êï∞ÊçÆÂà∑Êñ∞ÂÆåÊàê');
            
        } catch (error) {
            console.error('Êï∞ÊçÆÂà∑Êñ∞Â§±Ë¥•:', error);
        } finally {
            if (refreshBtn) {
                const icon = refreshBtn.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-spin');
                }
            }
        }
    }
    
    // ÂêØÂä®Êï∞ÊçÆËá™Âä®Âà∑Êñ∞
    startDataRefresh() {
        const refreshInterval = getAdminConfig('refresh.dashboardInterval', 30000);
        const autoRefresh = getAdminConfig('refresh.autoRefresh', true);
        
        if (autoRefresh && refreshInterval > 0) {
            this.refreshInterval = setInterval(() => {
                if (this.currentPage === 'dashboard' && document.visibilityState === 'visible') {
                    this.loadDashboardStats();
                }
            }, refreshInterval);
            
            console.log(`‚è∞ ÂêØÂä®Ëá™Âä®Âà∑Êñ∞ÔºåÈó¥Èöî: ${refreshInterval / 1000}Áßí`);
        }
    }
    
    // ÂÅúÊ≠¢Êï∞ÊçÆËá™Âä®Âà∑Êñ∞
    stopDataRefresh() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
            console.log('‚èπÔ∏è ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞');
        }
    }
    
    // Â§ÑÁêÜÁôªÂá∫
    async handleLogout() {
        if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁÆ°ÁêÜÂêéÂè∞ÂêóÔºü')) {
            this.stopDataRefresh();
            
            // ÈîÄÊØÅÂõæË°®
            Object.values(this.charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            this.charts = {};
            
            // ÊâßË°åÁôªÂá∫
            if (window.adminAuth) {
                await window.adminAuth.logout();
            }
        }
    }
    
    // Ëé∑ÂèñÂΩìÂâçÈ°µÈù¢
    getCurrentPage() {
        return this.currentPage;
    }
    
    // ÈîÄÊØÅÂÆû‰æã
    destroy() {
        this.stopDataRefresh();
        
        // ÈîÄÊØÅÂõæË°®
        Object.values(this.charts).forEach(chart => {
            if (chart && typeof chart.destroy === 'function') {
                chart.destroy();
            }
        });
        
        this.initialized = false;
        console.log('üóëÔ∏è ÁÆ°ÁêÜÂêéÂè∞‰∏ªÂ∫îÁî®Â∑≤ÈîÄÊØÅ');
    }
}

// ÂàõÂª∫ÂÖ®Â±ÄÁÆ°ÁêÜÂêéÂè∞‰∏ªÂ∫îÁî®ÂÆû‰æã
if (!window.adminMain) {
    window.adminMain = new AdminMain();
}

// ÂØºÂá∫
if (typeof module !== 'undefined' && module.exports) {
    module.exports = AdminMain;
}
