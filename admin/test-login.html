<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå°ç™»å½•æµ‹è¯•</title>
    
    <!-- ç®¡ç†åå°æ ·å¼ -->
    <link rel="stylesheet" href="css/admin-login.css">
    
    <!-- Font Awesome å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase å®¢æˆ·ç«¯ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .test-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 0.875rem;
            max-width: 300px;
            z-index: 10000;
        }
        
        .status {
            margin: 0.25rem 0;
        }
        
        .status.success { color: #10b981; }
        .status.error { color: #ef4444; }
        .status.warning { color: #f59e0b; }
    </style>
</head>
<body>
    <!-- æµ‹è¯•ä¿¡æ¯é¢æ¿ -->
    <div class="test-info">
        <h4>åŠ è½½çŠ¶æ€</h4>
        <div id="supabase-status" class="status">Supabase: åŠ è½½ä¸­...</div>
        <div id="config-status" class="status">é…ç½®: ç­‰å¾…ä¸­...</div>
        <div id="auth-status" class="status">è®¤è¯: ç­‰å¾…ä¸­...</div>
    </div>
    
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="admin-login-form" class="admin-login-overlay">
        <div class="admin-login-container">
            <div class="admin-login-header">
                <h1>ç®¡ç†åå°ç™»å½•</h1>
                <p>è¯·ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½•</p>
            </div>
            
            <form id="admin-login-form-element" class="admin-login-form">
                <div class="form-group">
                    <label for="admin-email">é‚®ç®±åœ°å€</label>
                    <input type="email" id="admin-email" name="email" required 
                           placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜é‚®ç®±" value="chtx365@163.com">
                </div>
                
                <div class="form-group">
                    <label for="admin-password">å¯†ç </label>
                    <input type="password" id="admin-password" name="password" required 
                           placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                
                <div id="admin-login-error" class="error-message" style="display: none;"></div>
                
                <button type="submit" id="admin-login-btn" class="admin-login-btn">
                    <span class="btn-text">ç™»å½•</span>
                    <span class="btn-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> éªŒè¯ä¸­...
                    </span>
                </button>
            </form>
            
            <div class="admin-login-footer">
                <p>ä»…é™ç³»ç»Ÿç®¡ç†å‘˜è®¿é—®</p>
            </div>
        </div>
    </div>
    
    <script>
        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateStatus(elementId, message, type = 'warning') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `status ${type}`;
            }
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('admin-login-error');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }
        
        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            const errorDiv = document.getElementById('admin-login-error');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }
        
        // è®¾ç½®ç™»å½•åŠ è½½çŠ¶æ€
        function setLoginLoading(loading) {
            const btn = document.getElementById('admin-login-btn');
            const btnText = btn?.querySelector('.btn-text');
            const btnLoading = btn?.querySelector('.btn-loading');
            
            if (btn && btnText && btnLoading) {
                btn.disabled = loading;
                btnText.style.display = loading ? 'none' : 'inline';
                btnLoading.style.display = loading ? 'inline' : 'none';
            }
        }
        
        // åˆå§‹åŒ–
        let supabase;
        let configLoaded = false;
        
        // æ£€æŸ¥ Supabase åŠ è½½
        function checkSupabase() {
            if (typeof window.supabase !== 'undefined') {
                updateStatus('supabase-status', 'Supabase: âœ… å·²åŠ è½½', 'success');
                loadConfig();
                return true;
            } else {
                updateStatus('supabase-status', 'Supabase: âŒ åŠ è½½å¤±è´¥', 'error');
                return false;
            }
        }
        
        // åŠ è½½é…ç½®
        function loadConfig() {
            updateStatus('config-status', 'é…ç½®: åŠ è½½ä¸­...', 'warning');
            
            // Supabase é…ç½®
            const SUPABASE_CONFIG = {
                url: 'https://qnqzoxkejxshsxvmprhs.supabase.co',
                anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFucXpveGtlanhzaHN4dm1wcmhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMDQ0NzMsImV4cCI6MjA2NDU4MDQ3M30.ZPBSdEAz-ncPOfAEwwYEJyd3cpF05U-hIQKyOZKCMaw'
            };
            
            try {
                // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
                supabase = window.supabase.createClient(
                    SUPABASE_CONFIG.url,
                    SUPABASE_CONFIG.anonKey
                );
                
                updateStatus('config-status', 'é…ç½®: âœ… å·²åŠ è½½', 'success');
                configLoaded = true;
                initAuth();
                
            } catch (error) {
                updateStatus('config-status', 'é…ç½®: âŒ åŠ è½½å¤±è´¥', 'error');
                console.error('é…ç½®åŠ è½½å¤±è´¥:', error);
            }
        }
        
        // åˆå§‹åŒ–è®¤è¯
        function initAuth() {
            updateStatus('auth-status', 'è®¤è¯: âœ… å·²åˆå§‹åŒ–', 'success');
            
            // ç»‘å®šç™»å½•è¡¨å•äº‹ä»¶
            const form = document.getElementById('admin-login-form-element');
            if (form) {
                form.addEventListener('submit', handleLogin);
            }
        }
        
        // å¤„ç†ç™»å½•
        async function handleLogin(e) {
            e.preventDefault();
            
            if (!configLoaded) {
                showError('ç³»ç»Ÿå°šæœªåˆå§‹åŒ–å®Œæˆï¼Œè¯·ç¨åé‡è¯•');
                return;
            }
            
            const email = document.getElementById('admin-email').value.trim();
            const password = document.getElementById('admin-password').value;
            
            if (!email || !password) {
                showError('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');
                return;
            }
            
            setLoginLoading(true);
            hideError();
            
            try {
                console.log('ğŸ” å¼€å§‹ç™»å½•æµç¨‹...');
                console.log('ğŸ“§ é‚®ç®±:', email);

                // 1. Supabase èº«ä»½éªŒè¯
                console.log('1ï¸âƒ£ å¼€å§‹ Supabase èº«ä»½éªŒè¯...');
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                console.log('ğŸ” èº«ä»½éªŒè¯ç»“æœ:', { authData, authError });

                if (authError) {
                    console.error('âŒ èº«ä»½éªŒè¯å¤±è´¥:', authError);
                    throw new Error(authError.message);
                }

                console.log('âœ… èº«ä»½éªŒè¯æˆåŠŸ');
                console.log('ğŸ‘¤ ç”¨æˆ·ID:', authData.user.id);
                console.log('ğŸ“§ ç”¨æˆ·é‚®ç®±:', authData.user.email);

                // 2. è§’è‰²éªŒè¯ - å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
                console.log('2ï¸âƒ£ å¼€å§‹æŸ¥è¯¢ç”¨æˆ·è§’è‰²...');
                console.log('ğŸ” æŸ¥è¯¢æ¡ä»¶ user_id =', authData.user.id);
                console.log('ğŸ” ç”¨æˆ·IDç±»å‹:', typeof authData.user.id);
                console.log('ğŸ” ç”¨æˆ·IDé•¿åº¦:', authData.user.id.length);

                // å°è¯•å¤šç§æŸ¥è¯¢æ–¹å¼
                console.log('ğŸ” å°è¯•æ–¹å¼1: ç›´æ¥æŸ¥è¯¢...');
                let { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('role, username, status, id')
                    .eq('user_id', authData.user.id);

                console.log('ğŸ” æ–¹å¼1ç»“æœ:', { userData, userError });

                // å¦‚æœç¬¬ä¸€ç§æ–¹å¼å¤±è´¥ï¼Œå°è¯•å­—ç¬¦ä¸²è½¬æ¢
                if (!userData || userData.length === 0) {
                    console.log('ğŸ” å°è¯•æ–¹å¼2: å­—ç¬¦ä¸²è½¬æ¢...');
                    const userIdString = String(authData.user.id);
                    const result2 = await supabase
                        .from('users')
                        .select('role, username, status, id')
                        .eq('user_id', userIdString);

                    console.log('ğŸ” æ–¹å¼2ç»“æœ:', result2);
                    userData = result2.data;
                    userError = result2.error;
                }

                // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œå°è¯•åŸå§‹SQLæŸ¥è¯¢
                if (!userData || userData.length === 0) {
                    console.log('ğŸ” å°è¯•æ–¹å¼3: RPCæŸ¥è¯¢...');
                    const result3 = await supabase.rpc('get_user_by_id', {
                        target_user_id: authData.user.id
                    });

                    console.log('ğŸ” æ–¹å¼3ç»“æœ:', result3);

                    // å¦‚æœRPCä¹Ÿå¤±è´¥ï¼Œæ‰‹åŠ¨æ„é€ æŸ¥è¯¢
                    if (!result3.data || result3.data.length === 0) {
                        console.log('ğŸ” å°è¯•æ–¹å¼4: æ‰‹åŠ¨SQLæŸ¥è¯¢...');
                        const result4 = await supabase
                            .from('users')
                            .select('role, username, status, id, user_id')
                            .filter('user_id', 'eq', authData.user.id);

                        console.log('ğŸ” æ–¹å¼4ç»“æœ:', result4);
                        userData = result4.data;
                        userError = result4.error;
                    } else {
                        userData = result3.data;
                        userError = result3.error;
                    }
                }

                console.log('ğŸ” ç”¨æˆ·æŸ¥è¯¢ç»“æœ:', { userData, userError });
                console.log('ğŸ“Š æŸ¥è¯¢è¿”å›æ•°æ®ç±»å‹:', typeof userData);
                console.log('ğŸ“Š æŸ¥è¯¢è¿”å›æ•°æ®é•¿åº¦:', userData ? userData.length : 'null');

                if (userError) {
                    console.error('âŒ æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', userError);
                    throw new Error('æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + userError.message);
                }

                if (!userData || userData.length === 0) {
                    console.error('âŒ ç”¨æˆ·åœ¨ public.users è¡¨ä¸­ä¸å­˜åœ¨');
                    console.log('ğŸ” å°è¯•ç›´æ¥æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·è®°å½•...');

                    // è°ƒè¯•ï¼šæŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·è®°å½•
                    const { data: allUsers, error: allUsersError } = await supabase
                        .from('users')
                        .select('user_id, username, role')
                        .limit(10);

                    console.log('ğŸ“‹ æ‰€æœ‰ç”¨æˆ·è®°å½•æ ·æœ¬:', { allUsers, allUsersError });

                    throw new Error('ç”¨æˆ·åœ¨ public.users è¡¨ä¸­ä¸å­˜åœ¨ï¼Œè¯·è¿è¡Œç”¨æˆ·åŒæ­¥è„šæœ¬');
                }

                if (userData.length > 1) {
                    console.error('âŒ ç”¨æˆ·åœ¨ public.users è¡¨ä¸­æœ‰é‡å¤è®°å½•:', userData);
                    throw new Error('ç”¨æˆ·åœ¨ public.users è¡¨ä¸­æœ‰é‡å¤è®°å½•ï¼Œè¯·æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§');
                }

                const userInfo = userData[0];
                console.log('âœ… æ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯:', userInfo);

                if (userInfo.role !== 'admin') {
                    console.error('âŒ ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜:', userInfo.role);
                    // ç™»å‡ºéç®¡ç†å‘˜ç”¨æˆ·
                    await supabase.auth.signOut();
                    throw new Error('æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™');
                }

                console.log('ğŸ‰ ç®¡ç†å‘˜æƒé™éªŒè¯é€šè¿‡');

                // ç™»å½•æˆåŠŸ
                alert(`ç™»å½•æˆåŠŸï¼æ¬¢è¿ ${userInfo.username || email}`);

                // è·³è½¬åˆ°å®Œæ•´çš„ç®¡ç†åå°
                window.location.href = 'index.html';

            } catch (error) {
                console.error('ğŸ’¥ ç™»å½•è¿‡ç¨‹å‡ºé”™:', error);
                console.error('ğŸ“‹ é”™è¯¯è¯¦æƒ…:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                showError(error.message);
            } finally {
                setLoginLoading(false);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æ£€æŸ¥
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (!checkSupabase()) {
                    // å¦‚æœ Supabase æ²¡æœ‰åŠ è½½ï¼Œç»§ç»­ç­‰å¾…
                    setTimeout(checkSupabase, 1000);
                }
            }, 100);
        });
    </script>
</body>
</html>
