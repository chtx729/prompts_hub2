<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚¹èµè®¡æ•°å‡†ç¡®æ€§æµ‹è¯•</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--background-color);
        }
        .test-container {
            background: var(--surface-color);
            padding: 2rem;
            border-radius: var(--radius-xl);
            margin-bottom: 2rem;
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
        }
        .test-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: 0.5rem;
        }
        .test-button:hover {
            background: var(--primary-hover);
        }
        .status-info {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
        }
        .log-output {
            background: var(--gray-900);
            color: var(--gray-100);
            padding: 1rem;
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 1rem 0;
        }
        .count-display {
            background: var(--info-50);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            border: 1px solid var(--info-200);
        }
        .count-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--info-100);
        }
        .count-item:last-child {
            border-bottom: none;
        }
        .count-value {
            font-weight: bold;
            color: var(--info-700);
        }
        .error-highlight {
            background: var(--error-50);
            color: var(--error-700);
            padding: 0.5rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--error-200);
        }
        .success-highlight {
            background: var(--success-50);
            color: var(--success-700);
            padding: 0.5rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--success-200);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/api.js"></script>
    <script src="js/prompts.js"></script>
    <script src="js/myspace.js"></script>
    <script src="js/main.js"></script>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ“Š ç‚¹èµè®¡æ•°å‡†ç¡®æ€§æµ‹è¯•</h1>
        <p>éªŒè¯user_likesè¡¨è®°å½•ä¸promptsè¡¨like_countå­—æ®µçš„ä¸€è‡´æ€§</p>
    </div>

    <div class="test-container">
        <div class="test-section">
            <h3>æµ‹è¯•æç¤ºè¯é€‰æ‹©</h3>
            <label for="test-prompt-id">æµ‹è¯•æç¤ºè¯ID:</label>
            <input type="number" id="test-prompt-id" value="1" min="1" style="margin: 0 1rem; padding: 0.5rem;">
            <button class="test-button" onclick="selectPrompt()">é€‰æ‹©æç¤ºè¯</button>
            <button class="test-button" onclick="getRandomPrompt()">éšæœºé€‰æ‹©</button>
        </div>

        <div class="test-section">
            <h3>å½“å‰è®¡æ•°çŠ¶æ€</h3>
            <div id="count-display" class="count-display">
                <div class="count-item">
                    <span>æç¤ºè¯ID:</span>
                    <span class="count-value" id="current-prompt-id">-</span>
                </div>
                <div class="count-item">
                    <span>user_likesè¡¨è®°å½•æ•°:</span>
                    <span class="count-value" id="user-likes-count">-</span>
                </div>
                <div class="count-item">
                    <span>promptsè¡¨like_count:</span>
                    <span class="count-value" id="prompts-like-count">-</span>
                </div>
                <div class="count-item">
                    <span>æ•°æ®ä¸€è‡´æ€§:</span>
                    <span class="count-value" id="consistency-status">-</span>
                </div>
            </div>
            <button class="test-button" onclick="checkCurrentCounts()">åˆ·æ–°è®¡æ•°</button>
        </div>

        <div class="test-section">
            <h3>ç‚¹èµæ“ä½œæµ‹è¯•</h3>
            <button class="test-button" onclick="testSingleLike()">å•æ¬¡ç‚¹èµæµ‹è¯•</button>
            <button class="test-button" onclick="testToggleLike()">ç‚¹èµåˆ‡æ¢æµ‹è¯•</button>
            <button class="test-button" onclick="testMultipleLikes()">å¤šæ¬¡ç‚¹èµæµ‹è¯•</button>
            <button class="test-button" onclick="resetLikeCount()">é‡ç½®è®¡æ•°</button>
        </div>

        <div class="test-section">
            <h3>æ•°æ®åº“ç›´æ¥æŸ¥è¯¢</h3>
            <button class="test-button" onclick="queryUserLikes()">æŸ¥è¯¢user_likesè¡¨</button>
            <button class="test-button" onclick="queryPromptsTable()">æŸ¥è¯¢promptsè¡¨</button>
            <button class="test-button" onclick="compareAllPrompts()">æ¯”è¾ƒæ‰€æœ‰æç¤ºè¯</button>
        </div>

        <div class="test-section">
            <h3>ä¿®å¤å·¥å…·</h3>
            <button class="test-button" onclick="fixInconsistentCounts()">ä¿®å¤ä¸ä¸€è‡´çš„è®¡æ•°</button>
            <button class="test-button" onclick="recalculateAllCounts()">é‡æ–°è®¡ç®—æ‰€æœ‰è®¡æ•°</button>
        </div>

        <div class="test-section">
            <h3>æ“ä½œæ—¥å¿—</h3>
            <button class="test-button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="operation-log" class="log-output">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script>
        let logElement;
        let currentPromptId = 1;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (logElement) {
                logElement.textContent += logMessage;
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(logMessage);
        }

        function selectPrompt() {
            const input = document.getElementById('test-prompt-id');
            currentPromptId = parseInt(input.value) || 1;
            document.getElementById('current-prompt-id').textContent = currentPromptId;
            log(`é€‰æ‹©æµ‹è¯•æç¤ºè¯ID: ${currentPromptId}`);
            checkCurrentCounts();
        }

        async function getRandomPrompt() {
            try {
                const { data, error } = await supabase
                    .from('prompts')
                    .select('prompt_id')
                    .limit(10);

                if (error) throw error;

                if (data && data.length > 0) {
                    const randomPrompt = data[Math.floor(Math.random() * data.length)];
                    currentPromptId = randomPrompt.prompt_id;
                    document.getElementById('test-prompt-id').value = currentPromptId;
                    document.getElementById('current-prompt-id').textContent = currentPromptId;
                    log(`éšæœºé€‰æ‹©æç¤ºè¯ID: ${currentPromptId}`);
                    checkCurrentCounts();
                } else {
                    log('âŒ æ²¡æœ‰æ‰¾åˆ°æç¤ºè¯æ•°æ®');
                }
            } catch (error) {
                log(`âŒ è·å–éšæœºæç¤ºè¯å¤±è´¥: ${error.message}`);
            }
        }

        async function checkCurrentCounts() {
            log('=== æ£€æŸ¥å½“å‰è®¡æ•°çŠ¶æ€ ===');
            
            try {
                // æŸ¥è¯¢user_likesè¡¨è®°å½•æ•°
                const { data: likesData, error: likesError } = await supabase
                    .from('user_likes')
                    .select('like_id', { count: 'exact' })
                    .eq('prompt_id', currentPromptId);

                if (likesError) throw likesError;

                const userLikesCount = likesData ? likesData.length : 0;
                document.getElementById('user-likes-count').textContent = userLikesCount;

                // æŸ¥è¯¢promptsè¡¨like_count
                const { data: promptData, error: promptError } = await supabase
                    .from('prompts')
                    .select('like_count')
                    .eq('prompt_id', currentPromptId)
                    .single();

                if (promptError) throw promptError;

                const promptsLikeCount = promptData ? (promptData.like_count || 0) : 0;
                document.getElementById('prompts-like-count').textContent = promptsLikeCount;

                // æ£€æŸ¥ä¸€è‡´æ€§
                const isConsistent = userLikesCount === promptsLikeCount;
                const statusElement = document.getElementById('consistency-status');
                
                if (isConsistent) {
                    statusElement.textContent = 'âœ… ä¸€è‡´';
                    statusElement.className = 'count-value success-highlight';
                    log(`âœ… æ•°æ®ä¸€è‡´: user_likes=${userLikesCount}, like_count=${promptsLikeCount}`);
                } else {
                    statusElement.textContent = 'âŒ ä¸ä¸€è‡´';
                    statusElement.className = 'count-value error-highlight';
                    log(`âŒ æ•°æ®ä¸ä¸€è‡´: user_likes=${userLikesCount}, like_count=${promptsLikeCount}`);
                }

            } catch (error) {
                log(`âŒ æ£€æŸ¥è®¡æ•°å¤±è´¥: ${error.message}`);
            }
        }

        async function testSingleLike() {
            log('=== å•æ¬¡ç‚¹èµæµ‹è¯• ===');
            
            try {
                // è®°å½•æ“ä½œå‰çš„çŠ¶æ€
                await checkCurrentCounts();
                const beforeUserLikes = parseInt(document.getElementById('user-likes-count').textContent);
                const beforePromptsCount = parseInt(document.getElementById('prompts-like-count').textContent);

                // æ‰§è¡Œç‚¹èµæ“ä½œ
                const result = await apiManager.toggleLike(currentPromptId);
                log(`ç‚¹èµæ“ä½œç»“æœ: ${JSON.stringify(result)}`);

                // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿æ•°æ®åº“æ›´æ–°å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 1000));

                // æ£€æŸ¥æ“ä½œåçš„çŠ¶æ€
                await checkCurrentCounts();
                const afterUserLikes = parseInt(document.getElementById('user-likes-count').textContent);
                const afterPromptsCount = parseInt(document.getElementById('prompts-like-count').textContent);

                // éªŒè¯å˜åŒ–
                const userLikesChange = afterUserLikes - beforeUserLikes;
                const promptsCountChange = afterPromptsCount - beforePromptsCount;

                log(`user_likeså˜åŒ–: ${beforeUserLikes} -> ${afterUserLikes} (${userLikesChange > 0 ? '+' : ''}${userLikesChange})`);
                log(`like_countå˜åŒ–: ${beforePromptsCount} -> ${afterPromptsCount} (${promptsCountChange > 0 ? '+' : ''}${promptsCountChange})`);

                if (userLikesChange === promptsCountChange) {
                    log('âœ… è®¡æ•°å˜åŒ–ä¸€è‡´');
                } else {
                    log('âŒ è®¡æ•°å˜åŒ–ä¸ä¸€è‡´');
                }

            } catch (error) {
                log(`âŒ å•æ¬¡ç‚¹èµæµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function testToggleLike() {
            log('=== ç‚¹èµåˆ‡æ¢æµ‹è¯• ===');
            
            for (let i = 0; i < 3; i++) {
                log(`ç¬¬${i + 1}æ¬¡åˆ‡æ¢:`);
                await testSingleLike();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        async function testMultipleLikes() {
            log('=== å¤šæ¬¡ç‚¹èµæµ‹è¯• ===');
            
            const testIds = [currentPromptId, currentPromptId + 1, currentPromptId + 2];
            
            for (const id of testIds) {
                log(`æµ‹è¯•æç¤ºè¯${id}:`);
                const originalId = currentPromptId;
                currentPromptId = id;
                document.getElementById('current-prompt-id').textContent = currentPromptId;
                
                await testSingleLike();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                currentPromptId = originalId;
                document.getElementById('current-prompt-id').textContent = currentPromptId;
            }
        }

        async function queryUserLikes() {
            log('=== æŸ¥è¯¢user_likesè¡¨ ===');
            
            try {
                const { data, error } = await supabase
                    .from('user_likes')
                    .select('*')
                    .eq('prompt_id', currentPromptId);

                if (error) throw error;

                log(`user_likesè¡¨è®°å½• (prompt_id=${currentPromptId}):`);
                if (data && data.length > 0) {
                    data.forEach((record, index) => {
                        log(`  ${index + 1}. like_id: ${record.like_id}, user_id: ${record.user_id}`);
                    });
                } else {
                    log('  æ— è®°å½•');
                }

            } catch (error) {
                log(`âŒ æŸ¥è¯¢user_likesè¡¨å¤±è´¥: ${error.message}`);
            }
        }

        async function queryPromptsTable() {
            log('=== æŸ¥è¯¢promptsè¡¨ ===');
            
            try {
                const { data, error } = await supabase
                    .from('prompts')
                    .select('prompt_id, title, like_count')
                    .eq('prompt_id', currentPromptId)
                    .single();

                if (error) throw error;

                log(`promptsè¡¨è®°å½• (prompt_id=${currentPromptId}):`);
                log(`  æ ‡é¢˜: ${data.title}`);
                log(`  like_count: ${data.like_count || 0}`);

            } catch (error) {
                log(`âŒ æŸ¥è¯¢promptsè¡¨å¤±è´¥: ${error.message}`);
            }
        }

        async function compareAllPrompts() {
            log('=== æ¯”è¾ƒæ‰€æœ‰æç¤ºè¯çš„è®¡æ•°ä¸€è‡´æ€§ ===');
            
            try {
                // è·å–æ‰€æœ‰æœ‰ç‚¹èµè®°å½•çš„æç¤ºè¯
                const { data: promptsWithLikes, error } = await supabase
                    .from('user_likes')
                    .select('prompt_id')
                    .limit(20);

                if (error) throw error;

                const uniquePromptIds = [...new Set(promptsWithLikes.map(item => item.prompt_id))];
                log(`æ£€æŸ¥${uniquePromptIds.length}ä¸ªæœ‰ç‚¹èµè®°å½•çš„æç¤ºè¯...`);

                for (const promptId of uniquePromptIds) {
                    // æŸ¥è¯¢user_likesè®¡æ•°
                    const { data: likesData } = await supabase
                        .from('user_likes')
                        .select('like_id', { count: 'exact' })
                        .eq('prompt_id', promptId);

                    // æŸ¥è¯¢promptsè¡¨è®¡æ•°
                    const { data: promptData } = await supabase
                        .from('prompts')
                        .select('like_count')
                        .eq('prompt_id', promptId)
                        .single();

                    const userLikesCount = likesData ? likesData.length : 0;
                    const promptsLikeCount = promptData ? (promptData.like_count || 0) : 0;

                    if (userLikesCount !== promptsLikeCount) {
                        log(`âŒ æç¤ºè¯${promptId}: user_likes=${userLikesCount}, like_count=${promptsLikeCount}`);
                    } else {
                        log(`âœ… æç¤ºè¯${promptId}: è®¡æ•°ä¸€è‡´ (${userLikesCount})`);
                    }
                }

            } catch (error) {
                log(`âŒ æ¯”è¾ƒæ‰€æœ‰æç¤ºè¯å¤±è´¥: ${error.message}`);
            }
        }

        async function resetLikeCount() {
            log('=== é‡ç½®è®¡æ•° ===');
            
            try {
                // åˆ é™¤å½“å‰æç¤ºè¯çš„æ‰€æœ‰ç‚¹èµè®°å½•
                const { error: deleteError } = await supabase
                    .from('user_likes')
                    .delete()
                    .eq('prompt_id', currentPromptId);

                if (deleteError) throw deleteError;

                // é‡ç½®promptsè¡¨çš„è®¡æ•°
                const { error: updateError } = await supabase
                    .from('prompts')
                    .update({ like_count: 0 })
                    .eq('prompt_id', currentPromptId);

                if (updateError) throw updateError;

                log(`âœ… æç¤ºè¯${currentPromptId}çš„è®¡æ•°å·²é‡ç½®`);
                await checkCurrentCounts();

            } catch (error) {
                log(`âŒ é‡ç½®è®¡æ•°å¤±è´¥: ${error.message}`);
            }
        }

        async function fixInconsistentCounts() {
            log('=== ä¿®å¤ä¸ä¸€è‡´çš„è®¡æ•° ===');
            
            try {
                // æŸ¥è¯¢å®é™…çš„ç‚¹èµè®°å½•æ•°
                const { data: likesData, error: likesError } = await supabase
                    .from('user_likes')
                    .select('like_id', { count: 'exact' })
                    .eq('prompt_id', currentPromptId);

                if (likesError) throw likesError;

                const actualCount = likesData ? likesData.length : 0;

                // æ›´æ–°promptsè¡¨çš„è®¡æ•°
                const { error: updateError } = await supabase
                    .from('prompts')
                    .update({ like_count: actualCount })
                    .eq('prompt_id', currentPromptId);

                if (updateError) throw updateError;

                log(`âœ… æç¤ºè¯${currentPromptId}çš„è®¡æ•°å·²ä¿®å¤ä¸º${actualCount}`);
                await checkCurrentCounts();

            } catch (error) {
                log(`âŒ ä¿®å¤è®¡æ•°å¤±è´¥: ${error.message}`);
            }
        }

        async function recalculateAllCounts() {
            log('=== é‡æ–°è®¡ç®—æ‰€æœ‰è®¡æ•° ===');
            
            try {
                // è¿™éœ€è¦åœ¨æ•°æ®åº“ä¸­è¿è¡ŒSQLè„šæœ¬
                log('è¯·åœ¨Supabase SQLç¼–è¾‘å™¨ä¸­è¿è¡Œä»¥ä¸‹è„šæœ¬:');
                log(`
UPDATE prompts 
SET like_count = (
    SELECT COUNT(*) 
    FROM user_likes 
    WHERE user_likes.prompt_id = prompts.prompt_id
);
                `);

            } catch (error) {
                log(`âŒ é‡æ–°è®¡ç®—å¤±è´¥: ${error.message}`);
            }
        }

        function clearLog() {
            if (logElement) {
                logElement.textContent = '';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ç‚¹èµè®¡æ•°å‡†ç¡®æ€§æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            logElement = document.getElementById('operation-log');
            
            setTimeout(() => {
                log('æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
                selectPrompt();
            }, 1000);
        });
    </script>
</body>
</html>
