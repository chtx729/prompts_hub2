<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç©ºé—´æç¤ºè¯æ•°é‡ä¿®å¤æµ‹è¯•</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--background-color);
        }
        .test-container {
            background: var(--surface-color);
            padding: 2rem;
            border-radius: var(--radius-xl);
            margin-bottom: 2rem;
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
        }
        .test-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: 0.5rem;
        }
        .test-button:hover {
            background: var(--primary-hover);
        }
        .status-display {
            background: var(--info-50);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            border: 1px solid var(--info-200);
            font-family: monospace;
        }
        .log-output {
            background: var(--gray-900);
            color: var(--gray-100);
            padding: 1rem;
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 1rem 0;
        }
        .success {
            color: var(--success-600);
            font-weight: bold;
        }
        .error {
            color: var(--error-600);
            font-weight: bold;
        }
        .warning {
            color: var(--warning-600);
            font-weight: bold;
        }
        .test-scenario {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
        }
        .mock-count-display {
            background: white;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin: 1rem 0;
            font-size: 1.1rem;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/api.js"></script>
    <script src="js/myspace.js"></script>
    <script src="js/main.js"></script>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ æˆ‘çš„ç©ºé—´æç¤ºè¯æ•°é‡ä¿®å¤æµ‹è¯•</h1>
        <p>éªŒè¯æœ€å°åŒ–æˆ–åˆ‡æ¢é¡µé¢åè¿”å›æ—¶ï¼Œæç¤ºè¯æ•°é‡æ˜¾ç¤ºæ˜¯å¦æ­£å¸¸</p>
    </div>

    <div class="test-container">
        <div class="test-section">
            <h3>é—®é¢˜æè¿°</h3>
            <div class="test-scenario">
                <h4>åŸé—®é¢˜ï¼š</h4>
                <p>ç™»å½•åï¼Œæˆ‘çš„ç©ºé—´æç¤ºè¯æ•°é‡æ˜¾ç¤ºæ­£å¸¸ï¼Œä½†æœ€å°åŒ–æˆ–è€…ä»åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢å†è¿”å›æ—¶ï¼Œæç¤ºè¯æ•°é‡å´ä¸€ç›´æ˜¾ç¤º"åŠ è½½ä¸­"ã€‚</p>
                
                <h4>ä¿®å¤æ–¹æ¡ˆï¼š</h4>
                <p>1. âœ… åœ¨é¡µé¢æ¢å¤æ˜¾ç¤ºæ—¶åˆ·æ–°æˆ‘çš„ç©ºé—´æ•°æ®</p>
                <p>2. âœ… æ·»åŠ ä¸“é—¨çš„æç¤ºè¯æ•°é‡åˆ·æ–°æ–¹æ³•</p>
                <p>3. âœ… æ£€æŸ¥æ•°é‡æ˜¾ç¤ºçŠ¶æ€ï¼Œéœ€è¦æ—¶é‡æ–°åŠ è½½</p>
                
                <h4>é¢„æœŸæ•ˆæœï¼š</h4>
                <p>é¡µé¢æ¢å¤æ—¶æç¤ºè¯æ•°é‡èƒ½æ­£ç¡®æ˜¾ç¤ºï¼Œä¸ä¼šä¸€ç›´æ˜¾ç¤º"åŠ è½½ä¸­"</p>
            </div>
        </div>

        <div class="test-section">
            <h3>æ¨¡æ‹Ÿæç¤ºè¯æ•°é‡æ˜¾ç¤º</h3>
            <div id="mock-count-display" class="mock-count-display">
                æˆ‘åˆ›å»ºçš„æç¤ºè¯æ•°é‡ï¼šæ£€æŸ¥ä¸­...
            </div>
            <button class="test-button" onclick="simulateLogin()">æ¨¡æ‹Ÿç™»å½•</button>
            <button class="test-button" onclick="simulateLogout()">æ¨¡æ‹Ÿç™»å‡º</button>
            <button class="test-button" onclick="checkCountDisplay()">æ£€æŸ¥æ•°é‡æ˜¾ç¤º</button>
        </div>

        <div class="test-section">
            <h3>MySpaceManageræµ‹è¯•</h3>
            <button class="test-button" onclick="testMySpaceManager()">æµ‹è¯•MySpaceManager</button>
            <button class="test-button" onclick="testRefreshPromptCount()">æµ‹è¯•åˆ·æ–°æç¤ºè¯æ•°é‡</button>
            <button class="test-button" onclick="testLoadMyPromptsIfNeeded()">æµ‹è¯•æ¡ä»¶åŠ è½½</button>
        </div>

        <div class="test-section">
            <h3>é¡µé¢å¯è§æ€§æµ‹è¯•</h3>
            <button class="test-button" onclick="simulatePageHidden()">æ¨¡æ‹Ÿé¡µé¢éšè—</button>
            <button class="test-button" onclick="simulatePageVisible()">æ¨¡æ‹Ÿé¡µé¢æ¢å¤</button>
            <button class="test-button" onclick="testVisibilityChange()">æµ‹è¯•å®Œæ•´çš„éšè—-æ¢å¤æµç¨‹</button>
        </div>

        <div class="test-section">
            <h3>å®é™…æµ‹è¯•åœºæ™¯</h3>
            <div class="test-scenario">
                <h4>æµ‹è¯•æ­¥éª¤ï¼š</h4>
                <ol>
                    <li>æ¨¡æ‹Ÿç™»å½•çŠ¶æ€</li>
                    <li>æ£€æŸ¥æç¤ºè¯æ•°é‡æ˜¾ç¤ºæ­£å¸¸</li>
                    <li>æœ€å°åŒ–çª—å£æˆ–åˆ‡æ¢æ ‡ç­¾é¡µ</li>
                    <li>è¿”å›å½“å‰é¡µé¢</li>
                    <li>éªŒè¯æç¤ºè¯æ•°é‡æ˜¯å¦ä»ç„¶æ­£å¸¸æ˜¾ç¤º</li>
                </ol>
            </div>
            <button class="test-button" onclick="prepareRealTest()">å‡†å¤‡å®é™…æµ‹è¯•</button>
            <button class="test-button" onclick="goToMySpace()">å‰å¾€æˆ‘çš„ç©ºé—´é¡µé¢</button>
        </div>

        <div class="test-section">
            <h3>æ“ä½œæ—¥å¿—</h3>
            <button class="test-button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="operation-log" class="log-output">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script>
        let logElement;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (logElement) {
                logElement.innerHTML += `<span class="${className}">${logMessage}</span>`;
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(logMessage);
        }

        function simulateLogin() {
            log('=== æ¨¡æ‹Ÿç™»å½• ===');
            
            try {
                if (typeof authManager !== 'undefined') {
                    const mockUser = {
                        id: 'test-user-id',
                        email: 'test@example.com',
                        username: 'testuser'
                    };

                    authManager.currentUser = mockUser;
                    
                    log('âœ… æ¨¡æ‹Ÿç™»å½•æˆåŠŸ', 'success');
                    updateMockCountDisplay('æˆ‘åˆ›å»ºçš„æç¤ºè¯æ•°é‡ï¼š5');
                    
                } else {
                    log('âŒ è®¤è¯ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }
            } catch (error) {
                log(`âŒ æ¨¡æ‹Ÿç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function simulateLogout() {
            log('=== æ¨¡æ‹Ÿç™»å‡º ===');
            
            try {
                if (typeof authManager !== 'undefined') {
                    authManager.currentUser = null;
                    log('âœ… æ¨¡æ‹Ÿç™»å‡ºæˆåŠŸ', 'success');
                    updateMockCountDisplay('æˆ‘åˆ›å»ºçš„æç¤ºè¯æ•°é‡ï¼šè¯·å…ˆç™»å½•');
                } else {
                    log('âŒ è®¤è¯ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }
            } catch (error) {
                log(`âŒ æ¨¡æ‹Ÿç™»å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function updateMockCountDisplay(text) {
            const mockDisplay = document.getElementById('mock-count-display');
            if (mockDisplay) {
                mockDisplay.textContent = text;
            }
        }

        function checkCountDisplay() {
            log('=== æ£€æŸ¥æ•°é‡æ˜¾ç¤º ===');
            
            try {
                const mockDisplay = document.getElementById('mock-count-display');
                if (mockDisplay) {
                    const text = mockDisplay.textContent;
                    log(`å½“å‰æ˜¾ç¤º: ${text}`);
                    
                    if (text.includes('åŠ è½½ä¸­')) {
                        log('âš ï¸ å‘ç°"åŠ è½½ä¸­"çŠ¶æ€', 'warning');
                    } else if (text.includes('è¯·å…ˆç™»å½•')) {
                        log('â„¹ï¸ æ˜¾ç¤ºæœªç™»å½•çŠ¶æ€');
                    } else if (text.match(/\d+/)) {
                        log('âœ… æ˜¾ç¤ºæ­£å¸¸æ•°é‡', 'success');
                    } else {
                        log('â“ æœªçŸ¥æ˜¾ç¤ºçŠ¶æ€', 'warning');
                    }
                }
            } catch (error) {
                log(`âŒ æ£€æŸ¥æ˜¾ç¤ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testMySpaceManager() {
            log('=== æµ‹è¯•MySpaceManager ===');
            
            try {
                if (typeof window.mySpaceManager !== 'undefined') {
                    log('âœ… MySpaceManagerå¯ç”¨', 'success');
                    
                    const methods = [
                        'initPromptCount',
                        'updatePromptCount',
                        'refreshPromptCount',
                        'loadMyPromptsIfNeeded'
                    ];

                    methods.forEach(method => {
                        const available = typeof window.mySpaceManager[method] === 'function';
                        log(`  ${method}: ${available ? 'âœ…' : 'âŒ'}`);
                    });

                } else {
                    log('âŒ MySpaceManagerä¸å¯ç”¨', 'error');
                }
            } catch (error) {
                log(`âŒ æµ‹è¯•MySpaceManagerå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testRefreshPromptCount() {
            log('=== æµ‹è¯•åˆ·æ–°æç¤ºè¯æ•°é‡ ===');
            
            try {
                if (typeof window.mySpaceManager !== 'undefined' && 
                    typeof window.mySpaceManager.refreshPromptCount === 'function') {
                    
                    log('è°ƒç”¨refreshPromptCountæ–¹æ³•...');
                    updateMockCountDisplay('æˆ‘åˆ›å»ºçš„æç¤ºè¯æ•°é‡ï¼šåŠ è½½ä¸­...');
                    
                    // æ¨¡æ‹Ÿåˆ·æ–°è¿‡ç¨‹
                    setTimeout(() => {
                        updateMockCountDisplay('æˆ‘åˆ›å»ºçš„æç¤ºè¯æ•°é‡ï¼š8');
                        log('âœ… æ¨¡æ‹Ÿåˆ·æ–°å®Œæˆ', 'success');
                    }, 1000);

                } else {
                    log('âŒ refreshPromptCountæ–¹æ³•ä¸å¯ç”¨', 'error');
                }
            } catch (error) {
                log(`âŒ æµ‹è¯•åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testLoadMyPromptsIfNeeded() {
            log('=== æµ‹è¯•æ¡ä»¶åŠ è½½ ===');
            
            try {
                if (typeof window.mySpaceManager !== 'undefined' && 
                    typeof window.mySpaceManager.loadMyPromptsIfNeeded === 'function') {
                    
                    log('è°ƒç”¨loadMyPromptsIfNeededæ–¹æ³•...');
                    // è¿™ä¸ªæ–¹æ³•ä¼šæ£€æŸ¥å½“å‰é¡µé¢å’Œæ•°æ®çŠ¶æ€
                    
                    log('âœ… loadMyPromptsIfNeededæ–¹æ³•å¯ç”¨', 'success');

                } else {
                    log('âŒ loadMyPromptsIfNeededæ–¹æ³•ä¸å¯ç”¨', 'error');
                }
            } catch (error) {
                log(`âŒ æµ‹è¯•æ¡ä»¶åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function simulatePageHidden() {
            log('=== æ¨¡æ‹Ÿé¡µé¢éšè— ===');
            
            try {
                // æ¨¡æ‹Ÿé¡µé¢éšè—æ—¶çš„çŠ¶æ€å˜åŒ–
                updateMockCountDisplay('æˆ‘åˆ›å»ºçš„æç¤ºè¯æ•°é‡ï¼šåŠ è½½ä¸­...');
                
                // è§¦å‘visibilitychangeäº‹ä»¶
                Object.defineProperty(document, 'visibilityState', {
                    writable: true,
                    value: 'hidden'
                });
                
                const event = new Event('visibilitychange');
                document.dispatchEvent(event);
                
                log('âœ… é¡µé¢éšè—äº‹ä»¶å·²è§¦å‘', 'success');
                
            } catch (error) {
                log(`âŒ æ¨¡æ‹Ÿé¡µé¢éšè—å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function simulatePageVisible() {
            log('=== æ¨¡æ‹Ÿé¡µé¢æ¢å¤ ===');
            
            try {
                // è§¦å‘é¡µé¢æ¢å¤äº‹ä»¶
                Object.defineProperty(document, 'visibilityState', {
                    writable: true,
                    value: 'visible'
                });
                
                const event = new Event('visibilitychange');
                document.dispatchEvent(event);
                
                log('âœ… é¡µé¢æ¢å¤äº‹ä»¶å·²è§¦å‘', 'success');
                
                // æ¨¡æ‹Ÿæ•°æ®åˆ·æ–°
                setTimeout(() => {
                    updateMockCountDisplay('æˆ‘åˆ›å»ºçš„æç¤ºè¯æ•°é‡ï¼š5');
                    log('âœ… æ¨¡æ‹Ÿæ•°æ®åˆ·æ–°å®Œæˆ', 'success');
                }, 500);
                
            } catch (error) {
                log(`âŒ æ¨¡æ‹Ÿé¡µé¢æ¢å¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testVisibilityChange() {
            log('=== æµ‹è¯•å®Œæ•´çš„éšè—-æ¢å¤æµç¨‹ ===');
            
            // ç¡®ä¿æœ‰ç™»å½•çŠ¶æ€
            simulateLogin();
            
            setTimeout(() => {
                log('æ­¥éª¤1: æ¨¡æ‹Ÿé¡µé¢éšè—');
                simulatePageHidden();
                
                setTimeout(() => {
                    log('æ­¥éª¤2: æ¨¡æ‹Ÿé¡µé¢æ¢å¤');
                    simulatePageVisible();
                }, 1000);
            }, 500);
        }

        function prepareRealTest() {
            log('=== å‡†å¤‡å®é™…æµ‹è¯• ===');
            
            simulateLogin();
            
            setTimeout(() => {
                log('âœ… æµ‹è¯•å‡†å¤‡å®Œæˆ', 'success');
                log('ç°åœ¨æ‚¨å¯ä»¥ï¼š');
                log('1. æœ€å°åŒ–æµè§ˆå™¨çª—å£ç„¶åæ¢å¤');
                log('2. åˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µç„¶åè¿”å›');
                log('3. è§‚å¯Ÿæç¤ºè¯æ•°é‡æ˜¾ç¤ºæ˜¯å¦æ­£å¸¸');
            }, 500);
        }

        function goToMySpace() {
            log('è·³è½¬åˆ°æˆ‘çš„ç©ºé—´é¡µé¢...');
            window.location.href = 'index.html#my-space';
        }

        function clearLog() {
            if (logElement) {
                logElement.innerHTML = '';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('æˆ‘çš„ç©ºé—´æç¤ºè¯æ•°é‡ä¿®å¤æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            logElement = document.getElementById('operation-log');
            
            setTimeout(() => {
                log('æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
                log('ä¿®å¤å†…å®¹ï¼šé¡µé¢æ¢å¤æ—¶æ­£ç¡®åˆ·æ–°æç¤ºè¯æ•°é‡');
                testMySpaceManager();
            }, 1000);
        });

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                log('é¡µé¢æ¢å¤æ˜¾ç¤ºï¼Œè§¦å‘æ•°æ®åˆ·æ–°æ£€æŸ¥');
            } else {
                log('é¡µé¢éšè—');
            }
        });
    </script>
</body>
</html>
