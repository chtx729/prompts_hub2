<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å‡ºåŠŸèƒ½è°ƒè¯•</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--background-color);
        }
        .debug-container {
            background: var(--surface-color);
            padding: 2rem;
            border-radius: var(--radius-xl);
            margin-bottom: 2rem;
        }
        .debug-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
        }
        .debug-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: 0.5rem;
        }
        .debug-button:hover {
            background: var(--primary-hover);
        }
        .debug-button.danger {
            background: var(--error-color);
        }
        .debug-button.danger:hover {
            background: var(--error-hover);
        }
        .log-output {
            background: var(--gray-900);
            color: var(--gray-100);
            padding: 1rem;
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 1rem 0;
        }
        .status-info {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.875rem;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
</head>
<body>
    <div class="debug-container">
        <h1>ğŸ” ç™»å‡ºåŠŸèƒ½è°ƒè¯•</h1>
        <p>è°ƒè¯•ç™»å‡ºå¤±è´¥çš„é—®é¢˜</p>
    </div>

    <div class="debug-container">
        <div class="debug-section">
            <h3>å½“å‰çŠ¶æ€</h3>
            <div id="current-status" class="status-info">æ£€æŸ¥ä¸­...</div>
            <button class="debug-button" onclick="updateStatus()">åˆ·æ–°çŠ¶æ€</button>
        </div>

        <div class="debug-section">
            <h3>ç™»å‡ºæµ‹è¯•</h3>
            <button class="debug-button danger" onclick="testLogout()">æµ‹è¯•ç™»å‡º</button>
            <button class="debug-button danger" onclick="testDirectSupabaseLogout()">ç›´æ¥è°ƒç”¨Supabaseç™»å‡º</button>
            <button class="debug-button" onclick="testAuthManagerLogout()">è°ƒç”¨AuthManagerç™»å‡º</button>
        </div>

        <div class="debug-section">
            <h3>è®¤è¯äº‹ä»¶ç›‘å¬</h3>
            <button class="debug-button" onclick="setupEventListener()">è®¾ç½®äº‹ä»¶ç›‘å¬</button>
            <button class="debug-button" onclick="clearEventLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="event-log" class="log-output">ç­‰å¾…äº‹ä»¶...</div>
        </div>

        <div class="debug-section">
            <h3>Supabase çŠ¶æ€æ£€æŸ¥</h3>
            <button class="debug-button" onclick="checkSupabaseStatus()">æ£€æŸ¥SupabaseçŠ¶æ€</button>
            <button class="debug-button" onclick="getSession()">è·å–å½“å‰ä¼šè¯</button>
            <div id="supabase-status" class="status-info">ç­‰å¾…æ£€æŸ¥...</div>
        </div>
    </div>

    <script>
        let eventLogElement;
        let eventListener;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (eventLogElement) {
                eventLogElement.textContent += logMessage;
                eventLogElement.scrollTop = eventLogElement.scrollHeight;
            }
            
            console.log(logMessage);
        }

        function updateStatus() {
            const statusDiv = document.getElementById('current-status');
            let status = '';

            // æ£€æŸ¥åŸºç¡€å¯¹è±¡
            status += `Supabaseå¯ç”¨: ${typeof supabase !== 'undefined' ? 'âœ…' : 'âŒ'}\n`;
            status += `authManagerå¯ç”¨: ${typeof authManager !== 'undefined' ? 'âœ…' : 'âŒ'}\n`;
            
            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            if (typeof authManager !== 'undefined') {
                const isAuth = authManager.isAuthenticated();
                const user = authManager.getCurrentUser();
                status += `è®¤è¯çŠ¶æ€: ${isAuth ? 'âœ… å·²ç™»å½•' : 'âŒ æœªç™»å½•'}\n`;
                status += `å½“å‰ç”¨æˆ·: ${user ? user.email || user.username : 'æ— '}\n`;
            }

            statusDiv.textContent = status;
        }

        async function testLogout() {
            log('=== å¼€å§‹æµ‹è¯•ç™»å‡ºåŠŸèƒ½ ===');
            
            if (typeof authManager === 'undefined') {
                log('âŒ authManagerä¸å¯ç”¨');
                return;
            }

            if (!authManager.isAuthenticated()) {
                log('âŒ ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•æµ‹è¯•ç™»å‡º');
                return;
            }

            try {
                log('è°ƒç”¨ authManager.signOut()...');
                const result = await authManager.signOut();
                log(`ç™»å‡ºç»“æœ: ${JSON.stringify(result, null, 2)}`);
                
                if (result.success) {
                    log('âœ… ç™»å‡ºæˆåŠŸ');
                } else {
                    log(`âŒ ç™»å‡ºå¤±è´¥: ${result.error}`);
                }
            } catch (error) {
                log(`âŒ ç™»å‡ºå¼‚å¸¸: ${error.message}`);
                log(`å¼‚å¸¸å †æ ˆ: ${error.stack}`);
            }
            
            updateStatus();
        }

        async function testDirectSupabaseLogout() {
            log('=== ç›´æ¥è°ƒç”¨Supabaseç™»å‡º ===');
            
            if (typeof supabase === 'undefined') {
                log('âŒ Supabaseä¸å¯ç”¨');
                return;
            }

            try {
                log('è°ƒç”¨ supabase.auth.signOut()...');
                const { error } = await supabase.auth.signOut({ scope: 'global' });
                
                if (error) {
                    log(`âŒ Supabaseç™»å‡ºé”™è¯¯: ${JSON.stringify(error, null, 2)}`);
                } else {
                    log('âœ… Supabaseç™»å‡ºæˆåŠŸ');
                }
            } catch (error) {
                log(`âŒ Supabaseç™»å‡ºå¼‚å¸¸: ${error.message}`);
            }
            
            updateStatus();
        }

        async function testAuthManagerLogout() {
            log('=== æµ‹è¯•AuthManagerç™»å‡ºæ–¹æ³• ===');
            
            if (typeof authManager === 'undefined') {
                log('âŒ authManagerä¸å¯ç”¨');
                return;
            }

            try {
                log('æ£€æŸ¥AuthManageræ–¹æ³•...');
                log(`signOutæ–¹æ³•å­˜åœ¨: ${typeof authManager.signOut === 'function' ? 'âœ…' : 'âŒ'}`);
                
                if (typeof authManager.signOut === 'function') {
                    log('è°ƒç”¨ authManager.signOut()...');
                    const result = await authManager.signOut();
                    log(`ç»“æœ: ${JSON.stringify(result, null, 2)}`);
                }
            } catch (error) {
                log(`âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`);
            }
        }

        function setupEventListener() {
            log('=== è®¾ç½®è®¤è¯äº‹ä»¶ç›‘å¬ ===');
            
            if (typeof supabase === 'undefined') {
                log('âŒ Supabaseä¸å¯ç”¨');
                return;
            }

            // æ¸…é™¤ä¹‹å‰çš„ç›‘å¬å™¨
            if (eventListener) {
                eventListener.unsubscribe();
            }

            // è®¾ç½®æ–°çš„ç›‘å¬å™¨
            eventListener = supabase.auth.onAuthStateChange((event, session) => {
                log(`ğŸ”” è®¤è¯äº‹ä»¶: ${event}`);
                log(`ä¼šè¯ä¿¡æ¯: ${session ? 'æœ‰ä¼šè¯' : 'æ— ä¼šè¯'}`);
                log(`ç”¨æˆ·ä¿¡æ¯: ${session?.user ? session.user.email : 'æ— ç”¨æˆ·'}`);
                log(`å®Œæ•´äº‹ä»¶æ•°æ®: ${JSON.stringify({ event, session: session ? 'exists' : null }, null, 2)}`);
            });

            log('âœ… äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
        }

        function clearEventLog() {
            if (eventLogElement) {
                eventLogElement.textContent = '';
            }
        }

        async function checkSupabaseStatus() {
            log('=== æ£€æŸ¥SupabaseçŠ¶æ€ ===');
            
            const statusDiv = document.getElementById('supabase-status');
            let status = '';

            try {
                if (typeof supabase === 'undefined') {
                    status += 'âŒ Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–\n';
                    log('âŒ Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                } else {
                    status += 'âœ… Supabaseå®¢æˆ·ç«¯å·²åˆå§‹åŒ–\n';
                    log('âœ… Supabaseå®¢æˆ·ç«¯å·²åˆå§‹åŒ–');
                    
                    // æ£€æŸ¥è®¤è¯æ–¹æ³•
                    status += `auth.signOutæ–¹æ³•: ${typeof supabase.auth.signOut === 'function' ? 'âœ…' : 'âŒ'}\n`;
                    status += `auth.getSessionæ–¹æ³•: ${typeof supabase.auth.getSession === 'function' ? 'âœ…' : 'âŒ'}\n`;
                    status += `auth.onAuthStateChangeæ–¹æ³•: ${typeof supabase.auth.onAuthStateChange === 'function' ? 'âœ…' : 'âŒ'}\n`;
                }
            } catch (error) {
                status += `âŒ æ£€æŸ¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}\n`;
                log(`âŒ æ£€æŸ¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`);
            }

            statusDiv.textContent = status;
        }

        async function getSession() {
            log('=== è·å–å½“å‰ä¼šè¯ ===');
            
            if (typeof supabase === 'undefined') {
                log('âŒ Supabaseä¸å¯ç”¨');
                return;
            }

            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    log(`âŒ è·å–ä¼šè¯é”™è¯¯: ${JSON.stringify(error, null, 2)}`);
                } else {
                    log(`ä¼šè¯ä¿¡æ¯: ${JSON.stringify(session ? {
                        user: session.user?.email,
                        expires_at: session.expires_at,
                        access_token: session.access_token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'
                    } : null, null, 2)}`);
                }
            } catch (error) {
                log(`âŒ è·å–ä¼šè¯å¼‚å¸¸: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ç™»å‡ºè°ƒè¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            eventLogElement = document.getElementById('event-log');
            
            setTimeout(() => {
                updateStatus();
                checkSupabaseStatus();
                setupEventListener();
                log('è°ƒè¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            }, 1000);
        });
    </script>
</body>
</html>
