<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¤æµ‹è¯• - AIæç¤ºè¯å®åº“</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f8fafc;
        }
        .test-result {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { background: #f0fdf4; border: 1px solid #22c55e; color: #166534; }
        .error { background: #fef2f2; border: 1px solid #ef4444; color: #dc2626; }
        .warning { background: #fffbeb; border: 1px solid #f59e0b; color: #d97706; }
        .info { background: #f0f9ff; border: 1px solid #3b82f6; color: #1d4ed8; }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #4338ca; }
        h2 { color: #1f2937; margin-top: 2rem; }
        h3 { color: #374151; }
        .prompt-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            background: white;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
</head>
<body>
    <h1>ğŸ§ª ä¿®å¤æµ‹è¯•é¡µé¢</h1>
    <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•ä¿®å¤åçš„åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>

    <div class="test-section">
        <h3>ğŸ”§ åŸºç¡€åŠŸèƒ½æµ‹è¯•</h3>
        <button onclick="testBasicQuery()">æµ‹è¯•åŸºç¡€æŸ¥è¯¢</button>
        <button onclick="testPromptsLoad()">æµ‹è¯•æç¤ºè¯åŠ è½½</button>
        <button onclick="testCategoriesLoad()">æµ‹è¯•åˆ†ç±»åŠ è½½</button>
        <div id="basic-results"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“‹ æç¤ºè¯æ˜¾ç¤ºæµ‹è¯•</h3>
        <button onclick="loadAndDisplayPrompts()">åŠ è½½å¹¶æ˜¾ç¤ºæç¤ºè¯</button>
        <div id="prompts-display"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ” é”™è¯¯æ£€æŸ¥</h3>
        <button onclick="checkForErrors()">æ£€æŸ¥æ§åˆ¶å°é”™è¯¯</button>
        <div id="error-results"></div>
    </div>

    <script>
        function addResult(containerId, type, title, content) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${title}</strong>\n${content}`;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function testBasicQuery() {
            clearResults('basic-results');
            
            try {
                if (!supabase) {
                    addResult('basic-results', 'error', 'è¿æ¥å¤±è´¥', 'Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                    return;
                }

                // æµ‹è¯•ç®€å•æŸ¥è¯¢
                const { data, error } = await supabase
                    .from('prompts')
                    .select('prompt_id, title, author_name, category_name')
                    .limit(3);
                
                if (error) {
                    addResult('basic-results', 'error', 'æŸ¥è¯¢å¤±è´¥', error.message);
                } else {
                    addResult('basic-results', 'success', 'æŸ¥è¯¢æˆåŠŸ', `æ‰¾åˆ° ${data.length} æ¡è®°å½•:\n${data.map(p => `- ${p.title} (ä½œè€…: ${p.author_name})`).join('\n')}`);
                }

            } catch (error) {
                addResult('basic-results', 'error', 'æµ‹è¯•å¤±è´¥', error.message);
            }
        }

        async function testPromptsLoad() {
            clearResults('basic-results');
            
            try {
                const { data, error } = await supabase
                    .from('prompts')
                    .select('*')
                    .eq('status', 'published')
                    .eq('is_public', true)
                    .limit(5);

                if (error) {
                    addResult('basic-results', 'error', 'æç¤ºè¯åŠ è½½å¤±è´¥', error.message);
                } else {
                    const issues = [];
                    data.forEach(p => {
                        if (!p.author_name) issues.push(`æç¤ºè¯ ${p.prompt_id} ç¼ºå°‘ä½œè€…ä¿¡æ¯`);
                        if (!p.category_name) issues.push(`æç¤ºè¯ ${p.prompt_id} ç¼ºå°‘åˆ†ç±»ä¿¡æ¯`);
                    });

                    if (issues.length > 0) {
                        addResult('basic-results', 'warning', 'æ•°æ®å®Œæ•´æ€§é—®é¢˜', issues.join('\n'));
                    } else {
                        addResult('basic-results', 'success', 'æç¤ºè¯åŠ è½½æˆåŠŸ', `åŠ è½½äº† ${data.length} æ¡æç¤ºè¯ï¼Œæ•°æ®å®Œæ•´`);
                    }
                }
            } catch (error) {
                addResult('basic-results', 'error', 'æµ‹è¯•å¤±è´¥', error.message);
            }
        }

        async function testCategoriesLoad() {
            clearResults('basic-results');
            
            try {
                const { data, error } = await supabase
                    .from('categories')
                    .select('*')
                    .eq('is_active', true);

                if (error) {
                    addResult('basic-results', 'error', 'åˆ†ç±»åŠ è½½å¤±è´¥', error.message);
                } else {
                    addResult('basic-results', 'success', 'åˆ†ç±»åŠ è½½æˆåŠŸ', `æ‰¾åˆ° ${data.length} ä¸ªåˆ†ç±»:\n${data.map(c => `- ${c.name}`).join('\n')}`);
                }
            } catch (error) {
                addResult('basic-results', 'error', 'æµ‹è¯•å¤±è´¥', error.message);
            }
        }

        async function loadAndDisplayPrompts() {
            const container = document.getElementById('prompts-display');
            container.innerHTML = '<p>æ­£åœ¨åŠ è½½...</p>';
            
            try {
                const { data, error } = await supabase
                    .from('prompts')
                    .select('*')
                    .eq('status', 'published')
                    .eq('is_public', true)
                    .limit(3);

                if (error) {
                    container.innerHTML = `<div class="test-result error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                    return;
                }

                if (data.length === 0) {
                    container.innerHTML = '<div class="test-result warning">æ²¡æœ‰æ‰¾åˆ°æç¤ºè¯</div>';
                    return;
                }

                container.innerHTML = '';
                data.forEach(prompt => {
                    const card = document.createElement('div');
                    card.className = 'prompt-card';
                    card.innerHTML = `
                        <h4>${prompt.title}</h4>
                        <p><strong>ä½œè€…:</strong> ${prompt.author_name || 'åŒ¿åç”¨æˆ·'}</p>
                        <p><strong>åˆ†ç±»:</strong> ${prompt.category_name || 'æœªåˆ†ç±»'}</p>
                        <p><strong>æè¿°:</strong> ${prompt.description || 'æ— æè¿°'}</p>
                        <p><strong>æ ‡ç­¾:</strong> ${prompt.tags ? prompt.tags.join(', ') : 'æ— æ ‡ç­¾'}</p>
                        <p><strong>ç»Ÿè®¡:</strong> æµè§ˆ ${prompt.view_count || 0} | ä½¿ç”¨ ${prompt.use_count || 0} | ç‚¹èµ ${prompt.like_count || 0}</p>
                    `;
                    container.appendChild(card);
                });

                addResult('prompts-display', 'success', 'æ˜¾ç¤ºæˆåŠŸ', `æˆåŠŸæ˜¾ç¤º ${data.length} ä¸ªæç¤ºè¯å¡ç‰‡`);

            } catch (error) {
                container.innerHTML = `<div class="test-result error">æ˜¾ç¤ºå¤±è´¥: ${error.message}</div>`;
            }
        }

        function checkForErrors() {
            clearResults('error-results');
            
            // æ£€æŸ¥æ§åˆ¶å°é”™è¯¯
            const errors = [];
            
            // æ£€æŸ¥å…¨å±€å˜é‡
            if (typeof supabase === 'undefined') {
                errors.push('supabase æœªå®šä¹‰');
            }
            
            if (typeof SUPABASE_CONFIG === 'undefined') {
                errors.push('SUPABASE_CONFIG æœªå®šä¹‰');
            }
            
            if (typeof APP_CONFIG === 'undefined') {
                errors.push('APP_CONFIG æœªå®šä¹‰');
            }

            if (errors.length > 0) {
                addResult('error-results', 'error', 'å‘ç°é”™è¯¯', errors.join('\n'));
            } else {
                addResult('error-results', 'success', 'æ£€æŸ¥å®Œæˆ', 'æ²¡æœ‰å‘ç°æ˜æ˜¾é”™è¯¯');
            }

            // æ£€æŸ¥ç½‘ç»œè¿æ¥
            testBasicQuery().then(() => {
                addResult('error-results', 'info', 'ç½‘ç»œæµ‹è¯•', 'åŸºç¡€æŸ¥è¯¢æµ‹è¯•å·²å®Œæˆï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹ç»“æœ');
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('basic-results', 'info', 'è‡ªåŠ¨æµ‹è¯•', 'é¡µé¢å·²åŠ è½½ï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
                testBasicQuery();
            }, 1000);
        });

        // æ•è·é”™è¯¯
        window.addEventListener('error', (e) => {
            addResult('error-results', 'error', 'é¡µé¢é”™è¯¯', `${e.error?.message || e.message}\næ–‡ä»¶: ${e.filename}\nè¡Œå·: ${e.lineno}`);
        });

        window.addEventListener('unhandledrejection', (e) => {
            addResult('error-results', 'error', 'Promiseé”™è¯¯', e.reason?.message || e.reason);
        });
    </script>
</body>
</html>
