<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç¤ºè¯è¯¦æƒ…é¡µé¢æµ‹è¯• - AIæç¤ºè¯å®åº“</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
            background: var(--background-color);
        }
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            background: var(--surface-color);
        }
        .test-result {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #f0fdf4; border: 1px solid #22c55e; color: #166534; }
        .error { background: #fef2f2; border: 1px solid #ef4444; color: #dc2626; }
        .warning { background: #fffbeb; border: 1px solid #f59e0b; color: #d97706; }
        .info { background: #f0f9ff; border: 1px solid #3b82f6; color: #1d4ed8; }
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: var(--space-2);
            transition: var(--transition-fast);
        }
        button:hover { 
            background: var(--primary-hover);
            transform: translateY(-1px);
        }
        h2 { color: var(--text-primary); margin-top: 2rem; }
        h3 { color: var(--text-primary); }
        .demo-prompt {
            background: var(--gray-50);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin: var(--space-3) 0;
        }
        .demo-prompt h4 {
            margin: 0 0 var(--space-2) 0;
            color: var(--primary-600);
        }
        .demo-prompt p {
            margin: var(--space-1) 0;
            font-size: 14px;
        }
        .field-preview {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin: var(--space-2) 0;
        }
        .field-preview h5 {
            margin: 0 0 var(--space-2) 0;
            color: var(--text-primary);
            font-size: 14px;
        }
        .field-preview .content {
            color: var(--text-secondary);
            font-size: 13px;
        }
        .prompt-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
        }
        .prompt-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-2);
            margin: var(--space-1) 0;
            background: white;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .prompt-item:hover {
            background: var(--primary-50);
            border-color: var(--primary-200);
        }
        .prompt-info {
            flex: 1;
        }
        .prompt-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }
        .prompt-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/prompts.js"></script>
</head>
<body>
    <h1>ğŸ“„ æç¤ºè¯è¯¦æƒ…é¡µé¢æµ‹è¯•</h1>
    <p>æ­¤å·¥å…·ç”¨äºæµ‹è¯•æç¤ºè¯è¯¦æƒ…é¡µé¢çš„æ˜¾ç¤ºæ•ˆæœï¼ŒåŒ…æ‹¬ä½¿ç”¨æ¨¡å‹ã€å‚è€ƒè¾“å‡ºå’Œå‚è€ƒå›¾ç‰‡ã€‚</p>

    <div class="test-section">
        <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
        <div>
            <strong>ç™»å½•çŠ¶æ€ï¼š</strong>
            <span id="login-status">æ£€æŸ¥ä¸­...</span>
        </div>
        <div style="margin-top: var(--space-2);">
            <strong>APIè¿æ¥ï¼š</strong>
            <span id="api-status">æ£€æŸ¥ä¸­...</span>
        </div>
        <div style="margin-top: var(--space-2);">
            <strong>æç¤ºè¯ç®¡ç†å™¨ï¼š</strong>
            <span id="manager-status">æ£€æŸ¥ä¸­...</span>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ” æç¤ºè¯æŸ¥è¯¢</h3>
        <button onclick="loadPromptsList()">åŠ è½½æç¤ºè¯åˆ—è¡¨</button>
        <button onclick="clearPromptsList()">æ¸…ç©ºåˆ—è¡¨</button>
        <div id="prompts-query-results"></div>
        <div id="prompts-list" class="prompt-list" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“ è¯¦æƒ…å­—æ®µé¢„è§ˆ</h3>
        <p>ä»¥ä¸‹æ˜¯æç¤ºè¯è¯¦æƒ…é¡µé¢å°†æ˜¾ç¤ºçš„å­—æ®µï¼š</p>
        
        <div class="demo-prompt">
            <h4>ç¤ºä¾‹æç¤ºè¯æ•°æ®ç»“æ„</h4>
            <div class="field-preview">
                <h5>ğŸ¤– ä½¿ç”¨æ¨¡å‹ (model_name)</h5>
                <div class="content">æ˜¾ç¤ºä¸ºå¸¦å›¾æ ‡çš„å¾½ç« ï¼Œä¾‹å¦‚ï¼šGPT-4ã€Claude-3ã€Gemini Pro</div>
            </div>
            <div class="field-preview">
                <h5>ğŸ“„ å‚è€ƒè¾“å‡º (output_text)</h5>
                <div class="content">æ˜¾ç¤ºæç¤ºè¯çš„ç¤ºä¾‹è¾“å‡ºå†…å®¹ï¼Œå¸®åŠ©ç”¨æˆ·äº†è§£æ•ˆæœ</div>
            </div>
            <div class="field-preview">
                <h5>ğŸ–¼ï¸ å‚è€ƒå›¾ç‰‡ (output_media)</h5>
                <div class="content">æ˜¾ç¤ºå‚è€ƒå›¾ç‰‡ï¼Œæ”¯æŒç‚¹å‡»å…¨å±æŸ¥çœ‹ã€æ–°çª—å£æ‰“å¼€ã€ä¸‹è½½åŠŸèƒ½</div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ§ª è¯¦æƒ…é¡µé¢æµ‹è¯•</h3>
        <div>
            <label for="test-prompt-id">æç¤ºè¯IDï¼š</label>
            <input type="number" id="test-prompt-id" placeholder="è¾“å…¥æç¤ºè¯ID" style="margin: 0 var(--space-2); padding: var(--space-1); border: 1px solid var(--border-color); border-radius: var(--radius-md);">
            <button onclick="testPromptDetail()">æŸ¥çœ‹è¯¦æƒ…</button>
        </div>
        <button onclick="createMockPrompt()">åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®</button>
        <button onclick="testImageFeatures()">æµ‹è¯•å›¾ç‰‡åŠŸèƒ½</button>
        <div id="detail-test-results"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ¨ æ ·å¼é¢„è§ˆ</h3>
        <button onclick="showStylePreview()">æ˜¾ç¤ºæ ·å¼é¢„è§ˆ</button>
        <div id="style-preview-container"></div>
    </div>

    <script>
        function addResult(containerId, type, title, content) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${title}</strong>\n${content}`;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function updateStatus() {
            const loginStatus = document.getElementById('login-status');
            const apiStatus = document.getElementById('api-status');
            const managerStatus = document.getElementById('manager-status');
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (window.authManager && authManager.isAuthenticated()) {
                loginStatus.textContent = 'å·²ç™»å½•';
                loginStatus.style.color = 'var(--success-color)';
            } else {
                loginStatus.textContent = 'æœªç™»å½•';
                loginStatus.style.color = 'var(--error-color)';
            }
            
            // æ£€æŸ¥APIè¿æ¥
            if (window.apiManager) {
                apiStatus.textContent = 'å·²è¿æ¥';
                apiStatus.style.color = 'var(--success-color)';
            } else {
                apiStatus.textContent = 'æœªè¿æ¥';
                apiStatus.style.color = 'var(--error-color)';
            }
            
            // æ£€æŸ¥æç¤ºè¯ç®¡ç†å™¨
            if (window.promptsManager) {
                managerStatus.textContent = 'å·²åˆå§‹åŒ–';
                managerStatus.style.color = 'var(--success-color)';
            } else {
                managerStatus.textContent = 'æœªåˆå§‹åŒ–';
                managerStatus.style.color = 'var(--error-color)';
            }
        }

        async function loadPromptsList() {
            clearResults('prompts-query-results');
            
            try {
                addResult('prompts-query-results', 'info', 'æŸ¥è¯¢æç¤ºè¯', 'æ­£åœ¨è·å–æç¤ºè¯åˆ—è¡¨...');

                const result = await apiManager.getPrompts({
                    page: 1,
                    limit: 20
                });

                if (result.success && result.data.length > 0) {
                    addResult('prompts-query-results', 'success', 'æŸ¥è¯¢æˆåŠŸ', `æ‰¾åˆ° ${result.data.length} ä¸ªæç¤ºè¯`);
                    
                    const promptsList = document.getElementById('prompts-list');
                    promptsList.innerHTML = '';
                    promptsList.style.display = 'block';

                    result.data.forEach(prompt => {
                        const promptItem = document.createElement('div');
                        promptItem.className = 'prompt-item';
                        promptItem.innerHTML = `
                            <div class="prompt-info">
                                <div class="prompt-title">${prompt.title}</div>
                                <div class="prompt-meta">
                                    ID: ${prompt.prompt_id} | 
                                    æ¨¡å‹: ${prompt.model_name || 'æœªæŒ‡å®š'} | 
                                    å›¾ç‰‡: ${prompt.output_media ? 'æœ‰' : 'æ— '}
                                </div>
                            </div>
                            <button onclick="testSpecificPrompt(${prompt.prompt_id})" class="btn btn-sm">æŸ¥çœ‹</button>
                        `;
                        promptsList.appendChild(promptItem);
                    });
                } else {
                    addResult('prompts-query-results', 'warning', 'æ²¡æœ‰æ•°æ®', 'æ²¡æœ‰æ‰¾åˆ°æç¤ºè¯æ•°æ®');
                }

            } catch (error) {
                addResult('prompts-query-results', 'error', 'æŸ¥è¯¢å¤±è´¥', error.message);
            }
        }

        function clearPromptsList() {
            clearResults('prompts-query-results');
            document.getElementById('prompts-list').style.display = 'none';
        }

        async function testPromptDetail() {
            const promptId = document.getElementById('test-prompt-id').value;
            
            if (!promptId) {
                addResult('detail-test-results', 'warning', 'ç¼ºå°‘å‚æ•°', 'è¯·è¾“å…¥æç¤ºè¯ID');
                return;
            }

            await testSpecificPrompt(parseInt(promptId));
        }

        async function testSpecificPrompt(promptId) {
            clearResults('detail-test-results');
            
            try {
                addResult('detail-test-results', 'info', 'æµ‹è¯•è¯¦æƒ…é¡µé¢', `æ­£åœ¨åŠ è½½æç¤ºè¯ ${promptId} çš„è¯¦æƒ…...`);

                if (!window.promptsManager) {
                    // åˆå§‹åŒ–æç¤ºè¯ç®¡ç†å™¨
                    window.promptsManager = new PromptsManager();
                }

                // è°ƒç”¨è¯¦æƒ…é¡µé¢æ˜¾ç¤º
                await window.promptsManager.showPromptDetail(promptId);
                
                addResult('detail-test-results', 'success', 'è¯¦æƒ…é¡µé¢å·²æ˜¾ç¤º', `æç¤ºè¯ ${promptId} çš„è¯¦æƒ…é¡µé¢å·²æˆåŠŸæ˜¾ç¤º`);

                // æ£€æŸ¥è¯¦æƒ…é¡µé¢å†…å®¹
                setTimeout(() => {
                    checkDetailPageContent();
                }, 1000);

            } catch (error) {
                addResult('detail-test-results', 'error', 'æ˜¾ç¤ºå¤±è´¥', error.message);
            }
        }

        function checkDetailPageContent() {
            const detailPage = document.getElementById('prompt-detail-page');
            const detailContent = document.getElementById('prompt-detail-content');
            
            if (!detailPage || !detailContent) {
                addResult('detail-test-results', 'error', 'é¡µé¢æ£€æŸ¥', 'è¯¦æƒ…é¡µé¢å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            const checks = {
                'ä½¿ç”¨æ¨¡å‹': detailContent.querySelector('.prompt-model-section'),
                'å‚è€ƒè¾“å‡º': detailContent.querySelector('.prompt-output-section'),
                'å‚è€ƒå›¾ç‰‡': detailContent.querySelector('.prompt-media-section'),
                'æç¤ºè¯å†…å®¹': detailContent.querySelector('.prompt-content-section')
            };

            let checkResults = [];
            for (const [name, element] of Object.entries(checks)) {
                if (element) {
                    checkResults.push(`âœ… ${name}: å·²æ˜¾ç¤º`);
                } else {
                    checkResults.push(`âŒ ${name}: æœªæ˜¾ç¤º`);
                }
            }

            addResult('detail-test-results', 'info', 'å†…å®¹æ£€æŸ¥', checkResults.join('\n'));
        }

        function createMockPrompt() {
            clearResults('detail-test-results');
            
            const mockPrompt = {
                prompt_id: 999999,
                title: 'æµ‹è¯•æç¤ºè¯ - å®Œæ•´å­—æ®µå±•ç¤º',
                description: 'è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•çš„æç¤ºè¯ï¼ŒåŒ…å«æ‰€æœ‰å­—æ®µ',
                content: 'è¯·å¸®æˆ‘å†™ä¸€ç¯‡å…³äºäººå·¥æ™ºèƒ½çš„æ–‡ç« ï¼Œè¦æ±‚ï¼š\n1. å†…å®¹è¦ä¸“ä¸šä¸”æ˜“æ‡‚\n2. å­—æ•°æ§åˆ¶åœ¨1000å­—å·¦å³\n3. åŒ…å«AIçš„å‘å±•å†ç¨‹å’Œæœªæ¥å±•æœ›',
                model_name: 'GPT-4 Turbo',
                output_text: 'äººå·¥æ™ºèƒ½ï¼šä»æ¦‚å¿µåˆ°ç°å®çš„è·¨è¶Š\n\näººå·¥æ™ºèƒ½ï¼ˆArtificial Intelligenceï¼Œç®€ç§°AIï¼‰ä½œä¸º21ä¸–çºªæœ€å…·é©å‘½æ€§çš„æŠ€æœ¯ä¹‹ä¸€ï¼Œæ­£åœ¨æ·±åˆ»åœ°æ”¹å˜ç€æˆ‘ä»¬çš„ç”Ÿæ´»æ–¹å¼å’Œå·¥ä½œæ¨¡å¼...',
                output_media: 'https://images.unsplash.com/photo-1677442136019-21780ecad995?w=800&h=600&fit=crop',
                category_name: 'å†™ä½œåŠ©æ‰‹',
                author_name: 'æµ‹è¯•ç”¨æˆ·',
                author_avatar: APP_CONFIG.defaultAvatar,
                created_at: new Date().toISOString(),
                view_count: 1234,
                use_count: 567,
                like_count: 89,
                rating_average: 4.8,
                tags: ['å†™ä½œ', 'AI', 'æ–‡ç« ', 'ä¸“ä¸š']
            };

            // ç›´æ¥æ¸²æŸ“è¯¦æƒ…é¡µé¢
            if (!window.promptsManager) {
                window.promptsManager = new PromptsManager();
            }

            window.promptsManager.renderPromptDetail(mockPrompt);
            UI.showPage('prompt-detail-page');

            addResult('detail-test-results', 'success', 'æ¨¡æ‹Ÿæ•°æ®åˆ›å»º', 'å·²åˆ›å»ºåŒ…å«æ‰€æœ‰å­—æ®µçš„æ¨¡æ‹Ÿæç¤ºè¯æ•°æ®å¹¶æ˜¾ç¤ºè¯¦æƒ…é¡µé¢');
        }

        function testImageFeatures() {
            clearResults('detail-test-results');
            
            addResult('detail-test-results', 'info', 'å›¾ç‰‡åŠŸèƒ½æµ‹è¯•', 'æµ‹è¯•å›¾ç‰‡ç›¸å…³åŠŸèƒ½...');

            // æµ‹è¯•ä¸‹è½½åŠŸèƒ½
            const testImageUrl = 'https://images.unsplash.com/photo-1677442136019-21780ecad995?w=400&h=300&fit=crop';
            const testFilename = 'æµ‹è¯•å›¾ç‰‡';

            if (window.promptsManager && typeof window.promptsManager.downloadImage === 'function') {
                addResult('detail-test-results', 'success', 'ä¸‹è½½åŠŸèƒ½', 'ä¸‹è½½æ–¹æ³•å·²å®šä¹‰ï¼Œå¯ä»¥æµ‹è¯•ä¸‹è½½åŠŸèƒ½');
                
                // åˆ›å»ºæµ‹è¯•æŒ‰é’®
                const testButton = document.createElement('button');
                testButton.textContent = 'æµ‹è¯•ä¸‹è½½å›¾ç‰‡';
                testButton.onclick = () => {
                    window.promptsManager.downloadImage(testImageUrl, testFilename);
                };
                document.getElementById('detail-test-results').appendChild(testButton);
            } else {
                addResult('detail-test-results', 'error', 'ä¸‹è½½åŠŸèƒ½', 'ä¸‹è½½æ–¹æ³•æœªå®šä¹‰');
            }

            // æµ‹è¯•å›¾ç‰‡æ˜¾ç¤º
            const testImageHtml = `
                <div class="prompt-media-section" style="margin: var(--space-4) 0;">
                    <h3>å‚è€ƒå›¾ç‰‡æµ‹è¯•</h3>
                    <div class="prompt-media">
                        <div class="media-container">
                            <img src="${testImageUrl}" alt="æµ‹è¯•å›¾ç‰‡" class="reference-image" onclick="this.requestFullscreen()">
                            <div class="media-actions">
                                <button class="btn btn-outline btn-sm" onclick="window.open('${testImageUrl}', '_blank')">
                                    <i class="fas fa-external-link-alt"></i>
                                    æŸ¥çœ‹åŸå›¾
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="promptsManager.downloadImage('${testImageUrl}', '${testFilename}')">
                                    <i class="fas fa-download"></i>
                                    ä¸‹è½½å›¾ç‰‡
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const testContainer = document.createElement('div');
            testContainer.innerHTML = testImageHtml;
            document.getElementById('detail-test-results').appendChild(testContainer);

            addResult('detail-test-results', 'success', 'å›¾ç‰‡æ˜¾ç¤ºæµ‹è¯•', 'å·²åˆ›å»ºå›¾ç‰‡æ˜¾ç¤ºæµ‹è¯•åŒºåŸŸ');
        }

        function showStylePreview() {
            const container = document.getElementById('style-preview-container');
            
            container.innerHTML = `
                <div style="margin: var(--space-4) 0;">
                    <h4>ä½¿ç”¨æ¨¡å‹æ ·å¼é¢„è§ˆ</h4>
                    <div class="prompt-model">
                        <span class="model-badge">
                            <i class="fas fa-robot"></i>
                            GPT-4 Turbo
                        </span>
                    </div>
                </div>
                
                <div style="margin: var(--space-4) 0;">
                    <h4>å‚è€ƒè¾“å‡ºæ ·å¼é¢„è§ˆ</h4>
                    <div class="prompt-output-section">
                        <h3>å‚è€ƒè¾“å‡º</h3>
                        <div class="prompt-output">
                            <div class="output-content">
                                è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹è¾“å‡ºå†…å®¹ï¼Œå±•ç¤ºäº†æç¤ºè¯çš„ä½¿ç”¨æ•ˆæœã€‚å†…å®¹å¯èƒ½åŒ…å«å¤šè¡Œæ–‡æœ¬ï¼Œéœ€è¦ä¿æŒè‰¯å¥½çš„å¯è¯»æ€§å’Œæ ¼å¼ã€‚
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin: var(--space-4) 0;">
                    <h4>å‚è€ƒå›¾ç‰‡æ ·å¼é¢„è§ˆ</h4>
                    <div class="prompt-media-section">
                        <h3>å‚è€ƒå›¾ç‰‡</h3>
                        <div class="prompt-media">
                            <div class="media-container">
                                <img src="https://images.unsplash.com/photo-1677442136019-21780ecad995?w=600&h=400&fit=crop" alt="ç¤ºä¾‹å›¾ç‰‡" class="reference-image">
                                <div class="media-actions">
                                    <button class="btn btn-outline btn-sm">
                                        <i class="fas fa-external-link-alt"></i>
                                        æŸ¥çœ‹åŸå›¾
                                    </button>
                                    <button class="btn btn-outline btn-sm">
                                        <i class="fas fa-download"></i>
                                        ä¸‹è½½å›¾ç‰‡
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateStatus();
                
                // åˆå§‹åŒ–æç¤ºè¯ç®¡ç†å™¨
                if (!window.promptsManager) {
                    window.promptsManager = new PromptsManager();
                }
                
                // å®šæœŸæ›´æ–°çŠ¶æ€
                setInterval(updateStatus, 5000);
            }, 1000);
        });
    </script>
</body>
</html>
