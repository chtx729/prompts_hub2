<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡µé¢å…³é—­ä¼šè¯æ¸…ç†æµ‹è¯•</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--background-color);
        }
        .test-container {
            background: var(--surface-color);
            padding: 2rem;
            border-radius: var(--radius-xl);
            margin-bottom: 2rem;
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
        }
        .test-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: 0.5rem;
        }
        .test-button:hover {
            background: var(--primary-hover);
        }
        .test-button.danger {
            background: var(--error-color);
        }
        .test-button.danger:hover {
            background: var(--error-600);
        }
        .status-display {
            background: var(--info-50);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            border: 1px solid var(--info-200);
            font-family: monospace;
        }
        .log-output {
            background: var(--gray-900);
            color: var(--gray-100);
            padding: 1rem;
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 1rem 0;
        }
        .success {
            color: var(--success-600);
            font-weight: bold;
        }
        .error {
            color: var(--error-600);
            font-weight: bold;
        }
        .warning {
            color: var(--warning-600);
            font-weight: bold;
        }
        .test-scenario {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
        }
        .instruction {
            background: var(--warning-50);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            border: 1px solid var(--warning-200);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/api.js"></script>
    <script src="js/prompts.js"></script>
    <script src="js/myspace.js"></script>
    <script src="js/main.js"></script>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”’ é¡µé¢å…³é—­ä¼šè¯æ¸…ç†æµ‹è¯•</h1>
        <p>éªŒè¯é¡µé¢å…³é—­æ—¶æ˜¯å¦æ­£ç¡®æ¸…é™¤ç™»å½•ä¼šè¯</p>
    </div>

    <div class="test-container">
        <div class="test-section">
            <h3>åŠŸèƒ½è¯´æ˜</h3>
            <div class="test-scenario">
                <h4>éœ€æ±‚ï¼š</h4>
                <p>é¦–é¡µå…³é—­å‰å¦‚æœä¸ºç™»å½•çŠ¶æ€ï¼Œå…³é—­åå†é‡æ–°æ‰“å¼€æ—¶ä¸è¦è‡ªåŠ¨ç™»å½•</p>
                
                <h4>å®ç°ï¼š</h4>
                <p>1. âœ… åªç›‘å¬é¡µé¢çœŸæ­£å…³é—­äº‹ä»¶ï¼ˆbeforeunload/unloadï¼‰</p>
                <p>2. âŒ ä¸ç›‘å¬é¡µé¢éšè—äº‹ä»¶ï¼ˆä¿æŒæœ€å°åŒ–æ—¶çš„ç™»å½•çŠ¶æ€ï¼‰</p>
                <p>3. âŒ ä¸ç›‘å¬é¡µé¢å¤±ç„¦äº‹ä»¶ï¼ˆä¿æŒåˆ‡æ¢æ ‡ç­¾é¡µæ—¶çš„ç™»å½•çŠ¶æ€ï¼‰</p>
                <p>4. âœ… åªåœ¨å½»åº•å…³é—­æ—¶æ¸…é™¤ä¼šè¯æ•°æ®</p>
                
                <h4>é¢„æœŸæ•ˆæœï¼š</h4>
                <p>âœ… æœ€å°åŒ–çª—å£ï¼šä¿æŒç™»å½•çŠ¶æ€ï¼Œè¿”å›æ—¶æ— éœ€é‡æ–°ç™»å½•</p>
                <p>âœ… åˆ‡æ¢æ ‡ç­¾é¡µï¼šä¿æŒç™»å½•çŠ¶æ€ï¼Œè¿”å›æ—¶æ— éœ€é‡æ–°ç™»å½•</p>
                <p>âœ… å½»åº•å…³é—­é¡µé¢ï¼šæ¸…é™¤ç™»å½•çŠ¶æ€ï¼Œé‡æ–°æ‰“å¼€æ—¶éœ€è¦æ‰‹åŠ¨ç™»å½•</p>
            </div>
        </div>

        <div class="test-section">
            <h3>å½“å‰çŠ¶æ€</h3>
            <div id="current-status" class="status-display">
                æ£€æŸ¥ä¸­...
            </div>
            <button class="test-button" onclick="checkCurrentStatus()">åˆ·æ–°çŠ¶æ€</button>
            <button class="test-button" onclick="checkLocalStorage()">æ£€æŸ¥æœ¬åœ°å­˜å‚¨</button>
        </div>

        <div class="test-section">
            <h3>æ¨¡æ‹Ÿç™»å½•æµ‹è¯•</h3>
            <div class="instruction">
                <strong>âš ï¸ æ³¨æ„ï¼š</strong>è¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿç™»å½•çŠ¶æ€ï¼Œä¸æ˜¯çœŸå®ç™»å½•
            </div>
            <button class="test-button" onclick="simulateLogin()">æ¨¡æ‹Ÿç™»å½•çŠ¶æ€</button>
            <button class="test-button" onclick="simulateLogout()">æ¨¡æ‹Ÿç™»å‡º</button>
        </div>

        <div class="test-section">
            <h3>ä¼šè¯æ¸…ç†æµ‹è¯•</h3>
            <button class="test-button" onclick="testClearSession()">æµ‹è¯•æ‰‹åŠ¨æ¸…ç†ä¼šè¯</button>
            <button class="test-button" onclick="testPageUnloadHandler()">æµ‹è¯•é¡µé¢å…³é—­å¤„ç†å™¨</button>
            <button class="test-button" onclick="testVisibilityChange()">æµ‹è¯•é¡µé¢éšè—äº‹ä»¶</button>
        </div>

        <div class="test-section">
            <h3>å®é™…æµ‹è¯•åœºæ™¯</h3>

            <div class="test-scenario">
                <h4>åœºæ™¯1ï¼šæœ€å°åŒ–çª—å£æµ‹è¯•</h4>
                <ol>
                    <li>æ¨¡æ‹Ÿç™»å½•çŠ¶æ€</li>
                    <li>æœ€å°åŒ–æµè§ˆå™¨çª—å£</li>
                    <li>é‡æ–°æ‰“å¼€çª—å£</li>
                    <li>éªŒè¯æ˜¯å¦ä»ä¿æŒç™»å½•çŠ¶æ€</li>
                </ol>
                <button class="test-button" onclick="testMinimizeWindow()">æµ‹è¯•æœ€å°åŒ–ä¿æŒç™»å½•</button>
            </div>

            <div class="test-scenario">
                <h4>åœºæ™¯2ï¼šåˆ‡æ¢æ ‡ç­¾é¡µæµ‹è¯•</h4>
                <ol>
                    <li>æ¨¡æ‹Ÿç™»å½•çŠ¶æ€</li>
                    <li>åˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µ</li>
                    <li>è¿”å›å½“å‰æ ‡ç­¾é¡µ</li>
                    <li>éªŒè¯æ˜¯å¦ä»ä¿æŒç™»å½•çŠ¶æ€</li>
                </ol>
                <button class="test-button" onclick="testTabSwitch()">æµ‹è¯•åˆ‡æ¢æ ‡ç­¾é¡µä¿æŒç™»å½•</button>
            </div>

            <div class="test-scenario">
                <h4>åœºæ™¯3ï¼šå½»åº•å…³é—­é¡µé¢æµ‹è¯•</h4>
                <ol>
                    <li>æ¨¡æ‹Ÿç™»å½•çŠ¶æ€</li>
                    <li>å½»åº•å…³é—­å½“å‰æ ‡ç­¾é¡µ</li>
                    <li>é‡æ–°æ‰“å¼€é¦–é¡µ</li>
                    <li>éªŒè¯æ˜¯å¦æ˜¾ç¤ºæœªç™»å½•çŠ¶æ€</li>
                </ol>
                <button class="test-button" onclick="prepareForCloseTest()">å‡†å¤‡å…³é—­æµ‹è¯•</button>
                <button class="test-button danger" onclick="simulatePageClose()">æ¨¡æ‹Ÿé¡µé¢å…³é—­</button>
            </div>

            <button class="test-button" onclick="openNewTab()">åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é¦–é¡µ</button>
        </div>

        <div class="test-section">
            <h3>äº‹ä»¶ç›‘å¬å™¨æµ‹è¯•</h3>
            <button class="test-button" onclick="testEventListeners()">æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨</button>
            <button class="test-button" onclick="triggerBeforeUnload()">è§¦å‘beforeunload</button>
            <button class="test-button" onclick="triggerVisibilityChange()">è§¦å‘visibilitychange</button>
        </div>

        <div class="test-section">
            <h3>æ“ä½œæ—¥å¿—</h3>
            <button class="test-button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="operation-log" class="log-output">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script>
        let logElement;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (logElement) {
                logElement.innerHTML += `<span class="${className}">${logMessage}</span>`;
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(logMessage);
        }

        function checkCurrentStatus() {
            log('=== æ£€æŸ¥å½“å‰çŠ¶æ€ ===');
            
            const statusDiv = document.getElementById('current-status');
            let status = '';

            try {
                // æ£€æŸ¥è®¤è¯çŠ¶æ€
                if (typeof authManager !== 'undefined') {
                    const isAuth = authManager.isAuthenticated();
                    const user = authManager.getCurrentUser();
                    const sessionChecked = authManager.sessionChecked;

                    status += `è®¤è¯çŠ¶æ€: ${isAuth ? 'âœ… å·²ç™»å½•' : 'âŒ æœªç™»å½•'}\n`;
                    status += `å½“å‰ç”¨æˆ·: ${user ? user.email || user.username : 'æ— '}\n`;
                    status += `ä¼šè¯å·²æ£€æŸ¥: ${sessionChecked ? 'æ˜¯' : 'å¦'}\n`;
                    status += `åˆå§‹åŒ–çŠ¶æ€: ${authManager.isInitialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}\n`;

                    log(`è®¤è¯çŠ¶æ€: ${isAuth ? 'å·²ç™»å½•' : 'æœªç™»å½•'}`, isAuth ? 'warning' : 'success');

                    // æ£€æŸ¥æ˜¯å¦æœ‰é¡µé¢å…³é—­å¤„ç†å™¨
                    if (typeof authManager.setupPageUnloadHandler === 'function') {
                        status += `é¡µé¢å…³é—­å¤„ç†å™¨: âœ… å·²è®¾ç½®\n`;
                        log('âœ… é¡µé¢å…³é—­å¤„ç†å™¨å·²è®¾ç½®', 'success');
                    } else {
                        status += `é¡µé¢å…³é—­å¤„ç†å™¨: âŒ æœªè®¾ç½®\n`;
                        log('âŒ é¡µé¢å…³é—­å¤„ç†å™¨æœªè®¾ç½®', 'error');
                    }

                } else {
                    status += `è®¤è¯ç®¡ç†å™¨: âŒ ä¸å¯ç”¨\n`;
                    log('âŒ è®¤è¯ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }

            } catch (error) {
                status += `æ£€æŸ¥å¤±è´¥: ${error.message}\n`;
                log(`âŒ çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }

            statusDiv.textContent = status;
        }

        function checkLocalStorage() {
            log('=== æ£€æŸ¥æœ¬åœ°å­˜å‚¨ ===');
            
            try {
                const allKeys = Object.keys(localStorage);
                const authKeys = allKeys.filter(key => 
                    key.includes('supabase') || key.includes('auth') || key.includes('session')
                );

                log(`æœ¬åœ°å­˜å‚¨æ€»é”®æ•°: ${allKeys.length}`);
                log(`è®¤è¯ç›¸å…³é”®æ•°: ${authKeys.length}`);

                if (authKeys.length > 0) {
                    log('è®¤è¯ç›¸å…³çš„localStorageé”®:');
                    authKeys.forEach(key => {
                        const value = localStorage.getItem(key);
                        const preview = value ? value.substring(0, 50) + '...' : 'null';
                        log(`  ${key}: ${preview}`);
                    });
                } else {
                    log('âœ… æ²¡æœ‰è®¤è¯ç›¸å…³çš„localStorageæ•°æ®', 'success');
                }

            } catch (error) {
                log(`âŒ æ£€æŸ¥æœ¬åœ°å­˜å‚¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function simulateLogin() {
            log('=== æ¨¡æ‹Ÿç™»å½•çŠ¶æ€ ===');
            
            try {
                if (typeof authManager !== 'undefined') {
                    // æ¨¡æ‹Ÿç”¨æˆ·å¯¹è±¡
                    const mockUser = {
                        id: 'mock-user-id',
                        email: 'test@example.com',
                        username: 'testuser'
                    };

                    // è®¾ç½®æ¨¡æ‹Ÿç™»å½•çŠ¶æ€
                    authManager.currentUser = mockUser;
                    
                    // æ¨¡æ‹ŸlocalStorageæ•°æ®
                    const mockSession = {
                        access_token: 'mock_access_token',
                        refresh_token: 'mock_refresh_token',
                        expires_at: Math.floor(Date.now() / 1000) + 3600,
                        user: mockUser
                    };
                    
                    localStorage.setItem('sb-test-auth-token', JSON.stringify(mockSession));
                    
                    log('âœ… æ¨¡æ‹Ÿç™»å½•çŠ¶æ€è®¾ç½®æˆåŠŸ', 'success');
                    checkCurrentStatus();

                } else {
                    log('âŒ è®¤è¯ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }

            } catch (error) {
                log(`âŒ æ¨¡æ‹Ÿç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function simulateLogout() {
            log('=== æ¨¡æ‹Ÿç™»å‡º ===');
            
            try {
                if (typeof authManager !== 'undefined') {
                    authManager.currentUser = null;
                    localStorage.removeItem('sb-test-auth-token');
                    
                    log('âœ… æ¨¡æ‹Ÿç™»å‡ºæˆåŠŸ', 'success');
                    checkCurrentStatus();

                } else {
                    log('âŒ è®¤è¯ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }

            } catch (error) {
                log(`âŒ æ¨¡æ‹Ÿç™»å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testClearSession() {
            log('=== æµ‹è¯•æ‰‹åŠ¨æ¸…ç†ä¼šè¯ ===');
            
            try {
                if (typeof authManager !== 'undefined' && typeof authManager.clearSessionOnPageClose === 'function') {
                    log('è°ƒç”¨clearSessionOnPageCloseæ–¹æ³•...');
                    authManager.clearSessionOnPageClose();
                    
                    log('âœ… ä¼šè¯æ¸…ç†æ–¹æ³•è°ƒç”¨æˆåŠŸ', 'success');
                    
                    // æ£€æŸ¥æ¸…ç†ç»“æœ
                    setTimeout(() => {
                        checkCurrentStatus();
                        checkLocalStorage();
                    }, 500);

                } else {
                    log('âŒ ä¼šè¯æ¸…ç†æ–¹æ³•ä¸å¯ç”¨', 'error');
                }

            } catch (error) {
                log(`âŒ æµ‹è¯•ä¼šè¯æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testPageUnloadHandler() {
            log('=== æµ‹è¯•é¡µé¢å…³é—­å¤„ç†å™¨ ===');
            
            try {
                if (typeof authManager !== 'undefined' && typeof authManager.setupPageUnloadHandler === 'function') {
                    log('âœ… setupPageUnloadHandleræ–¹æ³•å¯ç”¨', 'success');
                    
                    // æ£€æŸ¥æ˜¯å¦å·²ç»è®¾ç½®äº†äº‹ä»¶ç›‘å¬å™¨
                    log('æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨è®¾ç½®...');
                    
                    // è¿™é‡Œæ— æ³•ç›´æ¥æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨ï¼Œä½†å¯ä»¥é€šè¿‡è°ƒç”¨æ¥éªŒè¯
                    log('é¡µé¢å…³é—­å¤„ç†å™¨åº”è¯¥å·²åœ¨åˆå§‹åŒ–æ—¶è®¾ç½®');

                } else {
                    log('âŒ setupPageUnloadHandleræ–¹æ³•ä¸å¯ç”¨', 'error');
                }

            } catch (error) {
                log(`âŒ æµ‹è¯•é¡µé¢å…³é—­å¤„ç†å™¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testVisibilityChange() {
            log('=== æµ‹è¯•é¡µé¢éšè—äº‹ä»¶ï¼ˆç°åœ¨åº”è¯¥ä¸æ¸…é™¤ä¼šè¯ï¼‰===');

            try {
                // å…ˆæ£€æŸ¥å½“å‰ç™»å½•çŠ¶æ€
                const beforeAuth = authManager.isAuthenticated();
                log(`éšè—å‰ç™»å½•çŠ¶æ€: ${beforeAuth}`);

                // æ¨¡æ‹Ÿé¡µé¢éšè—
                Object.defineProperty(document, 'visibilityState', {
                    writable: true,
                    value: 'hidden'
                });

                // è§¦å‘visibilitychangeäº‹ä»¶
                const event = new Event('visibilitychange');
                document.dispatchEvent(event);

                log('âœ… è§¦å‘visibilitychangeäº‹ä»¶', 'success');

                // æ£€æŸ¥ç™»å½•çŠ¶æ€æ˜¯å¦ä¿æŒ
                setTimeout(() => {
                    const afterAuth = authManager.isAuthenticated();
                    log(`éšè—åç™»å½•çŠ¶æ€: ${afterAuth}`);

                    if (beforeAuth === afterAuth) {
                        log('âœ… é¡µé¢éšè—æ—¶æ­£ç¡®ä¿æŒç™»å½•çŠ¶æ€', 'success');
                    } else {
                        log('âŒ é¡µé¢éšè—æ—¶é”™è¯¯åœ°æ”¹å˜äº†ç™»å½•çŠ¶æ€', 'error');
                    }

                    // æ¢å¤å¯è§çŠ¶æ€
                    Object.defineProperty(document, 'visibilityState', {
                        writable: true,
                        value: 'visible'
                    });
                    document.dispatchEvent(new Event('visibilitychange'));
                    log('æ¢å¤é¡µé¢å¯è§çŠ¶æ€');
                }, 500);

            } catch (error) {
                log(`âŒ æµ‹è¯•é¡µé¢éšè—äº‹ä»¶å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testMinimizeWindow() {
            log('=== æµ‹è¯•æœ€å°åŒ–çª—å£ä¿æŒç™»å½• ===');

            try {
                // ç¡®ä¿æœ‰ç™»å½•çŠ¶æ€
                simulateLogin();

                setTimeout(() => {
                    const beforeAuth = authManager.isAuthenticated();
                    log(`æœ€å°åŒ–å‰ç™»å½•çŠ¶æ€: ${beforeAuth}`);

                    // æ¨¡æ‹Ÿæœ€å°åŒ–ï¼ˆé€šè¿‡visibilitychangeäº‹ä»¶ï¼‰
                    Object.defineProperty(document, 'visibilityState', {
                        writable: true,
                        value: 'hidden'
                    });
                    document.dispatchEvent(new Event('visibilitychange'));

                    // æ¨¡æ‹Ÿçª—å£å¤±ç„¦
                    window.dispatchEvent(new Event('blur'));

                    log('æ¨¡æ‹Ÿæœ€å°åŒ–çª—å£...');

                    // æ£€æŸ¥ç™»å½•çŠ¶æ€
                    setTimeout(() => {
                        const afterAuth = authManager.isAuthenticated();
                        log(`æœ€å°åŒ–åç™»å½•çŠ¶æ€: ${afterAuth}`);

                        if (beforeAuth && afterAuth) {
                            log('âœ… æœ€å°åŒ–æ—¶æ­£ç¡®ä¿æŒç™»å½•çŠ¶æ€', 'success');
                        } else {
                            log('âŒ æœ€å°åŒ–æ—¶é”™è¯¯åœ°æ¸…é™¤äº†ç™»å½•çŠ¶æ€', 'error');
                        }

                        // æ¢å¤çª—å£
                        Object.defineProperty(document, 'visibilityState', {
                            writable: true,
                            value: 'visible'
                        });
                        document.dispatchEvent(new Event('visibilitychange'));
                        window.dispatchEvent(new Event('focus'));
                        log('æ¢å¤çª—å£çŠ¶æ€');

                    }, 500);
                }, 500);

            } catch (error) {
                log(`âŒ æµ‹è¯•æœ€å°åŒ–çª—å£å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testTabSwitch() {
            log('=== æµ‹è¯•åˆ‡æ¢æ ‡ç­¾é¡µä¿æŒç™»å½• ===');

            try {
                // ç¡®ä¿æœ‰ç™»å½•çŠ¶æ€
                simulateLogin();

                setTimeout(() => {
                    const beforeAuth = authManager.isAuthenticated();
                    log(`åˆ‡æ¢å‰ç™»å½•çŠ¶æ€: ${beforeAuth}`);

                    // æ¨¡æ‹Ÿåˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µ
                    Object.defineProperty(document, 'visibilityState', {
                        writable: true,
                        value: 'hidden'
                    });
                    document.dispatchEvent(new Event('visibilitychange'));
                    window.dispatchEvent(new Event('blur'));

                    log('æ¨¡æ‹Ÿåˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µ...');

                    // æ£€æŸ¥ç™»å½•çŠ¶æ€
                    setTimeout(() => {
                        const duringAuth = authManager.isAuthenticated();
                        log(`åˆ‡æ¢æœŸé—´ç™»å½•çŠ¶æ€: ${duringAuth}`);

                        // æ¨¡æ‹Ÿè¿”å›å½“å‰æ ‡ç­¾é¡µ
                        Object.defineProperty(document, 'visibilityState', {
                            writable: true,
                            value: 'visible'
                        });
                        document.dispatchEvent(new Event('visibilitychange'));
                        window.dispatchEvent(new Event('focus'));

                        log('æ¨¡æ‹Ÿè¿”å›å½“å‰æ ‡ç­¾é¡µ...');

                        setTimeout(() => {
                            const afterAuth = authManager.isAuthenticated();
                            log(`è¿”å›åç™»å½•çŠ¶æ€: ${afterAuth}`);

                            if (beforeAuth && duringAuth && afterAuth) {
                                log('âœ… åˆ‡æ¢æ ‡ç­¾é¡µæ—¶æ­£ç¡®ä¿æŒç™»å½•çŠ¶æ€', 'success');
                            } else {
                                log('âŒ åˆ‡æ¢æ ‡ç­¾é¡µæ—¶é”™è¯¯åœ°æ¸…é™¤äº†ç™»å½•çŠ¶æ€', 'error');
                            }
                        }, 500);

                    }, 500);
                }, 500);

            } catch (error) {
                log(`âŒ æµ‹è¯•åˆ‡æ¢æ ‡ç­¾é¡µå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function prepareForCloseTest() {
            log('=== å‡†å¤‡å…³é—­æµ‹è¯• ===');
            
            // å…ˆè®¾ç½®æ¨¡æ‹Ÿç™»å½•çŠ¶æ€
            simulateLogin();
            
            setTimeout(() => {
                log('âœ… æµ‹è¯•å‡†å¤‡å®Œæˆ', 'success');
                log('ç°åœ¨å¯ä»¥å…³é—­é¡µé¢è¿›è¡Œæµ‹è¯•');
                log('å…³é—­åé‡æ–°æ‰“å¼€é¦–é¡µï¼Œæ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºæœªç™»å½•çŠ¶æ€');
            }, 500);
        }

        function simulatePageClose() {
            log('=== æ¨¡æ‹Ÿé¡µé¢å…³é—­ ===');
            
            try {
                // è§¦å‘beforeunloadäº‹ä»¶
                const beforeUnloadEvent = new Event('beforeunload');
                window.dispatchEvent(beforeUnloadEvent);
                
                log('âœ… è§¦å‘beforeunloadäº‹ä»¶', 'success');
                
                // æ£€æŸ¥æ¸…ç†ç»“æœ
                setTimeout(() => {
                    checkCurrentStatus();
                    checkLocalStorage();
                }, 500);

            } catch (error) {
                log(`âŒ æ¨¡æ‹Ÿé¡µé¢å…³é—­å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function openNewTab() {
            log('åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€é¦–é¡µ...');
            window.open('index.html', '_blank');
        }

        function testEventListeners() {
            log('=== æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨ ===');
            
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰ç›¸å…³çš„äº‹ä»¶ç›‘å¬å™¨
                log('æ£€æŸ¥é¡µé¢å…³é—­ç›¸å…³çš„äº‹ä»¶ç›‘å¬å™¨...');
                
                // æ— æ³•ç›´æ¥æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨ï¼Œä½†å¯ä»¥éªŒè¯æ–¹æ³•å­˜åœ¨
                if (typeof authManager !== 'undefined') {
                    const methods = [
                        'setupPageUnloadHandler',
                        'clearSessionOnPageClose'
                    ];

                    methods.forEach(method => {
                        const available = typeof authManager[method] === 'function';
                        log(`  ${method}: ${available ? 'âœ…' : 'âŒ'}`);
                    });
                }

            } catch (error) {
                log(`âŒ æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function triggerBeforeUnload() {
            log('=== æ‰‹åŠ¨è§¦å‘beforeunloadäº‹ä»¶ ===');
            
            try {
                const event = new Event('beforeunload');
                window.dispatchEvent(event);
                log('âœ… beforeunloadäº‹ä»¶å·²è§¦å‘', 'success');

            } catch (error) {
                log(`âŒ è§¦å‘beforeunloadäº‹ä»¶å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function triggerVisibilityChange() {
            log('=== æ‰‹åŠ¨è§¦å‘visibilitychangeäº‹ä»¶ ===');
            
            try {
                const event = new Event('visibilitychange');
                document.dispatchEvent(event);
                log('âœ… visibilitychangeäº‹ä»¶å·²è§¦å‘', 'success');

            } catch (error) {
                log(`âŒ è§¦å‘visibilitychangeäº‹ä»¶å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            if (logElement) {
                logElement.innerHTML = '';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('é¡µé¢å…³é—­ä¼šè¯æ¸…ç†æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            logElement = document.getElementById('operation-log');
            
            setTimeout(() => {
                log('æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
                log('åŠŸèƒ½ï¼šé¡µé¢å…³é—­æ—¶è‡ªåŠ¨æ¸…é™¤ç™»å½•ä¼šè¯');
                checkCurrentStatus();
            }, 1000);
        });
    </script>
</body>
</html>
