<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šçŸ¥ä¿®å¤éªŒè¯ - AIæç¤ºè¯å®åº“</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
            background: var(--background-color);
        }
        .test-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            margin: var(--space-4) 0;
            box-shadow: var(--shadow-sm);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: var(--space-2);
        }
        .status-indicator.success { background: #10b981; }
        .status-indicator.error { background: #ef4444; }
        .status-indicator.warning { background: #f59e0b; }
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: var(--space-3) 0;
        }
        .log-entry {
            margin: var(--space-1) 0;
            padding: var(--space-1);
            border-radius: var(--radius-sm);
        }
        .log-entry.auth { background: rgba(139, 92, 246, 0.2); }
        .log-entry.notification { background: rgba(34, 197, 94, 0.2); }
        .log-entry.warning { background: rgba(245, 158, 11, 0.2); }
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: var(--space-1);
            transition: var(--transition-fast);
        }
        button:hover { 
            background: var(--primary-hover);
            transform: translateY(-1px);
        }
        .test-instructions {
            background: var(--primary-50);
            border: 1px solid var(--primary-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin: var(--space-4) 0;
        }
        .test-instructions h3 {
            color: var(--primary-700);
            margin-bottom: var(--space-2);
        }
        .test-instructions ol {
            color: var(--primary-600);
            margin-left: var(--space-4);
        }
        .test-instructions li {
            margin: var(--space-1) 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
</head>
<body>
    <h1>ğŸ”§ é€šçŸ¥ä¿®å¤éªŒè¯</h1>
    <p>æ­¤é¡µé¢ç”¨äºéªŒè¯"ç™»å½•æˆåŠŸ"é€šçŸ¥ä¿®å¤æ˜¯å¦ç”Ÿæ•ˆã€‚</p>

    <div class="test-instructions">
        <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h3>
        <ol>
            <li><strong>ç¡®ä¿å·²ç™»å½•</strong>ï¼šå¦‚æœæœªç™»å½•ï¼Œè¯·å…ˆç™»å½•</li>
            <li><strong>åˆ‡æ¢æ ‡ç­¾é¡µ</strong>ï¼šåˆ‡æ¢åˆ°å…¶ä»–ç½‘é¡µæ ‡ç­¾é¡µï¼Œç„¶ååˆ‡æ¢å›æ¥</li>
            <li><strong>æœ€å°åŒ–çª—å£</strong>ï¼šæœ€å°åŒ–æµè§ˆå™¨çª—å£ï¼Œç„¶åæ¢å¤</li>
            <li><strong>åˆ·æ–°é¡µé¢</strong>ï¼šæŒ‰F5åˆ·æ–°é¡µé¢</li>
            <li><strong>è§‚å¯Ÿç»“æœ</strong>ï¼šä»¥ä¸Šæ“ä½œéƒ½ä¸åº”è¯¥æ˜¾ç¤º"ç™»å½•æˆåŠŸ"é€šçŸ¥</li>
        </ol>
    </div>

    <div class="test-card">
        <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
        <div>
            <span class="status-indicator success"></span>
            <strong>è®¤è¯çŠ¶æ€ï¼š</strong>
            <span id="auth-status">æ£€æŸ¥ä¸­...</span>
        </div>
        <div style="margin-top: var(--space-2);">
            <strong>ç”¨æˆ·ä¿¡æ¯ï¼š</strong>
            <span id="user-info">æ£€æŸ¥ä¸­...</span>
        </div>
        <div style="margin-top: var(--space-2);">
            <strong>é¡µé¢å¯è§æ€§ï¼š</strong>
            <span id="visibility-status">å¯è§</span>
        </div>
        <div style="margin-top: var(--space-2);">
            <strong>è®¤è¯ç®¡ç†å™¨åˆå§‹åŒ–ï¼š</strong>
            <span id="init-status">æ£€æŸ¥ä¸­...</span>
        </div>
    </div>

    <div class="test-card">
        <h3>ğŸ“ äº‹ä»¶æ—¥å¿—</h3>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <button onclick="toggleAutoScroll()">åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨</button>
        <div id="log-container" class="log-container">ç­‰å¾…äº‹ä»¶...</div>
    </div>

    <div class="test-card">
        <h3>ğŸ§ª æ‰‹åŠ¨æµ‹è¯•</h3>
        <button onclick="simulatePageHidden()">æ¨¡æ‹Ÿé¡µé¢éšè—</button>
        <button onclick="simulatePageVisible()">æ¨¡æ‹Ÿé¡µé¢æ˜¾ç¤º</button>
        <button onclick="simulateFocusChange()">æ¨¡æ‹Ÿç„¦ç‚¹å˜åŒ–</button>
        <button onclick="checkAuthState()">æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
        <div id="test-results" style="margin-top: var(--space-3);"></div>
    </div>

    <script>
        let eventLog = [];
        let autoScroll = true;
        let notificationCount = 0;

        // é‡å†™é€šçŸ¥æ–¹æ³•æ¥ç›‘æ§
        const originalShowNotification = UI.showNotification;
        UI.showNotification = function(message, type, title) {
            notificationCount++;
            const timestamp = new Date().toLocaleTimeString();
            
            addLogEntry(`[${timestamp}] ğŸ”” é€šçŸ¥: ${message} (${type})`, 'notification');
            
            // ç‰¹åˆ«æ ‡è®°"ç™»å½•æˆåŠŸ"é€šçŸ¥
            if (message === 'ç™»å½•æˆåŠŸ') {
                addLogEntry(`[${timestamp}] âš ï¸ æ£€æµ‹åˆ°"ç™»å½•æˆåŠŸ"é€šçŸ¥ï¼`, 'warning');
                console.warn('ğŸš¨ æ£€æµ‹åˆ°"ç™»å½•æˆåŠŸ"é€šçŸ¥:', { message, type, title });
            }
            
            return originalShowNotification.call(this, message, type, title);
        };

        function addLogEntry(text, type = 'normal') {
            const timestamp = new Date().toLocaleTimeString();
            eventLog.push({
                time: timestamp,
                text: text,
                type: type
            });
            
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const container = document.getElementById('log-container');
            
            if (eventLog.length === 0) {
                container.innerHTML = 'ç­‰å¾…äº‹ä»¶...';
                return;
            }
            
            const logHtml = eventLog.map(entry => 
                `<div class="log-entry ${entry.type}">${entry.text}</div>`
            ).join('');
            
            container.innerHTML = logHtml;
            
            if (autoScroll) {
                container.scrollTop = container.scrollHeight;
            }
        }

        function clearLog() {
            eventLog = [];
            notificationCount = 0;
            updateLogDisplay();
            addLogEntry('æ—¥å¿—å·²æ¸…ç©º');
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            addLogEntry(`è‡ªåŠ¨æ»šåŠ¨: ${autoScroll ? 'å¼€å¯' : 'å…³é—­'}`);
        }

        function updateStatus() {
            const authStatus = document.getElementById('auth-status');
            const userInfo = document.getElementById('user-info');
            const initStatus = document.getElementById('init-status');
            
            if (window.authManager) {
                const isAuth = authManager.isAuthenticated();
                const user = authManager.getCurrentUser();
                
                authStatus.textContent = isAuth ? 'å·²ç™»å½•' : 'æœªç™»å½•';
                userInfo.textContent = user ? user.email : 'æ— ';
                initStatus.textContent = authManager.isInitialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–';
            } else {
                authStatus.textContent = 'è®¤è¯ç®¡ç†å™¨æœªæ‰¾åˆ°';
                userInfo.textContent = 'æ— ';
                initStatus.textContent = 'æœªæ‰¾åˆ°';
            }
        }

        function simulatePageHidden() {
            addLogEntry('ğŸ”„ æ¨¡æ‹Ÿé¡µé¢éšè—');
            Object.defineProperty(document, 'hidden', { value: true, configurable: true });
            document.dispatchEvent(new Event('visibilitychange'));
            
            setTimeout(() => {
                addLogEntry('âœ… é¡µé¢éšè—æ¨¡æ‹Ÿå®Œæˆ');
            }, 100);
        }

        function simulatePageVisible() {
            addLogEntry('ğŸ”„ æ¨¡æ‹Ÿé¡µé¢æ˜¾ç¤º');
            Object.defineProperty(document, 'hidden', { value: false, configurable: true });
            document.dispatchEvent(new Event('visibilitychange'));
            
            setTimeout(() => {
                addLogEntry('âœ… é¡µé¢æ˜¾ç¤ºæ¨¡æ‹Ÿå®Œæˆ');
            }, 100);
        }

        function simulateFocusChange() {
            addLogEntry('ğŸ”„ æ¨¡æ‹Ÿç„¦ç‚¹å˜åŒ–');
            window.dispatchEvent(new Event('blur'));
            
            setTimeout(() => {
                window.dispatchEvent(new Event('focus'));
                addLogEntry('âœ… ç„¦ç‚¹å˜åŒ–æ¨¡æ‹Ÿå®Œæˆ');
            }, 500);
        }

        function checkAuthState() {
            addLogEntry('ğŸ” æ‰‹åŠ¨æ£€æŸ¥è®¤è¯çŠ¶æ€');
            
            if (window.authManager) {
                const user = authManager.getCurrentUser();
                addLogEntry(`è®¤è¯çŠ¶æ€: ${user ? 'å·²ç™»å½•' : 'æœªç™»å½•'}`);
                addLogEntry(`ç”¨æˆ·: ${user ? user.email : 'æ— '}`);
                addLogEntry(`åˆå§‹åŒ–: ${authManager.isInitialized ? 'æ˜¯' : 'å¦'}`);
            } else {
                addLogEntry('âŒ è®¤è¯ç®¡ç†å™¨æœªæ‰¾åˆ°');
            }
        }

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', function() {
            const status = document.getElementById('visibility-status');
            const isVisible = !document.hidden;
            status.textContent = isVisible ? 'å¯è§' : 'éšè—';
            
            addLogEntry(`ğŸ“± é¡µé¢å¯è§æ€§å˜åŒ–: ${isVisible ? 'å¯è§' : 'éšè—'}`);
        });

        // ç›‘å¬çª—å£ç„¦ç‚¹å˜åŒ–
        window.addEventListener('focus', function() {
            addLogEntry('ğŸ¯ çª—å£è·å¾—ç„¦ç‚¹');
        });

        window.addEventListener('blur', function() {
            addLogEntry('ğŸ¯ çª—å£å¤±å»ç„¦ç‚¹');
        });

        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
        if (window.authManager && authManager.onAuthStateChange) {
            authManager.onAuthStateChange((event, user) => {
                addLogEntry(`ğŸ” è®¤è¯äº‹ä»¶: ${event}, ç”¨æˆ·: ${user ? user.email : 'null'}`, 'auth');
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                addLogEntry('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
                updateStatus();
                
                // å®šæœŸæ›´æ–°çŠ¶æ€
                setInterval(updateStatus, 3000);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰çš„é€šçŸ¥
                setTimeout(() => {
                    if (notificationCount === 0) {
                        addLogEntry('âœ… é¡µé¢åŠ è½½æ—¶æ²¡æœ‰æ˜¾ç¤ºé€šçŸ¥ - ä¿®å¤ç”Ÿæ•ˆï¼', 'notification');
                    } else {
                        addLogEntry(`âš ï¸ é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºäº† ${notificationCount} ä¸ªé€šçŸ¥`, 'warning');
                    }
                }, 2000);
            }, 500);
        });

        // é¡µé¢å¸è½½å‰è®°å½•
        window.addEventListener('beforeunload', () => {
            addLogEntry('ğŸ“¤ é¡µé¢å³å°†å¸è½½');
        });

        // é¡µé¢æ˜¾ç¤ºæ—¶è®°å½•ï¼ˆä»å…¶ä»–é¡µé¢è¿”å›ï¼‰
        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                addLogEntry('ğŸ”„ ä»ç¼“å­˜æ¢å¤é¡µé¢');
            } else {
                addLogEntry('ğŸ”„ é¡µé¢æ­£å¸¸æ˜¾ç¤º');
            }
        });
    </script>
</body>
</html>
