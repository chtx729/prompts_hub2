<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç©ºé—´ä¿®å¤éªŒè¯</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--background-color);
        }
        .test-container {
            background: var(--surface-color);
            padding: 2rem;
            border-radius: var(--radius-xl);
            margin-bottom: 2rem;
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
        }
        .test-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: 0.5rem;
        }
        .test-button:hover {
            background: var(--primary-hover);
        }
        .status-info {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
        }
        .fix-demo {
            background: var(--gray-50);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            margin: 1rem 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/api.js"></script>
    <script src="js/prompts.js"></script>
    <script src="js/myspace.js"></script>
    <script src="js/main.js"></script>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ æˆ‘çš„ç©ºé—´ä¿®å¤éªŒè¯</h1>
        <p>éªŒè¯ç”¨æˆ·åˆ‡æ¢åˆ·æ–°å’Œåˆ†é¡µæ˜¾ç¤ºçš„ä¿®å¤æ•ˆæœ</p>
    </div>

    <div class="test-container">
        <div class="test-section">
            <h3>ä¿®å¤1ï¼šç”¨æˆ·åˆ‡æ¢æ—¶é¡µé¢åˆ·æ–°</h3>
            <div style="background: var(--info-50); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid var(--info-200);">
                <h4 style="color: var(--info-700); margin-top: 0;">âœ¨ ä¿®å¤å†…å®¹</h4>
                <ul style="color: var(--info-600); margin-bottom: 0;">
                    <li><strong>é—®é¢˜</strong>ï¼šæ›´æ¢è´¦æˆ·ç™»å½•æ—¶ï¼Œæˆ‘çš„ç©ºé—´é¡µé¢æ•°æ®æ²¡æœ‰åˆ·æ–°</li>
                    <li><strong>åŸå› </strong>ï¼šè®¤è¯ç®¡ç†å™¨æ²¡æœ‰æ£€æµ‹ç”¨æˆ·åˆ‡æ¢äº‹ä»¶</li>
                    <li><strong>è§£å†³</strong>ï¼šæ·»åŠ userChangedäº‹ä»¶æ£€æµ‹å’Œå¤„ç†</li>
                    <li><strong>æ•ˆæœ</strong>ï¼šç”¨æˆ·åˆ‡æ¢æ—¶è‡ªåŠ¨é‡ç½®é¡µé¢çŠ¶æ€å¹¶é‡æ–°åŠ è½½æ•°æ®</li>
                </ul>
            </div>
            
            <div id="user-switch-status" class="status-info">ç­‰å¾…æ£€æŸ¥...</div>
            <button class="test-button" onclick="checkUserSwitchFix()">æ£€æŸ¥ç”¨æˆ·åˆ‡æ¢ä¿®å¤</button>
        </div>

        <div class="test-section">
            <h3>ä¿®å¤2ï¼šåˆ†é¡µæ˜¾ç¤º</h3>
            <div style="background: var(--success-50); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid var(--success-200);">
                <h4 style="color: var(--success-700); margin-top: 0;">âœ¨ ä¿®å¤å†…å®¹</h4>
                <ul style="color: var(--success-600); margin-bottom: 0;">
                    <li><strong>é—®é¢˜</strong>ï¼šæˆ‘çš„ç©ºé—´é¡µé¢æ²¡æœ‰åˆ†é¡µæ˜¾ç¤ºï¼Œåªæ˜¾ç¤º12æ¡æ•°æ®</li>
                    <li><strong>åŸå› </strong>ï¼šç¼ºå°‘åˆ†é¡µå®¹å™¨å’Œåˆ†é¡µé€»è¾‘</li>
                    <li><strong>è§£å†³</strong>ï¼šæ·»åŠ my-paginationå®¹å™¨å’Œåˆ†é¡µå¤„ç†</li>
                    <li><strong>æ•ˆæœ</strong>ï¼šæ•°æ®å¤šæ—¶æ˜¾ç¤ºåˆ†é¡µæ§ä»¶ï¼Œæ”¯æŒç¿»é¡µ</li>
                </ul>
            </div>
            
            <div id="pagination-status" class="status-info">ç­‰å¾…æ£€æŸ¥...</div>
            <button class="test-button" onclick="checkPaginationFix()">æ£€æŸ¥åˆ†é¡µä¿®å¤</button>
        </div>

        <div class="test-section">
            <h3>æ¨¡æ‹Ÿæˆ‘çš„ç©ºé—´é¡µé¢</h3>
            <div class="fix-demo">
                <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
                    <div class="page-title-section">
                        <h2 style="margin: 0;">æˆ‘çš„ç©ºé—´</h2>
                        <p class="prompt-count-display" id="my-prompt-count">æˆ‘åˆ›å»ºçš„æç¤ºè¯æ•°é‡ï¼šåŠ è½½ä¸­...</p>
                    </div>
                    <button class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        åˆ›å»ºæç¤ºè¯
                    </button>
                </div>
                
                <div class="my-prompts-grid" id="my-prompts-container">
                    <!-- ç”¨æˆ·çš„æç¤ºè¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-plus-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•æç¤ºè¯ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹åˆ›å»ºå§ï¼</p>
                    </div>
                </div>
                
                <div class="pagination" id="my-pagination">
                    <!-- æˆ‘çš„ç©ºé—´åˆ†é¡µæ§ä»¶å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•æ“ä½œ</h3>
            <button class="test-button" onclick="simulateUserSwitch()">æ¨¡æ‹Ÿç”¨æˆ·åˆ‡æ¢</button>
            <button class="test-button" onclick="simulatePagination()">æ¨¡æ‹Ÿåˆ†é¡µæ•°æ®</button>
            <button class="test-button" onclick="testMySpaceManager()">æµ‹è¯•MySpaceManager</button>
            <button class="test-button" onclick="clearTestData()">æ¸…ç©ºæµ‹è¯•æ•°æ®</button>
        </div>

        <div class="test-section">
            <h3>å®æ—¶çŠ¶æ€ç›‘æ§</h3>
            <div id="realtime-monitor" class="status-info">ç›‘æ§ä¸­...</div>
        </div>
    </div>

    <script>
        function checkUserSwitchFix() {
            const statusDiv = document.getElementById('user-switch-status');
            let status = '';

            // æ£€æŸ¥è®¤è¯ç®¡ç†å™¨
            status += `authManagerå¯ç”¨: ${typeof authManager !== 'undefined' ? 'âœ…' : 'âŒ'}\n`;
            
            if (typeof authManager !== 'undefined') {
                // æ£€æŸ¥äº‹ä»¶ç›‘å¬
                status += `äº‹ä»¶å›è°ƒæ•°é‡: ${authManager.authCallbacks ? authManager.authCallbacks.length : 0}\n`;
                
                // æ£€æŸ¥MySpaceManagerçš„äº‹ä»¶ç›‘å¬
                if (typeof mySpaceManager !== 'undefined') {
                    status += `mySpaceManagerå¯ç”¨: âœ…\n`;
                    status += `resetPageStateæ–¹æ³•: ${typeof mySpaceManager.resetPageState === 'function' ? 'âœ…' : 'âŒ'}\n`;
                } else {
                    status += `mySpaceManagerå¯ç”¨: âŒ\n`;
                }
            }

            statusDiv.textContent = status;
        }

        function checkPaginationFix() {
            const statusDiv = document.getElementById('pagination-status');
            let status = '';

            // æ£€æŸ¥åˆ†é¡µå®¹å™¨
            const paginationContainer = document.getElementById('my-pagination');
            status += `my-paginationå®¹å™¨: ${paginationContainer ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}\n`;
            
            // æ£€æŸ¥UI.createPaginationæ–¹æ³•
            status += `UI.createPaginationæ–¹æ³•: ${typeof UI.createPagination === 'function' ? 'âœ…' : 'âŒ'}\n`;
            
            // æ£€æŸ¥MySpaceManagerçš„åˆ†é¡µæ–¹æ³•
            if (typeof mySpaceManager !== 'undefined') {
                status += `createMyPromptsPaginationæ–¹æ³•: ${typeof mySpaceManager.createMyPromptsPagination === 'function' ? 'âœ…' : 'âŒ'}\n`;
            }

            statusDiv.textContent = status;
        }

        function simulateUserSwitch() {
            console.log('æ¨¡æ‹Ÿç”¨æˆ·åˆ‡æ¢...');
            
            if (typeof authManager !== 'undefined' && typeof mySpaceManager !== 'undefined') {
                // æ¨¡æ‹Ÿè§¦å‘userChangedäº‹ä»¶
                if (typeof mySpaceManager.resetPageState === 'function') {
                    mySpaceManager.resetPageState();
                    console.log('âœ… è°ƒç”¨resetPageStateæˆåŠŸ');
                    alert('ç”¨æˆ·åˆ‡æ¢æ¨¡æ‹Ÿå®Œæˆï¼Œé¡µé¢çŠ¶æ€å·²é‡ç½®');
                } else {
                    alert('resetPageStateæ–¹æ³•ä¸å¯ç”¨');
                }
            } else {
                alert('ç®¡ç†å™¨ä¸å¯ç”¨');
            }
            
            updateRealtimeMonitor();
        }

        function simulatePagination() {
            console.log('æ¨¡æ‹Ÿåˆ†é¡µæ•°æ®...');
            
            if (typeof mySpaceManager !== 'undefined' && typeof mySpaceManager.createMyPromptsPagination === 'function') {
                // æ¨¡æ‹Ÿåˆ†é¡µæ•°æ®
                const mockPagination = {
                    page: 2,
                    pageSize: 12,
                    total: 45,
                    totalPages: 4
                };
                
                mySpaceManager.createMyPromptsPagination(mockPagination);
                console.log('âœ… åˆ†é¡µåˆ›å»ºæˆåŠŸ');
                alert('åˆ†é¡µæ¨¡æ‹Ÿå®Œæˆï¼Œè¯·æŸ¥çœ‹åˆ†é¡µæ§ä»¶');
            } else {
                alert('createMyPromptsPaginationæ–¹æ³•ä¸å¯ç”¨');
            }
            
            updateRealtimeMonitor();
        }

        function testMySpaceManager() {
            console.log('æµ‹è¯•MySpaceManager...');
            
            let result = '';
            
            if (typeof mySpaceManager !== 'undefined') {
                result += 'âœ… mySpaceManagerå­˜åœ¨\n';
                result += `resetPageState: ${typeof mySpaceManager.resetPageState === 'function' ? 'âœ…' : 'âŒ'}\n`;
                result += `createMyPromptsPagination: ${typeof mySpaceManager.createMyPromptsPagination === 'function' ? 'âœ…' : 'âŒ'}\n`;
                result += `updatePromptCount: ${typeof mySpaceManager.updatePromptCount === 'function' ? 'âœ…' : 'âŒ'}\n`;
                result += `loadMyPrompts: ${typeof mySpaceManager.loadMyPrompts === 'function' ? 'âœ…' : 'âŒ'}\n`;
            } else {
                result += 'âŒ mySpaceManagerä¸å­˜åœ¨\n';
            }
            
            alert(result);
            updateRealtimeMonitor();
        }

        function clearTestData() {
            console.log('æ¸…ç©ºæµ‹è¯•æ•°æ®...');
            
            // æ¸…ç©ºåˆ†é¡µ
            const paginationContainer = document.getElementById('my-pagination');
            if (paginationContainer) {
                paginationContainer.innerHTML = '';
            }
            
            // é‡ç½®æ•°é‡æ˜¾ç¤º
            const countElement = document.getElementById('my-prompt-count');
            if (countElement) {
                countElement.textContent = 'æˆ‘åˆ›å»ºçš„æç¤ºè¯æ•°é‡ï¼šåŠ è½½ä¸­...';
            }
            
            alert('æµ‹è¯•æ•°æ®å·²æ¸…ç©º');
            updateRealtimeMonitor();
        }

        function updateRealtimeMonitor() {
            const monitorDiv = document.getElementById('realtime-monitor');
            const paginationContainer = document.getElementById('my-pagination');
            const countElement = document.getElementById('my-prompt-count');
            
            let status = `æ—¶é—´: ${new Date().toLocaleTimeString()}\n`;
            status += `åˆ†é¡µå®¹å™¨å†…å®¹: ${paginationContainer ? (paginationContainer.innerHTML ? 'æœ‰å†…å®¹' : 'ç©º') : 'ä¸å­˜åœ¨'}\n`;
            status += `æ•°é‡æ˜¾ç¤º: ${countElement ? countElement.textContent : 'æ— '}\n`;
            status += `å½“å‰ç”¨æˆ·: ${typeof authManager !== 'undefined' && authManager.isAuthenticated() ? authManager.getCurrentUser()?.username || 'å·²ç™»å½•' : 'æœªç™»å½•'}\n`;
            
            monitorDiv.textContent = status;
        }

        let app;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('æˆ‘çš„ç©ºé—´ä¿®å¤éªŒè¯é¡µé¢åŠ è½½å®Œæˆ');

            // åˆå§‹åŒ–åº”ç”¨
            if (typeof App !== 'undefined') {
                app = new App();
                app.init().then(() => {
                    console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
                    setTimeout(() => {
                        checkUserSwitchFix();
                        checkPaginationFix();
                        updateRealtimeMonitor();
                    }, 500);
                }).catch(error => {
                    console.error('âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                    setTimeout(() => {
                        checkUserSwitchFix();
                        checkPaginationFix();
                        updateRealtimeMonitor();
                    }, 1000);
                });
            } else {
                console.log('Appç±»ä¸å¯ç”¨ï¼Œå»¶è¿Ÿæ£€æŸ¥');
                setTimeout(() => {
                    checkUserSwitchFix();
                    checkPaginationFix();
                    updateRealtimeMonitor();
                }, 2000);
            }

            // å®šæœŸæ›´æ–°ç›‘æ§
            setInterval(updateRealtimeMonitor, 5000);
        });
    </script>
</body>
</html>
