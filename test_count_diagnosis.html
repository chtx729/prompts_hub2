<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¡æ•°é—®é¢˜è¯Šæ–­</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--background-color);
        }
        .test-container {
            background: var(--surface-color);
            padding: 2rem;
            border-radius: var(--radius-xl);
            margin-bottom: 2rem;
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
        }
        .test-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: 0.5rem;
        }
        .test-button:hover {
            background: var(--primary-hover);
        }
        .count-display {
            background: var(--info-50);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            border: 1px solid var(--info-200);
            font-family: monospace;
            font-size: 1rem;
        }
        .log-output {
            background: var(--gray-900);
            color: var(--gray-100);
            padding: 1rem;
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 1rem 0;
        }
        .warning {
            background: var(--warning-50);
            color: var(--warning-700);
            padding: 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--warning-200);
            margin: 1rem 0;
        }
        .success {
            color: var(--success-600);
            font-weight: bold;
        }
        .error {
            color: var(--error-600);
            font-weight: bold;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/api.js"></script>
    <script src="js/prompts.js"></script>
    <script src="js/myspace.js"></script>
    <script src="js/main.js"></script>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ” è®¡æ•°é—®é¢˜è¯Šæ–­</h1>
        <p>è¯Šæ–­æ˜¯å¦æœ‰æ•°æ®åº“è§¦å‘å™¨æˆ–å…¶ä»–æœºåˆ¶åœ¨è‡ªåŠ¨æ›´æ–°è®¡æ•°</p>
        
        <div class="warning">
            <strong>âš ï¸ æ³¨æ„</strong>ï¼šå½“å‰ä»£ç å·²ä¸´æ—¶ç¦ç”¨æ‰‹åŠ¨è®¡æ•°æ›´æ–°ï¼Œåªæ“ä½œuser_likesè¡¨ã€‚
            å¦‚æœlike_countä»ç„¶å˜åŒ–ï¼Œè¯´æ˜æœ‰æ•°æ®åº“è§¦å‘å™¨æˆ–å…¶ä»–è‡ªåŠ¨æœºåˆ¶åœ¨å·¥ä½œã€‚
        </div>
    </div>

    <div class="test-container">
        <div class="test-section">
            <h3>æµ‹è¯•è®¾ç½®</h3>
            <label for="test-prompt-id">æµ‹è¯•æç¤ºè¯ID:</label>
            <input type="number" id="test-prompt-id" value="1" min="1" style="margin: 0 1rem; padding: 0.5rem;">
            <button class="test-button" onclick="selectPrompt()">é€‰æ‹©</button>
            <button class="test-button" onclick="resetCounts()">é‡ç½®è®¡æ•°</button>
        </div>

        <div class="test-section">
            <h3>å½“å‰çŠ¶æ€</h3>
            <div id="count-display" class="count-display">
                æç¤ºè¯ID: <span id="current-prompt-id">1</span><br>
                user_likesè®°å½•æ•°: <span id="user-likes-count">-</span><br>
                prompts.like_count: <span id="prompts-like-count">-</span><br>
                <br>
                <strong>è¯Šæ–­ç»“æœ:</strong><br>
                <span id="diagnosis-result">ç­‰å¾…æµ‹è¯•...</span>
            </div>
            <button class="test-button" onclick="checkCounts()">åˆ·æ–°çŠ¶æ€</button>
        </div>

        <div class="test-section">
            <h3>è¯Šæ–­æµ‹è¯•</h3>
            <p>è¿™äº›æµ‹è¯•åªæ“ä½œuser_likesè¡¨ï¼Œä¸æ‰‹åŠ¨æ›´æ–°like_count</p>
            <button class="test-button" onclick="testLikeOperation()">æ‰§è¡Œç‚¹èµæ“ä½œ</button>
            <button class="test-button" onclick="testDirectInsert()">ç›´æ¥æ’å…¥è®°å½•</button>
            <button class="test-button" onclick="testDirectDelete()">ç›´æ¥åˆ é™¤è®°å½•</button>
        </div>

        <div class="test-section">
            <h3>æ•°æ®åº“æ£€æŸ¥</h3>
            <button class="test-button" onclick="checkTriggers()">æ£€æŸ¥è§¦å‘å™¨</button>
            <button class="test-button" onclick="checkFunctions()">æ£€æŸ¥RPCå‡½æ•°</button>
            <button class="test-button" onclick="manualCountUpdate()">æ‰‹åŠ¨æ›´æ–°è®¡æ•°</button>
        </div>

        <div class="test-section">
            <h3>æ“ä½œæ—¥å¿—</h3>
            <button class="test-button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="operation-log" class="log-output">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script>
        let logElement;
        let currentPromptId = 1;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (logElement) {
                logElement.innerHTML += `<span class="${className}">${logMessage}</span>`;
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(logMessage);
        }

        function selectPrompt() {
            const input = document.getElementById('test-prompt-id');
            currentPromptId = parseInt(input.value) || 1;
            document.getElementById('current-prompt-id').textContent = currentPromptId;
            log(`é€‰æ‹©æµ‹è¯•æç¤ºè¯ID: ${currentPromptId}`);
            checkCounts();
        }

        async function checkCounts() {
            log('æ£€æŸ¥å½“å‰è®¡æ•°çŠ¶æ€...');
            
            try {
                // æŸ¥è¯¢user_likesè¡¨è®°å½•æ•°
                const { data: likesData, error: likesError } = await supabase
                    .from('user_likes')
                    .select('like_id', { count: 'exact' })
                    .eq('prompt_id', currentPromptId);

                if (likesError) throw likesError;

                const userLikesCount = likesData ? likesData.length : 0;
                document.getElementById('user-likes-count').textContent = userLikesCount;

                // æŸ¥è¯¢promptsè¡¨like_count
                const { data: promptData, error: promptError } = await supabase
                    .from('prompts')
                    .select('like_count')
                    .eq('prompt_id', currentPromptId)
                    .single();

                if (promptError) throw promptError;

                const promptsLikeCount = promptData ? (promptData.like_count || 0) : 0;
                document.getElementById('prompts-like-count').textContent = promptsLikeCount;

                // è¯Šæ–­ç»“æœ
                const diagnosisElement = document.getElementById('diagnosis-result');
                if (userLikesCount === promptsLikeCount) {
                    diagnosisElement.innerHTML = '<span class="success">âœ… æ•°æ®ä¸€è‡´</span>';
                } else {
                    diagnosisElement.innerHTML = `<span class="error">âŒ æ•°æ®ä¸ä¸€è‡´<br>å·®å¼‚: ${promptsLikeCount - userLikesCount}</span>`;
                }

                log(`å½“å‰çŠ¶æ€: user_likes=${userLikesCount}, like_count=${promptsLikeCount}`);

            } catch (error) {
                log(`æ£€æŸ¥è®¡æ•°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testLikeOperation() {
            log('=== æµ‹è¯•ç‚¹èµæ“ä½œï¼ˆä¸æ‰‹åŠ¨æ›´æ–°è®¡æ•°ï¼‰===');
            
            try {
                // è®°å½•æ“ä½œå‰çŠ¶æ€
                await checkCounts();
                const beforeUserLikes = parseInt(document.getElementById('user-likes-count').textContent);
                const beforePromptsCount = parseInt(document.getElementById('prompts-like-count').textContent);
                
                log(`æ“ä½œå‰: user_likes=${beforeUserLikes}, like_count=${beforePromptsCount}`);

                // æ‰§è¡Œç‚¹èµæ“ä½œï¼ˆå½“å‰ä»£ç ä¸ä¼šæ‰‹åŠ¨æ›´æ–°è®¡æ•°ï¼‰
                const result = await apiManager.toggleLike(currentPromptId);
                log(`ç‚¹èµæ“ä½œç»“æœ: ${JSON.stringify(result)}`);

                // ç­‰å¾…ä¸€ä¸‹
                await new Promise(resolve => setTimeout(resolve, 1000));

                // æ£€æŸ¥æ“ä½œåçŠ¶æ€
                await checkCounts();
                const afterUserLikes = parseInt(document.getElementById('user-likes-count').textContent);
                const afterPromptsCount = parseInt(document.getElementById('prompts-like-count').textContent);
                
                log(`æ“ä½œå: user_likes=${afterUserLikes}, like_count=${afterPromptsCount}`);

                // åˆ†æå˜åŒ–
                const userLikesChange = afterUserLikes - beforeUserLikes;
                const promptsCountChange = afterPromptsCount - beforePromptsCount;

                log(`å˜åŒ–åˆ†æ: user_likeså˜åŒ–${userLikesChange}, like_countå˜åŒ–${promptsCountChange}`);

                if (promptsCountChange === 0) {
                    log('âœ… like_countæ²¡æœ‰å˜åŒ–ï¼Œè¯´æ˜æ²¡æœ‰è‡ªåŠ¨æ›´æ–°æœºåˆ¶', 'success');
                } else {
                    log(`âŒ like_countå˜åŒ–äº†${promptsCountChange}ï¼Œè¯´æ˜æœ‰è‡ªåŠ¨æ›´æ–°æœºåˆ¶åœ¨å·¥ä½œï¼`, 'error');
                }

            } catch (error) {
                log(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testDirectInsert() {
            log('=== ç›´æ¥æ’å…¥user_likesè®°å½• ===');
            
            try {
                await checkCounts();
                const beforeCount = parseInt(document.getElementById('prompts-like-count').textContent);

                // è·å–åŒ¿åç”¨æˆ·ID
                const anonymousId = apiManager.getOrCreateAnonymousUserId();
                
                // ç›´æ¥æ’å…¥è®°å½•
                const { error } = await supabase
                    .from('user_likes')
                    .insert([{ user_id: anonymousId, prompt_id: currentPromptId }]);

                if (error) {
                    log(`æ’å…¥å¤±è´¥: ${error.message}`, 'error');
                    return;
                }

                log('ç›´æ¥æ’å…¥user_likesè®°å½•æˆåŠŸ');

                // æ£€æŸ¥like_countæ˜¯å¦å˜åŒ–
                await new Promise(resolve => setTimeout(resolve, 500));
                await checkCounts();
                const afterCount = parseInt(document.getElementById('prompts-like-count').textContent);

                if (afterCount > beforeCount) {
                    log(`âŒ æ£€æµ‹åˆ°è§¦å‘å™¨ï¼like_countä»${beforeCount}å˜ä¸º${afterCount}`, 'error');
                } else {
                    log(`âœ… æ²¡æœ‰è§¦å‘å™¨ï¼Œlike_countä¿æŒ${beforeCount}`, 'success');
                }

            } catch (error) {
                log(`ç›´æ¥æ’å…¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testDirectDelete() {
            log('=== ç›´æ¥åˆ é™¤user_likesè®°å½• ===');
            
            try {
                await checkCounts();
                const beforeCount = parseInt(document.getElementById('prompts-like-count').textContent);

                // è·å–åŒ¿åç”¨æˆ·ID
                const anonymousId = apiManager.getOrCreateAnonymousUserId();
                
                // ç›´æ¥åˆ é™¤è®°å½•
                const { error } = await supabase
                    .from('user_likes')
                    .delete()
                    .eq('user_id', anonymousId)
                    .eq('prompt_id', currentPromptId);

                if (error) {
                    log(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
                    return;
                }

                log('ç›´æ¥åˆ é™¤user_likesè®°å½•æˆåŠŸ');

                // æ£€æŸ¥like_countæ˜¯å¦å˜åŒ–
                await new Promise(resolve => setTimeout(resolve, 500));
                await checkCounts();
                const afterCount = parseInt(document.getElementById('prompts-like-count').textContent);

                if (afterCount < beforeCount) {
                    log(`âŒ æ£€æµ‹åˆ°è§¦å‘å™¨ï¼like_countä»${beforeCount}å˜ä¸º${afterCount}`, 'error');
                } else {
                    log(`âœ… æ²¡æœ‰è§¦å‘å™¨ï¼Œlike_countä¿æŒ${beforeCount}`, 'success');
                }

            } catch (error) {
                log(`ç›´æ¥åˆ é™¤æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkTriggers() {
            log('=== æ£€æŸ¥æ•°æ®åº“è§¦å‘å™¨ ===');
            
            try {
                const { data, error } = await supabase.rpc('check_triggers_on_user_likes');
                
                if (error) {
                    log('æ— æ³•æ£€æŸ¥è§¦å‘å™¨ï¼ˆå¯èƒ½éœ€è¦åˆ›å»ºæ£€æŸ¥å‡½æ•°ï¼‰');
                    log('è¯·åœ¨Supabase SQLç¼–è¾‘å™¨ä¸­è¿è¡Œ: check_triggers.sql');
                } else {
                    log(`è§¦å‘å™¨æ£€æŸ¥ç»“æœ: ${JSON.stringify(data)}`);
                }

            } catch (error) {
                log(`æ£€æŸ¥è§¦å‘å™¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkFunctions() {
            log('=== æ£€æŸ¥RPCå‡½æ•° ===');
            
            try {
                // æµ‹è¯•æ˜¯å¦å­˜åœ¨è®¡æ•°æ›´æ–°å‡½æ•°
                const { data, error } = await supabase.rpc('update_prompt_like_count', {
                    prompt_id: currentPromptId,
                    increment_value: 0
                });

                if (error) {
                    if (error.code === '42883') {
                        log('âœ… update_prompt_like_countå‡½æ•°ä¸å­˜åœ¨', 'success');
                    } else {
                        log(`RPCå‡½æ•°é”™è¯¯: ${error.message}`, 'error');
                    }
                } else {
                    log('âŒ update_prompt_like_countå‡½æ•°å­˜åœ¨å¹¶å¯æ‰§è¡Œ', 'error');
                }

            } catch (error) {
                log(`æ£€æŸ¥RPCå‡½æ•°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function manualCountUpdate() {
            log('=== æ‰‹åŠ¨æ›´æ–°è®¡æ•°æµ‹è¯• ===');
            
            try {
                const result = await apiManager.updatePromptLikeCountSimple(currentPromptId, 1);
                log(`æ‰‹åŠ¨æ›´æ–°ç»“æœ: ${JSON.stringify(result)}`);
                
                await checkCounts();

            } catch (error) {
                log(`æ‰‹åŠ¨æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function resetCounts() {
            log('=== é‡ç½®è®¡æ•° ===');
            
            try {
                // åˆ é™¤æ‰€æœ‰ç‚¹èµè®°å½•
                const { error: deleteError } = await supabase
                    .from('user_likes')
                    .delete()
                    .eq('prompt_id', currentPromptId);

                if (deleteError) throw deleteError;

                // é‡ç½®è®¡æ•°
                const { error: updateError } = await supabase
                    .from('prompts')
                    .update({ like_count: 0 })
                    .eq('prompt_id', currentPromptId);

                if (updateError) throw updateError;

                log(`âœ… æç¤ºè¯${currentPromptId}çš„è®¡æ•°å·²é‡ç½®`, 'success');
                await checkCounts();

            } catch (error) {
                log(`é‡ç½®è®¡æ•°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            if (logElement) {
                logElement.innerHTML = '';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('è®¡æ•°é—®é¢˜è¯Šæ–­é¡µé¢åŠ è½½å®Œæˆ');
            
            logElement = document.getElementById('operation-log');
            
            setTimeout(() => {
                log('è¯Šæ–­é¡µé¢åˆå§‹åŒ–å®Œæˆ');
                log('å½“å‰ä»£ç å·²ç¦ç”¨æ‰‹åŠ¨è®¡æ•°æ›´æ–°ï¼Œåªæ“ä½œuser_likesè¡¨');
                selectPrompt();
            }, 1000);
        });
    </script>
</body>
</html>
