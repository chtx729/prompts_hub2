<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç±»æ˜¾ç¤ºç®€å•æµ‹è¯• - AIæç¤ºè¯å®åº“</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f8fafc;
        }
        .test-result {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { background: #f0fdf4; border: 1px solid #22c55e; color: #166534; }
        .error { background: #fef2f2; border: 1px solid #ef4444; color: #dc2626; }
        .warning { background: #fffbeb; border: 1px solid #f59e0b; color: #d97706; }
        .info { background: #f0f9ff; border: 1px solid #3b82f6; color: #1d4ed8; }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #4338ca; }
        h2 { color: #1f2937; margin-top: 2rem; }
        h3 { color: #374151; }
        .prompt-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            background: white;
        }
        .prompt-card-category {
            background: #4f46e5;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
</head>
<body>
    <h1>ğŸ”§ åˆ†ç±»æ˜¾ç¤ºç®€å•æµ‹è¯•</h1>
    <p>æ­¤å·¥å…·ç”¨äºæµ‹è¯•ä¿®å¤åçš„åˆ†ç±»æ˜¾ç¤ºåŠŸèƒ½ã€‚</p>

    <div class="test-section">
        <h3>ğŸ” åŸºç¡€æŸ¥è¯¢æµ‹è¯•</h3>
        <button onclick="testBasicQuery()">æµ‹è¯•åŸºç¡€æŸ¥è¯¢</button>
        <button onclick="testCategoriesQuery()">æµ‹è¯•åˆ†ç±»æŸ¥è¯¢</button>
        <div id="basic-results"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ  é¦–é¡µæŸ¥è¯¢æµ‹è¯•</h3>
        <button onclick="testHomeQuery()">æµ‹è¯•é¦–é¡µæŸ¥è¯¢</button>
        <div id="home-results"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ‘¤ æˆ‘çš„ç©ºé—´æŸ¥è¯¢æµ‹è¯•</h3>
        <button onclick="testMySpaceQuery()">æµ‹è¯•æˆ‘çš„ç©ºé—´æŸ¥è¯¢</button>
        <div id="myspace-results"></div>
    </div>

    <script>
        function addResult(containerId, type, title, content) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${title}</strong>\n${content}`;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function testBasicQuery() {
            clearResults('basic-results');
            
            try {
                addResult('basic-results', 'info', 'æµ‹è¯•åŸºç¡€æç¤ºè¯æŸ¥è¯¢', 'æ‰§è¡Œç®€å•çš„æç¤ºè¯æŸ¥è¯¢...');

                const { data, error } = await supabase
                    .from('prompts')
                    .select('*')
                    .limit(3);

                if (error) {
                    addResult('basic-results', 'error', 'åŸºç¡€æŸ¥è¯¢å¤±è´¥', error.message);
                    return;
                }

                addResult('basic-results', 'success', 'åŸºç¡€æŸ¥è¯¢æˆåŠŸ', `æ‰¾åˆ° ${data.length} æ¡è®°å½•`);
                
                if (data.length > 0) {
                    const sample = data[0];
                    const info = `
ç¤ºä¾‹æ•°æ®:
- prompt_id: ${sample.prompt_id}
- title: ${sample.title}
- category_id: ${sample.category_id}
- category_name: ${sample.category_name || 'NULL'}
                    `;
                    addResult('basic-results', 'info', 'æ•°æ®ç»“æ„', info);
                }

            } catch (error) {
                addResult('basic-results', 'error', 'æµ‹è¯•å¤±è´¥', error.message);
            }
        }

        async function testCategoriesQuery() {
            clearResults('basic-results');
            
            try {
                addResult('basic-results', 'info', 'æµ‹è¯•åˆ†ç±»æŸ¥è¯¢', 'æŸ¥è¯¢åˆ†ç±»è¡¨æ•°æ®...');

                const { data, error } = await supabase
                    .from('categories')
                    .select('*')
                    .limit(5);

                if (error) {
                    addResult('basic-results', 'error', 'åˆ†ç±»æŸ¥è¯¢å¤±è´¥', error.message);
                    return;
                }

                addResult('basic-results', 'success', 'åˆ†ç±»æŸ¥è¯¢æˆåŠŸ', `æ‰¾åˆ° ${data.length} æ¡åˆ†ç±»`);
                
                const categoryList = data.map(cat => 
                    `${cat.category_id}: ${cat.name} (${cat.slug})`
                ).join('\n');
                
                addResult('basic-results', 'info', 'åˆ†ç±»åˆ—è¡¨', categoryList);

            } catch (error) {
                addResult('basic-results', 'error', 'æµ‹è¯•å¤±è´¥', error.message);
            }
        }

        async function testHomeQuery() {
            clearResults('home-results');
            
            try {
                addResult('home-results', 'info', 'æµ‹è¯•é¦–é¡µæŸ¥è¯¢', 'ä½¿ç”¨ä¿®å¤åçš„APIæŸ¥è¯¢...');

                const result = await apiManager.getPrompts({
                    page: 1,
                    pageSize: 3
                });

                if (result.success) {
                    addResult('home-results', 'success', 'é¦–é¡µæŸ¥è¯¢æˆåŠŸ', `æ‰¾åˆ° ${result.data.length} æ¡è®°å½•`);
                    
                    // æ£€æŸ¥åˆ†ç±»ä¿¡æ¯
                    const categoryInfo = result.data.map(prompt => {
                        const categoryName = prompt.categories?.name || prompt.category_name || 'æœªåˆ†ç±»';
                        return `${prompt.title}: ${categoryName}`;
                    }).join('\n');
                    
                    addResult('home-results', 'info', 'åˆ†ç±»æ˜¾ç¤ºæ£€æŸ¥', categoryInfo);
                    
                    // æ˜¾ç¤ºè¯¦ç»†æ•°æ®ç»“æ„
                    if (result.data.length > 0) {
                        const sample = result.data[0];
                        const structure = `
æ•°æ®ç»“æ„ç¤ºä¾‹:
{
  prompt_id: ${sample.prompt_id}
  title: "${sample.title}"
  category_id: ${sample.category_id}
  category_name: "${sample.category_name || 'NULL'}"
  categories: ${JSON.stringify(sample.categories, null, 2)}
}
                        `;
                        addResult('home-results', 'info', 'æ•°æ®ç»“æ„', structure);
                    }
                } else {
                    addResult('home-results', 'error', 'é¦–é¡µæŸ¥è¯¢å¤±è´¥', result.error);
                }

            } catch (error) {
                addResult('home-results', 'error', 'æµ‹è¯•å¤±è´¥', error.message);
            }
        }

        async function testMySpaceQuery() {
            clearResults('myspace-results');
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    addResult('myspace-results', 'warning', 'éœ€è¦ç™»å½•', 'è¯·å…ˆç™»å½•ä»¥æµ‹è¯•æˆ‘çš„ç©ºé—´æŸ¥è¯¢');
                    return;
                }

                const userId = session.user.id;
                addResult('myspace-results', 'info', 'æµ‹è¯•æˆ‘çš„ç©ºé—´æŸ¥è¯¢', `ç”¨æˆ·ID: ${userId}`);

                const result = await apiManager.getPrompts({
                    page: 1,
                    pageSize: 5,
                    userId: userId
                });

                if (result.success) {
                    addResult('myspace-results', 'success', 'æˆ‘çš„ç©ºé—´æŸ¥è¯¢æˆåŠŸ', `æ‰¾åˆ° ${result.data.length} æ¡è®°å½•`);
                    
                    if (result.data.length === 0) {
                        addResult('myspace-results', 'warning', 'æ²¡æœ‰æ•°æ®', 'å½“å‰ç”¨æˆ·æ²¡æœ‰åˆ›å»ºä»»ä½•æç¤ºè¯');
                        return;
                    }
                    
                    // æ£€æŸ¥åˆ†ç±»ä¿¡æ¯
                    const categoryInfo = result.data.map(prompt => {
                        const categoryName = prompt.categories?.name || prompt.category_name || 'æœªåˆ†ç±»';
                        return `${prompt.title}: ${categoryName}`;
                    }).join('\n');
                    
                    addResult('myspace-results', 'info', 'åˆ†ç±»æ˜¾ç¤ºæ£€æŸ¥', categoryInfo);
                    
                    // æ˜¾ç¤ºè¯¦ç»†æ•°æ®ç»“æ„
                    const sample = result.data[0];
                    const structure = `
æ•°æ®ç»“æ„ç¤ºä¾‹:
{
  prompt_id: ${sample.prompt_id}
  title: "${sample.title}"
  category_id: ${sample.category_id}
  category_name: "${sample.category_name || 'NULL'}"
  categories: ${JSON.stringify(sample.categories, null, 2)}
}
                    `;
                    addResult('myspace-results', 'info', 'æ•°æ®ç»“æ„', structure);
                } else {
                    addResult('myspace-results', 'error', 'æˆ‘çš„ç©ºé—´æŸ¥è¯¢å¤±è´¥', result.error);
                }

            } catch (error) {
                addResult('myspace-results', 'error', 'æµ‹è¯•å¤±è´¥', error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(() => {
                testBasicQuery();
            }, 1000);
        });
    </script>
</body>
</html>
