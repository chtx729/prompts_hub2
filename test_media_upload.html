<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åª’ä½“ä¸Šä¼ åŠŸèƒ½æµ‹è¯• - AIæç¤ºè¯å®åº“</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
            background: var(--background-color);
        }
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            background: var(--surface-color);
        }
        .test-result {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #f0fdf4; border: 1px solid #22c55e; color: #166534; }
        .error { background: #fef2f2; border: 1px solid #ef4444; color: #dc2626; }
        .warning { background: #fffbeb; border: 1px solid #f59e0b; color: #d97706; }
        .info { background: #f0f9ff; border: 1px solid #3b82f6; color: #1d4ed8; }
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: var(--space-2);
            transition: var(--transition-fast);
        }
        button:hover { 
            background: var(--primary-hover);
            transform: translateY(-1px);
        }
        h2 { color: var(--text-primary); margin-top: 2rem; }
        h3 { color: var(--text-primary); }
        .demo-form {
            max-width: 600px;
            margin: 0 auto;
        }
        .storage-info {
            background: var(--gray-50);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin: var(--space-3) 0;
        }
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
        }
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-2);
            margin: var(--space-1) 0;
            background: white;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }
        .file-preview {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
</head>
<body>
    <h1>ğŸ“¸ åª’ä½“ä¸Šä¼ åŠŸèƒ½æµ‹è¯•</h1>
    <p>æ­¤å·¥å…·ç”¨äºæµ‹è¯•æç¤ºè¯å‚è€ƒå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ã€‚</p>

    <div class="test-section">
        <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
        <div>
            <strong>ç™»å½•çŠ¶æ€ï¼š</strong>
            <span id="login-status">æ£€æŸ¥ä¸­...</span>
        </div>
        <div style="margin-top: var(--space-2);">
            <strong>Storageè¿æ¥ï¼š</strong>
            <span id="storage-status">æ£€æŸ¥ä¸­...</span>
        </div>
        <div style="margin-top: var(--space-2);">
            <strong>Mediaå­˜å‚¨æ¡¶ï¼š</strong>
            <span id="bucket-status">æ£€æŸ¥ä¸­...</span>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ§ª ä¸Šä¼ åŠŸèƒ½æµ‹è¯•</h3>
        <div class="demo-form">
            <div class="form-group">
                <label for="test-media">æµ‹è¯•å›¾ç‰‡ä¸Šä¼ </label>
                <div class="media-upload-container">
                    <div class="media-upload-area" id="test-upload-area">
                        <div class="upload-placeholder">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
                            <p class="upload-hint">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤§ 5MB</p>
                        </div>
                        <input type="file" id="test-media" accept="image/*" style="display: none;">
                    </div>
                    <div class="media-preview-container" id="test-preview-container" style="display: none;">
                        <div class="media-preview">
                            <img id="test-preview-img" src="" alt="é¢„è§ˆå›¾ç‰‡">
                            <div class="media-actions">
                                <button type="button" class="btn btn-sm btn-outline" onclick="changeTestMedia()">
                                    <i class="fas fa-edit"></i>
                                    æ›´æ¢
                                </button>
                                <button type="button" class="btn btn-sm btn-outline btn-danger" onclick="removeTestMedia()">
                                    <i class="fas fa-trash"></i>
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="testUpload()">æµ‹è¯•ä¸Šä¼ </button>
            <button onclick="clearTestResults()">æ¸…ç©ºç»“æœ</button>
        </div>
        <div id="upload-test-results"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“ Storageç®¡ç†</h3>
        <button onclick="listStorageFiles()">æŸ¥çœ‹å­˜å‚¨æ–‡ä»¶</button>
        <button onclick="checkStorageQuota()">æ£€æŸ¥å­˜å‚¨é…é¢</button>
        <button onclick="cleanupTestFiles()">æ¸…ç†æµ‹è¯•æ–‡ä»¶</button>
        <div id="storage-results"></div>
        <div id="file-list" class="file-list" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ”— URLæµ‹è¯•</h3>
        <button onclick="testPublicUrls()">æµ‹è¯•å…¬å…±URL</button>
        <div id="url-test-results"></div>
    </div>

    <script>
        let currentTestFile = null;
        let uploadedTestUrl = null;

        function addResult(containerId, type, title, content) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${title}</strong>\n${content}`;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function clearTestResults() {
            clearResults('upload-test-results');
        }

        function updateStatus() {
            const loginStatus = document.getElementById('login-status');
            const storageStatus = document.getElementById('storage-status');
            const bucketStatus = document.getElementById('bucket-status');
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (window.authManager && authManager.isAuthenticated()) {
                loginStatus.textContent = 'å·²ç™»å½•';
                loginStatus.style.color = 'var(--success-color)';
            } else {
                loginStatus.textContent = 'æœªç™»å½•';
                loginStatus.style.color = 'var(--error-color)';
            }
            
            // æ£€æŸ¥Storageè¿æ¥
            if (window.supabase) {
                storageStatus.textContent = 'å·²è¿æ¥';
                storageStatus.style.color = 'var(--success-color)';
            } else {
                storageStatus.textContent = 'æœªè¿æ¥';
                storageStatus.style.color = 'var(--error-color)';
            }
            
            // æ£€æŸ¥Mediaå­˜å‚¨æ¡¶
            checkBucketStatus();
        }

        async function checkBucketStatus() {
            const bucketStatus = document.getElementById('bucket-status');
            
            try {
                const { data, error } = await supabase.storage.getBucket('media');
                
                if (error) {
                    bucketStatus.textContent = 'ä¸å­˜åœ¨æˆ–æ— æƒé™';
                    bucketStatus.style.color = 'var(--error-color)';
                } else {
                    bucketStatus.textContent = 'å¯è®¿é—®';
                    bucketStatus.style.color = 'var(--success-color)';
                }
            } catch (error) {
                bucketStatus.textContent = 'æ£€æŸ¥å¤±è´¥';
                bucketStatus.style.color = 'var(--error-color)';
            }
        }

        // ç»‘å®šæµ‹è¯•ä¸Šä¼ äº‹ä»¶
        function bindTestUploadEvents() {
            const uploadArea = document.getElementById('test-upload-area');
            const fileInput = document.getElementById('test-media');

            if (!uploadArea || !fileInput) return;

            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleTestFile(file);
                }
            });

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleTestFile(files[0]);
                }
            });
        }

        function handleTestFile(file) {
            if (!file.type.startsWith('image/')) {
                addResult('upload-test-results', 'warning', 'æ–‡ä»¶ç±»å‹é”™è¯¯', 'è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                addResult('upload-test-results', 'warning', 'æ–‡ä»¶è¿‡å¤§', 'å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB');
                return;
            }

            currentTestFile = file;
            showTestPreview(file);
            addResult('upload-test-results', 'success', 'æ–‡ä»¶é€‰æ‹©æˆåŠŸ', `æ–‡ä»¶å: ${file.name}\nå¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB\nç±»å‹: ${file.type}`);
        }

        function showTestPreview(file) {
            const uploadArea = document.getElementById('test-upload-area');
            const previewContainer = document.getElementById('test-preview-container');
            const previewImg = document.getElementById('test-preview-img');

            const previewUrl = URL.createObjectURL(file);
            previewImg.src = previewUrl;

            uploadArea.style.display = 'none';
            previewContainer.style.display = 'block';
        }

        function changeTestMedia() {
            const fileInput = document.getElementById('test-media');
            if (fileInput) {
                fileInput.click();
            }
        }

        function removeTestMedia() {
            const uploadArea = document.getElementById('test-upload-area');
            const previewContainer = document.getElementById('test-preview-container');
            const previewImg = document.getElementById('test-preview-img');
            const fileInput = document.getElementById('test-media');

            if (uploadArea) uploadArea.style.display = 'block';
            if (previewContainer) previewContainer.style.display = 'none';
            if (previewImg) {
                URL.revokeObjectURL(previewImg.src);
                previewImg.src = '';
            }
            if (fileInput) fileInput.value = '';

            currentTestFile = null;
            addResult('upload-test-results', 'info', 'æ–‡ä»¶å·²ç§»é™¤', 'å·²æ¸…ç©ºé€‰æ‹©çš„æ–‡ä»¶');
        }

        async function testUpload() {
            if (!currentTestFile) {
                addResult('upload-test-results', 'warning', 'æ²¡æœ‰æ–‡ä»¶', 'è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡');
                return;
            }

            if (!authManager.isAuthenticated()) {
                addResult('upload-test-results', 'error', 'æœªç™»å½•', 'è¯·å…ˆç™»å½•åå†æµ‹è¯•ä¸Šä¼ ');
                return;
            }

            try {
                addResult('upload-test-results', 'info', 'å¼€å§‹ä¸Šä¼ ', 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°Supabase Storage...');

                const fileExt = currentTestFile.name.split('.').pop();
                const fileName = `test_${Date.now()}_${Math.random().toString(36).substring(2)}.${fileExt}`;
                const filePath = `prompts/${fileName}`;

                const { data, error } = await supabase.storage
                    .from('media')
                    .upload(filePath, currentTestFile);

                if (error) {
                    throw error;
                }

                const { data: urlData } = supabase.storage
                    .from('media')
                    .getPublicUrl(filePath);

                uploadedTestUrl = urlData.publicUrl;

                addResult('upload-test-results', 'success', 'ä¸Šä¼ æˆåŠŸ', `æ–‡ä»¶è·¯å¾„: ${filePath}\nå…¬å…±URL: ${uploadedTestUrl}`);

                // æµ‹è¯•URLå¯è®¿é—®æ€§
                testImageUrl(uploadedTestUrl);

            } catch (error) {
                addResult('upload-test-results', 'error', 'ä¸Šä¼ å¤±è´¥', error.message);
            }
        }

        function testImageUrl(url) {
            const img = new Image();
            img.onload = () => {
                addResult('upload-test-results', 'success', 'URLæµ‹è¯•æˆåŠŸ', `å›¾ç‰‡å¯ä»¥æ­£å¸¸è®¿é—®\nå°ºå¯¸: ${img.width} x ${img.height}`);
            };
            img.onerror = () => {
                addResult('upload-test-results', 'error', 'URLæµ‹è¯•å¤±è´¥', 'å›¾ç‰‡æ— æ³•è®¿é—®ï¼Œå¯èƒ½æ˜¯æƒé™é—®é¢˜');
            };
            img.src = url;
        }

        async function listStorageFiles() {
            clearResults('storage-results');
            
            try {
                addResult('storage-results', 'info', 'æŸ¥è¯¢æ–‡ä»¶', 'æ­£åœ¨è·å–å­˜å‚¨æ–‡ä»¶åˆ—è¡¨...');

                const { data, error } = await supabase.storage
                    .from('media')
                    .list('prompts', {
                        limit: 50,
                        sortBy: { column: 'created_at', order: 'desc' }
                    });

                if (error) {
                    throw error;
                }

                addResult('storage-results', 'success', 'æŸ¥è¯¢æˆåŠŸ', `æ‰¾åˆ° ${data.length} ä¸ªæ–‡ä»¶`);

                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';
                fileList.style.display = 'block';

                data.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    const { data: urlData } = supabase.storage
                        .from('media')
                        .getPublicUrl(`prompts/${file.name}`);

                    fileItem.innerHTML = `
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            <img src="${urlData.publicUrl}" alt="${file.name}" class="file-preview" onerror="this.style.display='none'">
                            <div>
                                <div><strong>${file.name}</strong></div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    å¤§å°: ${(file.metadata?.size / 1024 / 1024).toFixed(2)} MB
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteFile('prompts/${file.name}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
                    `;
                    fileList.appendChild(fileItem);
                });

            } catch (error) {
                addResult('storage-results', 'error', 'æŸ¥è¯¢å¤±è´¥', error.message);
            }
        }

        async function deleteFile(filePath) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) return;

            try {
                const { error } = await supabase.storage
                    .from('media')
                    .remove([filePath]);

                if (error) {
                    throw error;
                }

                addResult('storage-results', 'success', 'åˆ é™¤æˆåŠŸ', `å·²åˆ é™¤æ–‡ä»¶: ${filePath}`);
                listStorageFiles(); // åˆ·æ–°åˆ—è¡¨

            } catch (error) {
                addResult('storage-results', 'error', 'åˆ é™¤å¤±è´¥', error.message);
            }
        }

        async function checkStorageQuota() {
            clearResults('storage-results');
            
            try {
                addResult('storage-results', 'info', 'æ£€æŸ¥é…é¢', 'æ­£åœ¨æ£€æŸ¥å­˜å‚¨é…é¢...');

                // è·å–æ‰€æœ‰æ–‡ä»¶
                const { data, error } = await supabase.storage
                    .from('media')
                    .list('', { limit: 1000 });

                if (error) {
                    throw error;
                }

                let totalSize = 0;
                let fileCount = 0;

                const calculateSize = async (prefix = '') => {
                    const { data: files } = await supabase.storage
                        .from('media')
                        .list(prefix);

                    for (const file of files) {
                        if (file.metadata?.size) {
                            totalSize += file.metadata.size;
                            fileCount++;
                        }
                    }
                };

                await calculateSize('prompts');

                addResult('storage-results', 'success', 'é…é¢æ£€æŸ¥å®Œæˆ', `
æ–‡ä»¶æ•°é‡: ${fileCount}
æ€»å¤§å°: ${(totalSize / 1024 / 1024).toFixed(2)} MB
å¹³å‡å¤§å°: ${fileCount > 0 ? (totalSize / fileCount / 1024).toFixed(2) : 0} KB
                `);

            } catch (error) {
                addResult('storage-results', 'error', 'æ£€æŸ¥å¤±è´¥', error.message);
            }
        }

        async function cleanupTestFiles() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æµ‹è¯•æ–‡ä»¶å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ä»¥"test_"å¼€å¤´çš„æ–‡ä»¶ã€‚')) return;

            try {
                addResult('storage-results', 'info', 'æ¸…ç†æ–‡ä»¶', 'æ­£åœ¨æ¸…ç†æµ‹è¯•æ–‡ä»¶...');

                const { data, error } = await supabase.storage
                    .from('media')
                    .list('prompts');

                if (error) {
                    throw error;
                }

                const testFiles = data.filter(file => file.name.startsWith('test_'));
                const filePaths = testFiles.map(file => `prompts/${file.name}`);

                if (filePaths.length === 0) {
                    addResult('storage-results', 'info', 'æ²¡æœ‰æµ‹è¯•æ–‡ä»¶', 'æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ¸…ç†çš„æµ‹è¯•æ–‡ä»¶');
                    return;
                }

                const { error: deleteError } = await supabase.storage
                    .from('media')
                    .remove(filePaths);

                if (deleteError) {
                    throw deleteError;
                }

                addResult('storage-results', 'success', 'æ¸…ç†å®Œæˆ', `å·²åˆ é™¤ ${filePaths.length} ä¸ªæµ‹è¯•æ–‡ä»¶`);

            } catch (error) {
                addResult('storage-results', 'error', 'æ¸…ç†å¤±è´¥', error.message);
            }
        }

        async function testPublicUrls() {
            clearResults('url-test-results');
            
            if (!uploadedTestUrl) {
                addResult('url-test-results', 'warning', 'æ²¡æœ‰æµ‹è¯•URL', 'è¯·å…ˆä¸Šä¼ ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶');
                return;
            }

            addResult('url-test-results', 'info', 'æµ‹è¯•URL', `æ­£åœ¨æµ‹è¯•: ${uploadedTestUrl}`);

            // æµ‹è¯•ç›´æ¥è®¿é—®
            try {
                const response = await fetch(uploadedTestUrl);
                if (response.ok) {
                    addResult('url-test-results', 'success', 'HTTPè®¿é—®æˆåŠŸ', `çŠ¶æ€ç : ${response.status}\nå†…å®¹ç±»å‹: ${response.headers.get('content-type')}`);
                } else {
                    addResult('url-test-results', 'error', 'HTTPè®¿é—®å¤±è´¥', `çŠ¶æ€ç : ${response.status}`);
                }
            } catch (error) {
                addResult('url-test-results', 'error', 'HTTPè®¿é—®å¼‚å¸¸', error.message);
            }

            // æµ‹è¯•å›¾ç‰‡åŠ è½½
            testImageUrl(uploadedTestUrl);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateStatus();
                bindTestUploadEvents();
                
                // å®šæœŸæ›´æ–°çŠ¶æ€
                setInterval(updateStatus, 10000);
            }, 1000);
        });
    </script>
</body>
</html>
