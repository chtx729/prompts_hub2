<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦–é¡µæ— è‡ªåŠ¨ç™»å½•æµ‹è¯•</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--background-color);
        }
        .test-container {
            background: var(--surface-color);
            padding: 2rem;
            border-radius: var(--radius-xl);
            margin-bottom: 2rem;
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
        }
        .test-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: 0.5rem;
        }
        .test-button:hover {
            background: var(--primary-hover);
        }
        .status-display {
            background: var(--info-50);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            border: 1px solid var(--info-200);
            font-family: monospace;
        }
        .log-output {
            background: var(--gray-900);
            color: var(--gray-100);
            padding: 1rem;
            border-radius: var(--radius-md);
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 1rem 0;
        }
        .success {
            color: var(--success-600);
            font-weight: bold;
        }
        .error {
            color: var(--error-600);
            font-weight: bold;
        }
        .warning {
            color: var(--warning-600);
            font-weight: bold;
        }
        .test-scenario {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/api.js"></script>
    <script src="js/prompts.js"></script>
    <script src="js/myspace.js"></script>
    <script src="js/main.js"></script>
</head>
<body>
    <div class="test-container">
        <h1>ğŸš« é¦–é¡µæ— è‡ªåŠ¨ç™»å½•æµ‹è¯•</h1>
        <p>éªŒè¯é¦–é¡µåŠ è½½æ—¶ä¸ä¼šè‡ªåŠ¨ç™»å½•ç”¨æˆ·</p>
    </div>

    <div class="test-container">
        <div class="test-section">
            <h3>ä¿®æ”¹è¯´æ˜</h3>
            <div class="test-scenario">
                <h4>é—®é¢˜ï¼š</h4>
                <p>é¦–é¡µåŠ è½½æ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶æ¢å¤ç”¨æˆ·ä¼šè¯ï¼Œå¯¼è‡´è‡ªåŠ¨ç™»å½•</p>
                
                <h4>ä¿®æ”¹ï¼š</h4>
                <p>1. âœ… ç¦ç”¨äº†é¡µé¢åŠ è½½æ—¶çš„è‡ªåŠ¨ä¼šè¯æ£€æŸ¥</p>
                <p>2. âœ… æ·»åŠ äº†æ‰‹åŠ¨ä¼šè¯æ¢å¤æ–¹æ³•</p>
                <p>3. âœ… ä¿æŒrequireAuthæ–¹æ³•ä¸ºåŒæ­¥</p>
                
                <h4>é¢„æœŸæ•ˆæœï¼š</h4>
                <p>é¦–é¡µåŠ è½½æ—¶å§‹ç»ˆæ˜¾ç¤ºæœªç™»å½•çŠ¶æ€ï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨ç‚¹å‡»ç™»å½•</p>
            </div>
        </div>

        <div class="test-section">
            <h3>å½“å‰è®¤è¯çŠ¶æ€</h3>
            <div id="auth-status" class="status-display">
                æ£€æŸ¥ä¸­...
            </div>
            <button class="test-button" onclick="checkAuthStatus()">åˆ·æ–°çŠ¶æ€</button>
            <button class="test-button" onclick="checkSupabaseSession()">æ£€æŸ¥Supabaseä¼šè¯</button>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•åœºæ™¯</h3>
            
            <div class="test-scenario">
                <h4>åœºæ™¯1ï¼šé¦–æ¬¡è®¿é—®</h4>
                <p>æ¸…ç©ºæ‰€æœ‰æ•°æ®åé¦–æ¬¡è®¿é—®ç½‘ç«™</p>
                <button class="test-button" onclick="testFirstVisit()">æ¨¡æ‹Ÿé¦–æ¬¡è®¿é—®</button>
            </div>

            <div class="test-scenario">
                <h4>åœºæ™¯2ï¼šæœ‰å†å²ä¼šè¯</h4>
                <p>æµè§ˆå™¨ä¸­æœ‰å†å²ç™»å½•ä¼šè¯çš„æƒ…å†µ</p>
                <button class="test-button" onclick="testWithHistorySession()">æ¨¡æ‹Ÿæœ‰å†å²ä¼šè¯</button>
            </div>

            <div class="test-scenario">
                <h4>åœºæ™¯3ï¼šæ‰‹åŠ¨ä¼šè¯æ¢å¤</h4>
                <p>æµ‹è¯•æ‰‹åŠ¨æ¢å¤ä¼šè¯åŠŸèƒ½</p>
                <button class="test-button" onclick="testManualSessionRestore()">æµ‹è¯•æ‰‹åŠ¨æ¢å¤</button>
            </div>
        </div>

        <div class="test-section">
            <h3>è®¤è¯ç®¡ç†å™¨æµ‹è¯•</h3>
            <button class="test-button" onclick="testAuthManagerInit()">æµ‹è¯•è®¤è¯ç®¡ç†å™¨åˆå§‹åŒ–</button>
            <button class="test-button" onclick="testSessionCheck()">æµ‹è¯•ä¼šè¯æ£€æŸ¥é€»è¾‘</button>
            <button class="test-button" onclick="goToMainPage()">å‰å¾€é¦–é¡µéªŒè¯</button>
        </div>

        <div class="test-section">
            <h3>æ“ä½œæ—¥å¿—</h3>
            <button class="test-button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="operation-log" class="log-output">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script>
        let logElement;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (logElement) {
                logElement.innerHTML += `<span class="${className}">${logMessage}</span>`;
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(logMessage);
        }

        function checkAuthStatus() {
            log('=== æ£€æŸ¥å½“å‰è®¤è¯çŠ¶æ€ ===');
            
            const statusDiv = document.getElementById('auth-status');
            let status = '';

            try {
                // æ£€æŸ¥è®¤è¯ç®¡ç†å™¨
                if (typeof authManager !== 'undefined') {
                    const isAuth = authManager.isAuthenticated();
                    const user = authManager.getCurrentUser();
                    const sessionChecked = authManager.sessionChecked;

                    status += `è®¤è¯çŠ¶æ€: ${isAuth ? 'âœ… å·²ç™»å½•' : 'âŒ æœªç™»å½•'}\n`;
                    status += `å½“å‰ç”¨æˆ·: ${user ? user.email || user.username : 'æ— '}\n`;
                    status += `ä¼šè¯å·²æ£€æŸ¥: ${sessionChecked ? 'æ˜¯' : 'å¦'}\n`;
                    status += `åˆå§‹åŒ–çŠ¶æ€: ${authManager.isInitialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}\n`;

                    log(`è®¤è¯çŠ¶æ€: ${isAuth ? 'å·²ç™»å½•' : 'æœªç™»å½•'}`, isAuth ? 'warning' : 'success');
                    log(`ç”¨æˆ·ä¿¡æ¯: ${user ? user.email || user.username : 'æ— '}`);

                } else {
                    status += `è®¤è¯ç®¡ç†å™¨: âŒ ä¸å¯ç”¨\n`;
                    log('âŒ è®¤è¯ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }

                // æ£€æŸ¥localStorage
                const localStorageKeys = Object.keys(localStorage);
                const authKeys = localStorageKeys.filter(key => 
                    key.includes('supabase') || key.includes('auth') || key.includes('session')
                );
                
                status += `\nLocalStorageè®¤è¯ç›¸å…³é”®:\n`;
                if (authKeys.length > 0) {
                    authKeys.forEach(key => {
                        status += `  ${key}\n`;
                    });
                } else {
                    status += `  æ— è®¤è¯ç›¸å…³æ•°æ®\n`;
                }

            } catch (error) {
                status += `æ£€æŸ¥å¤±è´¥: ${error.message}\n`;
                log(`âŒ çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }

            statusDiv.textContent = status;
        }

        async function checkSupabaseSession() {
            log('=== æ£€æŸ¥Supabaseä¼šè¯ ===');
            
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    log(`âŒ è·å–ä¼šè¯å¤±è´¥: ${error.message}`, 'error');
                    return;
                }

                if (session) {
                    log(`âš ï¸ å‘ç°Supabaseä¼šè¯:`, 'warning');
                    log(`  ç”¨æˆ·: ${session.user.email}`);
                    log(`  è¿‡æœŸæ—¶é—´: ${new Date(session.expires_at * 1000).toLocaleString()}`);
                    log(`  è®¿é—®ä»¤ç‰Œ: ${session.access_token.substring(0, 20)}...`);
                } else {
                    log(`âœ… æ²¡æœ‰Supabaseä¼šè¯`, 'success');
                }

            } catch (error) {
                log(`âŒ æ£€æŸ¥Supabaseä¼šè¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testFirstVisit() {
            log('=== æ¨¡æ‹Ÿé¦–æ¬¡è®¿é—®æµ‹è¯• ===');
            
            try {
                // æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®
                localStorage.clear();
                sessionStorage.clear();
                log('âœ… å·²æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®');

                // ç­‰å¾…ä¸€ä¸‹
                await new Promise(resolve => setTimeout(resolve, 500));

                // æ£€æŸ¥è®¤è¯çŠ¶æ€
                checkAuthStatus();

                // éªŒè¯æ˜¯å¦ä¸ºæœªç™»å½•çŠ¶æ€
                if (typeof authManager !== 'undefined') {
                    const isAuth = authManager.isAuthenticated();
                    if (!isAuth) {
                        log('âœ… é¦–æ¬¡è®¿é—®æµ‹è¯•é€šè¿‡ï¼šæ˜¾ç¤ºæœªç™»å½•çŠ¶æ€', 'success');
                    } else {
                        log('âŒ é¦–æ¬¡è®¿é—®æµ‹è¯•å¤±è´¥ï¼šä»æ˜¾ç¤ºå·²ç™»å½•çŠ¶æ€', 'error');
                    }
                }

            } catch (error) {
                log(`âŒ é¦–æ¬¡è®¿é—®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testWithHistorySession() {
            log('=== æ¨¡æ‹Ÿæœ‰å†å²ä¼šè¯æµ‹è¯• ===');
            
            try {
                // æ¨¡æ‹Ÿåˆ›å»ºä¸€ä¸ªå‡çš„ä¼šè¯æ•°æ®
                const fakeSession = {
                    access_token: 'fake_access_token_for_testing',
                    refresh_token: 'fake_refresh_token_for_testing',
                    expires_at: Math.floor(Date.now() / 1000) + 3600,
                    user: {
                        id: 'fake-user-id',
                        email: 'test@example.com'
                    }
                };

                // æ³¨æ„ï¼šè¿™åªæ˜¯æ¨¡æ‹Ÿï¼Œå®é™…çš„Supabaseä¼šè¯ç»“æ„æ›´å¤æ‚
                localStorage.setItem('sb-test-auth-token', JSON.stringify(fakeSession));
                log('âœ… å·²æ¨¡æ‹Ÿå†å²ä¼šè¯æ•°æ®');

                // é‡æ–°æ£€æŸ¥çŠ¶æ€
                checkAuthStatus();

                // éªŒè¯æ˜¯å¦ä»ä¸ºæœªç™»å½•çŠ¶æ€ï¼ˆå› ä¸ºæˆ‘ä»¬ç¦ç”¨äº†è‡ªåŠ¨æ¢å¤ï¼‰
                if (typeof authManager !== 'undefined') {
                    const isAuth = authManager.isAuthenticated();
                    if (!isAuth) {
                        log('âœ… æœ‰å†å²ä¼šè¯æµ‹è¯•é€šè¿‡ï¼šä¸ä¼šè‡ªåŠ¨ç™»å½•', 'success');
                    } else {
                        log('âŒ æœ‰å†å²ä¼šè¯æµ‹è¯•å¤±è´¥ï¼šè‡ªåŠ¨ç™»å½•äº†', 'error');
                    }
                }

            } catch (error) {
                log(`âŒ å†å²ä¼šè¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testManualSessionRestore() {
            log('=== æµ‹è¯•æ‰‹åŠ¨ä¼šè¯æ¢å¤ ===');
            
            try {
                if (typeof authManager !== 'undefined' && typeof authManager.checkAndRestoreSession === 'function') {
                    log('è°ƒç”¨æ‰‹åŠ¨ä¼šè¯æ¢å¤æ–¹æ³•...');
                    const restored = await authManager.checkAndRestoreSession();
                    
                    if (restored) {
                        log('âœ… ä¼šè¯æ¢å¤æˆåŠŸ', 'success');
                    } else {
                        log('â„¹ï¸ æ²¡æœ‰å¯æ¢å¤çš„ä¼šè¯');
                    }

                    checkAuthStatus();
                } else {
                    log('âŒ æ‰‹åŠ¨ä¼šè¯æ¢å¤æ–¹æ³•ä¸å¯ç”¨', 'error');
                }

            } catch (error) {
                log(`âŒ æ‰‹åŠ¨ä¼šè¯æ¢å¤æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testAuthManagerInit() {
            log('=== æµ‹è¯•è®¤è¯ç®¡ç†å™¨åˆå§‹åŒ– ===');
            
            try {
                if (typeof authManager !== 'undefined') {
                    log('âœ… è®¤è¯ç®¡ç†å™¨å¯ç”¨');
                    log(`åˆå§‹åŒ–çŠ¶æ€: ${authManager.isInitialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}`);
                    log(`ä¼šè¯æ£€æŸ¥çŠ¶æ€: ${authManager.sessionChecked ? 'å·²æ£€æŸ¥' : 'æœªæ£€æŸ¥'}`);
                    
                    // æ£€æŸ¥æ–¹æ³•å¯ç”¨æ€§
                    const methods = [
                        'isAuthenticated',
                        'getCurrentUser',
                        'checkAndRestoreSession',
                        'requireAuth'
                    ];

                    methods.forEach(method => {
                        const available = typeof authManager[method] === 'function';
                        log(`  ${method}: ${available ? 'âœ…' : 'âŒ'}`);
                    });

                } else {
                    log('âŒ è®¤è¯ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }

            } catch (error) {
                log(`âŒ è®¤è¯ç®¡ç†å™¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testSessionCheck() {
            log('=== æµ‹è¯•ä¼šè¯æ£€æŸ¥é€»è¾‘ ===');
            
            try {
                if (typeof authManager !== 'undefined') {
                    const sessionChecked = authManager.sessionChecked;
                    const isAuth = authManager.isAuthenticated();

                    log(`ä¼šè¯æ£€æŸ¥æ ‡å¿—: ${sessionChecked}`);
                    log(`å½“å‰è®¤è¯çŠ¶æ€: ${isAuth}`);

                    if (sessionChecked && !isAuth) {
                        log('âœ… ä¼šè¯æ£€æŸ¥é€»è¾‘æ­£ç¡®ï¼šå·²æ£€æŸ¥ä½†æœªè‡ªåŠ¨ç™»å½•', 'success');
                    } else if (!sessionChecked) {
                        log('âš ï¸ ä¼šè¯å°šæœªæ£€æŸ¥', 'warning');
                    } else if (isAuth) {
                        log('âŒ ä¼šè¯æ£€æŸ¥é€»è¾‘å¯èƒ½æœ‰é—®é¢˜ï¼šè‡ªåŠ¨ç™»å½•äº†', 'error');
                    }

                } else {
                    log('âŒ è®¤è¯ç®¡ç†å™¨ä¸å¯ç”¨', 'error');
                }

            } catch (error) {
                log(`âŒ ä¼šè¯æ£€æŸ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function goToMainPage() {
            log('è·³è½¬åˆ°é¦–é¡µè¿›è¡Œå®é™…éªŒè¯...');
            window.location.href = 'index.html';
        }

        function clearLog() {
            if (logElement) {
                logElement.innerHTML = '';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('é¦–é¡µæ— è‡ªåŠ¨ç™»å½•æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            logElement = document.getElementById('operation-log');
            
            setTimeout(() => {
                log('æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
                log('ä¿®æ”¹å†…å®¹ï¼šç¦ç”¨é¦–é¡µè‡ªåŠ¨ç™»å½•åŠŸèƒ½');
                checkAuthStatus();
            }, 1000);
        });
    </script>
</body>
</html>
