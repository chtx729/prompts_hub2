<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤´åƒå›é€€æœºåˆ¶æµ‹è¯• - AIæç¤ºè¯å®åº“</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
            background: var(--background-color);
        }
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            background: var(--surface-color);
        }
        .test-result {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #f0fdf4; border: 1px solid #22c55e; color: #166534; }
        .error { background: #fef2f2; border: 1px solid #ef4444; color: #dc2626; }
        .warning { background: #fffbeb; border: 1px solid #f59e0b; color: #d97706; }
        .info { background: #f0f9ff; border: 1px solid #3b82f6; color: #1d4ed8; }
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: var(--space-2);
            transition: var(--transition-fast);
        }
        button:hover { 
            background: var(--primary-hover);
            transform: translateY(-1px);
        }
        h2 { color: var(--text-primary); margin-top: 2rem; }
        h3 { color: var(--text-primary); }
        .avatar-test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            margin: var(--space-4) 0;
        }
        .avatar-test-item {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
        }
        .avatar-test-item img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
            margin-bottom: var(--space-2);
        }
        .avatar-status {
            font-size: 12px;
            margin-top: var(--space-2);
            padding: var(--space-1);
            border-radius: var(--radius-sm);
        }
        .status-loading { background: #fef3c7; color: #92400e; }
        .status-success { background: #dcfce7; color: #166534; }
        .status-error { background: #fecaca; color: #dc2626; }
        .config-display {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: var(--space-3) 0;
        }
        .url-list {
            background: var(--gray-50);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin: var(--space-3) 0;
        }
        .url-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-2);
            margin: var(--space-1) 0;
            background: white;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }
        .url-status {
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 600;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
</head>
<body>
    <h1>ğŸ”„ å¤´åƒå›é€€æœºåˆ¶æµ‹è¯•</h1>
    <p>æ­¤å·¥å…·ç”¨äºæµ‹è¯•æ–°çš„é»˜è®¤å¤´åƒå’Œå¤šé‡å›é€€æœºåˆ¶ã€‚</p>

    <div class="test-section">
        <h3>ğŸ“Š å½“å‰é…ç½®</h3>
        <div>
            <strong>ä¸»è¦é»˜è®¤å¤´åƒï¼š</strong>
            <span id="primary-avatar-url"></span>
        </div>
        <div style="margin-top: var(--space-2);">
            <strong>å¤‡ç”¨å¤´åƒæ•°é‡ï¼š</strong>
            <span id="fallback-count"></span>
        </div>
        <div style="margin-top: var(--space-2);">
            <strong>å›é€€æœºåˆ¶ï¼š</strong>
            <span id="fallback-enabled"></span>
        </div>
        
        <div class="config-display" id="config-display">
            åŠ è½½é…ç½®ä¸­...
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ§ª å¤´åƒæœåŠ¡å¯ç”¨æ€§æµ‹è¯•</h3>
        <button onclick="testAvatarServices()">æµ‹è¯•æ‰€æœ‰å¤´åƒæœåŠ¡</button>
        <button onclick="clearServiceTests()">æ¸…ç©ºæµ‹è¯•ç»“æœ</button>
        <div id="service-test-results"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ”„ å›é€€æœºåˆ¶æ¼”ç¤º</h3>
        <button onclick="testFallbackMechanism()">æµ‹è¯•å›é€€æœºåˆ¶</button>
        <button onclick="testWithDifferentUsers()">æµ‹è¯•ä¸åŒç”¨æˆ·å</button>
        <div id="fallback-test-results"></div>
        <div id="fallback-demo" class="avatar-test-grid"></div>
    </div>

    <div class="test-section">
        <h3>âš¡ å®æ—¶å¤´åƒåŠ è½½æµ‹è¯•</h3>
        <button onclick="testRealTimeLoading()">å®æ—¶åŠ è½½æµ‹è¯•</button>
        <div id="realtime-results"></div>
        <div id="realtime-demo" class="avatar-test-grid"></div>
    </div>

    <script>
        function addResult(containerId, type, title, content) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${title}</strong>\n${content}`;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function updateConfigDisplay() {
            document.getElementById('primary-avatar-url').textContent = APP_CONFIG.defaultAvatar;
            document.getElementById('fallback-count').textContent = APP_CONFIG.fallbackAvatars.length;
            document.getElementById('fallback-enabled').textContent = typeof APP_CONFIG.loadAvatarWithFallback === 'function' ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
            
            const configDisplay = document.getElementById('config-display');
            configDisplay.innerHTML = `
// å½“å‰å¤´åƒé…ç½®
defaultAvatar: "${APP_CONFIG.defaultAvatar}"

fallbackAvatars: [
${APP_CONFIG.fallbackAvatars.map(url => `    "${url}"`).join(',\n')}
]

loadAvatarWithFallback: ${typeof APP_CONFIG.loadAvatarWithFallback === 'function' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰'}
            `;
        }

        async function testAvatarServices() {
            clearResults('service-test-results');
            
            const allUrls = [
                { name: 'ä¸»è¦é»˜è®¤å¤´åƒ', url: APP_CONFIG.defaultAvatar },
                ...APP_CONFIG.fallbackAvatars.map((url, index) => ({ 
                    name: `å¤‡ç”¨å¤´åƒ ${index + 1}`, 
                    url: url 
                }))
            ];

            addResult('service-test-results', 'info', 'å¼€å§‹æµ‹è¯•', `æ­£åœ¨æµ‹è¯• ${allUrls.length} ä¸ªå¤´åƒæœåŠ¡...`);

            const urlList = document.createElement('div');
            urlList.className = 'url-list';
            
            for (const item of allUrls) {
                const urlItem = document.createElement('div');
                urlItem.className = 'url-item';
                urlItem.innerHTML = `
                    <div>
                        <strong>${item.name}</strong><br>
                        <small>${item.url.substring(0, 60)}${item.url.length > 60 ? '...' : ''}</small>
                    </div>
                    <div class="url-status status-loading" id="status-${allUrls.indexOf(item)}">æµ‹è¯•ä¸­...</div>
                `;
                urlList.appendChild(urlItem);

                // æµ‹è¯•URLå¯ç”¨æ€§
                const img = new Image();
                const index = allUrls.indexOf(item);
                
                img.onload = () => {
                    const statusEl = document.getElementById(`status-${index}`);
                    statusEl.textContent = 'å¯ç”¨';
                    statusEl.className = 'url-status status-success';
                };
                
                img.onerror = () => {
                    const statusEl = document.getElementById(`status-${index}`);
                    statusEl.textContent = 'ä¸å¯ç”¨';
                    statusEl.className = 'url-status status-error';
                };
                
                img.src = item.url;
            }
            
            document.getElementById('service-test-results').appendChild(urlList);
        }

        function clearServiceTests() {
            clearResults('service-test-results');
        }

        function testFallbackMechanism() {
            clearResults('fallback-test-results');
            clearResults('fallback-demo');
            
            addResult('fallback-test-results', 'info', 'æµ‹è¯•å›é€€æœºåˆ¶', 'æ­£åœ¨æµ‹è¯•å¤´åƒåŠ è½½å›é€€...');

            const testCases = [
                { name: 'æ­£å¸¸å¤´åƒ', url: 'https://i.pravatar.cc/150?img=1', username: 'TestUser1' },
                { name: 'å¤±æ•ˆå¤´åƒ', url: 'https://invalid-domain-12345.com/avatar.jpg', username: 'TestUser2' },
                { name: 'ç©ºå¤´åƒ', url: null, username: 'TestUser3' },
                { name: 'é”™è¯¯æ ¼å¼', url: 'not-a-valid-url', username: 'TestUser4' }
            ];

            const demoContainer = document.getElementById('fallback-demo');
            
            testCases.forEach((testCase, index) => {
                const testItem = document.createElement('div');
                testItem.className = 'avatar-test-item';
                testItem.innerHTML = `
                    <img id="test-img-${index}" alt="${testCase.name}">
                    <div><strong>${testCase.name}</strong></div>
                    <div>ç”¨æˆ·: ${testCase.username}</div>
                    <div class="avatar-status status-loading" id="test-status-${index}">åŠ è½½ä¸­...</div>
                `;
                demoContainer.appendChild(testItem);

                const img = document.getElementById(`test-img-${index}`);
                const status = document.getElementById(`test-status-${index}`);
                
                // ä½¿ç”¨æ–°çš„å›é€€æœºåˆ¶
                if (typeof APP_CONFIG.loadAvatarWithFallback === 'function') {
                    APP_CONFIG.loadAvatarWithFallback(img, testCase.url, testCase.username);
                    
                    // ç›‘æ§åŠ è½½çŠ¶æ€
                    img.onload = () => {
                        status.textContent = 'åŠ è½½æˆåŠŸ';
                        status.className = 'avatar-status status-success';
                    };
                    
                    img.onerror = () => {
                        status.textContent = 'åŠ è½½å¤±è´¥';
                        status.className = 'avatar-status status-error';
                    };
                } else {
                    status.textContent = 'å›é€€æœºåˆ¶æœªå¯ç”¨';
                    status.className = 'avatar-status status-error';
                }
            });

            addResult('fallback-test-results', 'success', 'å›é€€æµ‹è¯•å¯åŠ¨', 'å·²åˆ›å»º4ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè§‚å¯ŸåŠ è½½ç»“æœ');
        }

        function testWithDifferentUsers() {
            clearResults('fallback-demo');
            
            const usernames = ['å¼ ä¸‰', 'John', 'Alice', 'æå››', 'Bob', 'Carol'];
            const demoContainer = document.getElementById('fallback-demo');
            
            usernames.forEach((username, index) => {
                const testItem = document.createElement('div');
                testItem.className = 'avatar-test-item';
                testItem.innerHTML = `
                    <img id="user-img-${index}" alt="${username}çš„å¤´åƒ">
                    <div><strong>${username}</strong></div>
                    <div class="avatar-status status-loading" id="user-status-${index}">åŠ è½½ä¸­...</div>
                `;
                demoContainer.appendChild(testItem);

                const img = document.getElementById(`user-img-${index}`);
                const status = document.getElementById(`user-status-${index}`);
                
                // ä½¿ç”¨å›é€€æœºåˆ¶ï¼Œä¸æä¾›ä¸»è¦URLï¼Œæµ‹è¯•é»˜è®¤å¤´åƒç”Ÿæˆ
                if (typeof APP_CONFIG.loadAvatarWithFallback === 'function') {
                    APP_CONFIG.loadAvatarWithFallback(img, null, username);
                    
                    img.onload = () => {
                        status.textContent = 'ç”ŸæˆæˆåŠŸ';
                        status.className = 'avatar-status status-success';
                    };
                } else {
                    status.textContent = 'åŠŸèƒ½æœªå¯ç”¨';
                    status.className = 'avatar-status status-error';
                }
            });

            addResult('fallback-test-results', 'success', 'ç”¨æˆ·åæµ‹è¯•', 'å·²ä¸º6ä¸ªä¸åŒç”¨æˆ·åç”Ÿæˆå¤´åƒ');
        }

        function testRealTimeLoading() {
            clearResults('realtime-results');
            clearResults('realtime-demo');
            
            addResult('realtime-results', 'info', 'å®æ—¶åŠ è½½æµ‹è¯•', 'æ­£åœ¨æ¨¡æ‹Ÿå®é™…ä½¿ç”¨åœºæ™¯...');

            const scenarios = [
                { name: 'æ–°ç”¨æˆ·æ³¨å†Œ', avatar: null, username: 'æ–°ç”¨æˆ·123' },
                { name: 'å¤´åƒæœåŠ¡æ•…éšœ', avatar: 'https://broken-service.com/avatar.jpg', username: 'ç”¨æˆ·456' },
                { name: 'ç½‘ç»œè¾ƒæ…¢', avatar: 'https://httpstat.us/200?sleep=3000', username: 'ç”¨æˆ·789' },
                { name: 'æ­£å¸¸ç”¨æˆ·', avatar: 'https://i.pravatar.cc/150?img=20', username: 'æ­£å¸¸ç”¨æˆ·' }
            ];

            const demoContainer = document.getElementById('realtime-demo');
            
            scenarios.forEach((scenario, index) => {
                const testItem = document.createElement('div');
                testItem.className = 'avatar-test-item';
                testItem.innerHTML = `
                    <img id="real-img-${index}" alt="${scenario.name}">
                    <div><strong>${scenario.name}</strong></div>
                    <div>ç”¨æˆ·: ${scenario.username}</div>
                    <div class="avatar-status status-loading" id="real-status-${index}">åŠ è½½ä¸­...</div>
                `;
                demoContainer.appendChild(testItem);

                const img = document.getElementById(`real-img-${index}`);
                const status = document.getElementById(`real-status-${index}`);
                
                // æ¨¡æ‹Ÿå»¶è¿ŸåŠ è½½
                setTimeout(() => {
                    if (typeof APP_CONFIG.loadAvatarWithFallback === 'function') {
                        APP_CONFIG.loadAvatarWithFallback(img, scenario.avatar, scenario.username);
                        
                        img.onload = () => {
                            status.textContent = 'åŠ è½½å®Œæˆ';
                            status.className = 'avatar-status status-success';
                        };
                        
                        img.onerror = () => {
                            status.textContent = 'ä½¿ç”¨å¤‡ç”¨';
                            status.className = 'avatar-status status-success';
                        };
                    }
                }, index * 500); // é”™å¼€åŠ è½½æ—¶é—´
            });

            addResult('realtime-results', 'success', 'å®æ—¶æµ‹è¯•å¯åŠ¨', 'å·²æ¨¡æ‹Ÿ4ç§å®é™…ä½¿ç”¨åœºæ™¯');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateConfigDisplay();
                
                addResult('service-test-results', 'info', 'é¡µé¢åŠ è½½å®Œæˆ', `
æ–°çš„é»˜è®¤å¤´åƒé…ç½®å·²ç”Ÿæ•ˆï¼š
- ä¸»è¦æœåŠ¡: UI Avatars
- å¤‡ç”¨æœåŠ¡: ${APP_CONFIG.fallbackAvatars.length} ä¸ª
- å›é€€æœºåˆ¶: ${typeof APP_CONFIG.loadAvatarWithFallback === 'function' ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}

å»ºè®®å…ˆè¿è¡Œ"æµ‹è¯•æ‰€æœ‰å¤´åƒæœåŠ¡"æ¥æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§ã€‚
                `);
            }, 500);
        });
    </script>
</body>
</html>
