<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·å¤´åƒæ˜¾ç¤ºæµ‹è¯• - AIæç¤ºè¯å®åº“</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
            background: var(--background-color);
        }
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            background: var(--surface-color);
        }
        .test-result {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #f0fdf4; border: 1px solid #22c55e; color: #166534; }
        .error { background: #fef2f2; border: 1px solid #ef4444; color: #dc2626; }
        .warning { background: #fffbeb; border: 1px solid #f59e0b; color: #d97706; }
        .info { background: #f0f9ff; border: 1px solid #3b82f6; color: #1d4ed8; }
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: var(--space-2);
            transition: var(--transition-fast);
        }
        button:hover { 
            background: var(--primary-hover);
            transform: translateY(-1px);
        }
        h2 { color: var(--text-primary); margin-top: 2rem; }
        h3 { color: var(--text-primary); }
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-4);
            margin: var(--space-4) 0;
        }
        .avatar-demo {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
        }
        .avatar-demo img {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
            margin-bottom: var(--space-2);
        }
        .avatar-info {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: var(--space-2);
        }
        .current-user-display {
            background: var(--primary-50);
            border: 1px solid var(--primary-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin: var(--space-4) 0;
        }
        .sql-code {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: var(--space-3) 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/ui.js"></script>
</head>
<body>
    <h1>ğŸ‘¤ ç”¨æˆ·å¤´åƒæ˜¾ç¤ºæµ‹è¯•</h1>
    <p>æ­¤å·¥å…·ç”¨äºæµ‹è¯•ç”¨æˆ·å¤´åƒæ˜¾ç¤ºåŠŸèƒ½å’Œæ•°æ®åº“å¤´åƒæ•°æ®ã€‚</p>

    <div class="test-section">
        <h3>ğŸ“Š å½“å‰ç”¨æˆ·çŠ¶æ€</h3>
        <div id="current-user-status">
            <div>
                <strong>ç™»å½•çŠ¶æ€ï¼š</strong>
                <span id="login-status">æ£€æŸ¥ä¸­...</span>
            </div>
            <div style="margin-top: var(--space-2);">
                <strong>ç”¨æˆ·ä¿¡æ¯ï¼š</strong>
                <span id="user-info">æ£€æŸ¥ä¸­...</span>
            </div>
            <div style="margin-top: var(--space-2);">
                <strong>å¤´åƒURLï¼š</strong>
                <span id="avatar-url">æ£€æŸ¥ä¸­...</span>
            </div>
        </div>
        
        <div id="current-user-display" class="current-user-display" style="display: none;">
            <h4>å½“å‰ç”¨æˆ·å¤´åƒæ˜¾ç¤º</h4>
            <div style="display: flex; align-items: center; gap: var(--space-3);">
                <img id="current-avatar" src="" alt="å½“å‰ç”¨æˆ·å¤´åƒ" style="width: 64px; height: 64px; border-radius: 50%; border: 2px solid var(--primary-color);">
                <div>
                    <div><strong>ç”¨æˆ·åï¼š</strong><span id="current-username"></span></div>
                    <div><strong>é‚®ç®±ï¼š</strong><span id="current-email"></span></div>
                    <div><strong>å¤´åƒçŠ¶æ€ï¼š</strong><span id="avatar-status"></span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ—„ï¸ æ•°æ®åº“å¤´åƒæ•°æ®</h3>
        <button onclick="checkDatabaseAvatars()">æ£€æŸ¥æ•°æ®åº“å¤´åƒæ•°æ®</button>
        <button onclick="updateDatabaseAvatars()">æ›´æ–°æ•°æ®åº“å¤´åƒ</button>
        <div id="database-results"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ¨ å¤´åƒæœåŠ¡æ¼”ç¤º</h3>
        <button onclick="showAvatarServices()">æ˜¾ç¤ºä¸åŒå¤´åƒæœåŠ¡</button>
        <div id="avatar-services-demo"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ”§ å¤´åƒä¿®å¤å·¥å…·</h3>
        <button onclick="testAvatarLoading()">æµ‹è¯•å¤´åƒåŠ è½½</button>
        <button onclick="testDefaultAvatar()">æµ‹è¯•é»˜è®¤å¤´åƒ</button>
        <button onclick="refreshUserAvatar()">åˆ·æ–°ç”¨æˆ·å¤´åƒ</button>
        <div id="avatar-fix-results"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“ SQLæ›´æ–°è„šæœ¬</h3>
        <p>ä½¿ç”¨ä»¥ä¸‹SQLè„šæœ¬æ¥æ›´æ–°æ•°æ®åº“ä¸­çš„å¤´åƒæ•°æ®ï¼š</p>
        <div class="sql-code">
-- æ›´æ–°usersè¡¨ä¸­çš„avatar_urlå­—æ®µ
UPDATE users 
SET avatar_url = CASE 
    WHEN id % 10 = 0 THEN 'https://i.pravatar.cc/150?img=1'
    WHEN id % 10 = 1 THEN 'https://i.pravatar.cc/150?img=2'
    WHEN id % 10 = 2 THEN 'https://i.pravatar.cc/150?img=3'
    WHEN id % 10 = 3 THEN 'https://i.pravatar.cc/150?img=4'
    WHEN id % 10 = 4 THEN 'https://i.pravatar.cc/150?img=5'
    WHEN id % 10 = 5 THEN 'https://i.pravatar.cc/150?img=6'
    WHEN id % 10 = 6 THEN 'https://i.pravatar.cc/150?img=7'
    WHEN id % 10 = 7 THEN 'https://i.pravatar.cc/150?img=8'
    WHEN id % 10 = 8 THEN 'https://i.pravatar.cc/150?img=9'
    WHEN id % 10 = 9 THEN 'https://i.pravatar.cc/150?img=10'
END
WHERE avatar_url IS NULL;
        </div>
        <button onclick="copySQL()">å¤åˆ¶SQLè„šæœ¬</button>
    </div>

    <script>
        function addResult(containerId, type, title, content) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${title}</strong>\n${content}`;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function updateUserStatus() {
            const loginStatus = document.getElementById('login-status');
            const userInfo = document.getElementById('user-info');
            const avatarUrl = document.getElementById('avatar-url');
            const currentUserDisplay = document.getElementById('current-user-display');
            
            if (window.authManager) {
                const isAuth = authManager.isAuthenticated();
                const user = authManager.getCurrentUser();
                
                loginStatus.textContent = isAuth ? 'å·²ç™»å½•' : 'æœªç™»å½•';
                
                if (user) {
                    userInfo.textContent = `${user.username} (${user.email})`;
                    avatarUrl.textContent = user.avatar_url || 'æ— ';
                    
                    // æ˜¾ç¤ºå½“å‰ç”¨æˆ·å¤´åƒ
                    currentUserDisplay.style.display = 'block';
                    document.getElementById('current-avatar').src = user.avatar_url || APP_CONFIG.defaultAvatar;
                    document.getElementById('current-username').textContent = user.username;
                    document.getElementById('current-email').textContent = user.email;
                    
                    // æµ‹è¯•å¤´åƒåŠ è½½çŠ¶æ€
                    const avatarImg = document.getElementById('current-avatar');
                    avatarImg.onload = () => {
                        document.getElementById('avatar-status').textContent = 'åŠ è½½æˆåŠŸ';
                        document.getElementById('avatar-status').style.color = 'var(--success-color)';
                    };
                    avatarImg.onerror = () => {
                        document.getElementById('avatar-status').textContent = 'åŠ è½½å¤±è´¥';
                        document.getElementById('avatar-status').style.color = 'var(--error-color)';
                        avatarImg.src = APP_CONFIG.defaultAvatar;
                    };
                } else {
                    userInfo.textContent = 'æ— ';
                    avatarUrl.textContent = 'æ— ';
                    currentUserDisplay.style.display = 'none';
                }
            } else {
                loginStatus.textContent = 'è®¤è¯ç®¡ç†å™¨æœªåˆå§‹åŒ–';
                userInfo.textContent = 'æ— ';
                avatarUrl.textContent = 'æ— ';
                currentUserDisplay.style.display = 'none';
            }
        }

        async function checkDatabaseAvatars() {
            clearResults('database-results');
            
            try {
                addResult('database-results', 'info', 'æ£€æŸ¥æ•°æ®åº“å¤´åƒæ•°æ®', 'æ­£åœ¨æŸ¥è¯¢æ•°æ®åº“...');

                const { data, error } = await supabase
                    .from('users')
                    .select('id, username, email, avatar_url')
                    .limit(10);

                if (error) {
                    addResult('database-results', 'error', 'æŸ¥è¯¢å¤±è´¥', error.message);
                    return;
                }

                if (data.length === 0) {
                    addResult('database-results', 'warning', 'æ²¡æœ‰ç”¨æˆ·æ•°æ®', 'æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·æ•°æ®');
                    return;
                }

                const usersWithAvatar = data.filter(user => user.avatar_url);
                const usersWithoutAvatar = data.filter(user => !user.avatar_url);

                addResult('database-results', 'success', 'æ•°æ®åº“æŸ¥è¯¢æˆåŠŸ', `
æ€»ç”¨æˆ·æ•°: ${data.length}
æœ‰å¤´åƒ: ${usersWithAvatar.length}
æ— å¤´åƒ: ${usersWithoutAvatar.length}
                `);

                // æ˜¾ç¤ºç”¨æˆ·å¤´åƒæ•°æ®
                const avatarGrid = document.createElement('div');
                avatarGrid.className = 'avatar-grid';
                
                data.forEach(user => {
                    const avatarDemo = document.createElement('div');
                    avatarDemo.className = 'avatar-demo';
                    avatarDemo.innerHTML = `
                        <img src="${user.avatar_url || APP_CONFIG.defaultAvatar}" 
                             alt="${user.username}çš„å¤´åƒ"
                             onerror="this.src='${APP_CONFIG.defaultAvatar}'">
                        <div><strong>${user.username}</strong></div>
                        <div class="avatar-info">
                            ID: ${user.id}<br>
                            é‚®ç®±: ${user.email}<br>
                            å¤´åƒ: ${user.avatar_url ? 'æœ‰' : 'æ— '}
                        </div>
                    `;
                    avatarGrid.appendChild(avatarDemo);
                });
                
                document.getElementById('database-results').appendChild(avatarGrid);

            } catch (error) {
                addResult('database-results', 'error', 'æ£€æŸ¥å¤±è´¥', error.message);
            }
        }

        async function updateDatabaseAvatars() {
            clearResults('database-results');
            
            try {
                addResult('database-results', 'info', 'æ›´æ–°æ•°æ®åº“å¤´åƒ', 'æ­£åœ¨æ›´æ–°å¤´åƒæ•°æ®...');

                // è·å–æ²¡æœ‰å¤´åƒçš„ç”¨æˆ·
                const { data: usersWithoutAvatar, error: fetchError } = await supabase
                    .from('users')
                    .select('id, username, email')
                    .is('avatar_url', null);

                if (fetchError) {
                    addResult('database-results', 'error', 'è·å–ç”¨æˆ·å¤±è´¥', fetchError.message);
                    return;
                }

                if (usersWithoutAvatar.length === 0) {
                    addResult('database-results', 'success', 'æ— éœ€æ›´æ–°', 'æ‰€æœ‰ç”¨æˆ·éƒ½å·²æœ‰å¤´åƒ');
                    return;
                }

                // ä¸ºæ¯ä¸ªç”¨æˆ·ç”Ÿæˆå¤´åƒURL
                const updates = usersWithoutAvatar.map(user => ({
                    id: user.id,
                    avatar_url: `https://i.pravatar.cc/150?img=${(user.id % 70) + 1}`
                }));

                // æ‰¹é‡æ›´æ–°
                for (const update of updates) {
                    const { error: updateError } = await supabase
                        .from('users')
                        .update({ avatar_url: update.avatar_url })
                        .eq('id', update.id);

                    if (updateError) {
                        console.error('æ›´æ–°ç”¨æˆ·å¤´åƒå¤±è´¥:', updateError);
                    }
                }

                addResult('database-results', 'success', 'æ›´æ–°å®Œæˆ', `å·²ä¸º ${updates.length} ä¸ªç”¨æˆ·æ·»åŠ å¤´åƒ`);

            } catch (error) {
                addResult('database-results', 'error', 'æ›´æ–°å¤±è´¥', error.message);
            }
        }

        function showAvatarServices() {
            clearResults('avatar-services-demo');
            
            const services = [
                {
                    name: 'Pravatar',
                    url: 'https://i.pravatar.cc/150?img=1',
                    description: 'çœŸå®äººç‰©å¤´åƒ'
                },
                {
                    name: 'DiceBear Avataaars',
                    url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=test',
                    description: 'å¡é€šé£æ ¼å¤´åƒ'
                },
                {
                    name: 'UI Avatars',
                    url: 'https://ui-avatars.com/api/?name=Test+User&background=8b5cf6&color=ffffff&size=150',
                    description: 'åŸºäºå§“åçš„å¤´åƒ'
                },
                {
                    name: 'DiceBear Personas',
                    url: 'https://api.dicebear.com/7.x/personas/svg?seed=test',
                    description: 'ç®€çº¦äººç‰©å¤´åƒ'
                },
                {
                    name: 'DiceBear Fun Emoji',
                    url: 'https://api.dicebear.com/7.x/fun-emoji/svg?seed=test',
                    description: 'è¡¨æƒ…ç¬¦å·å¤´åƒ'
                },
                {
                    name: 'é»˜è®¤å¤´åƒ',
                    url: APP_CONFIG.defaultAvatar,
                    description: 'ç³»ç»Ÿé»˜è®¤å¤´åƒ'
                }
            ];

            const avatarGrid = document.createElement('div');
            avatarGrid.className = 'avatar-grid';
            
            services.forEach(service => {
                const avatarDemo = document.createElement('div');
                avatarDemo.className = 'avatar-demo';
                avatarDemo.innerHTML = `
                    <img src="${service.url}" 
                         alt="${service.name}"
                         onerror="this.src='${APP_CONFIG.defaultAvatar}'">
                    <div><strong>${service.name}</strong></div>
                    <div class="avatar-info">${service.description}</div>
                `;
                avatarGrid.appendChild(avatarDemo);
            });
            
            document.getElementById('avatar-services-demo').appendChild(avatarGrid);
            
            addResult('avatar-services-demo', 'success', 'å¤´åƒæœåŠ¡æ¼”ç¤º', 'å·²æ˜¾ç¤ºä¸åŒå¤´åƒæœåŠ¡çš„æ•ˆæœ');
        }

        function testAvatarLoading() {
            clearResults('avatar-fix-results');
            
            const testUrls = [
                'https://i.pravatar.cc/150?img=1',
                'https://invalid-url.com/avatar.jpg',
                APP_CONFIG.defaultAvatar,
                'https://api.dicebear.com/7.x/avataaars/svg?seed=test'
            ];

            addResult('avatar-fix-results', 'info', 'æµ‹è¯•å¤´åƒåŠ è½½', 'æ­£åœ¨æµ‹è¯•ä¸åŒå¤´åƒURLçš„åŠ è½½æƒ…å†µ...');

            testUrls.forEach((url, index) => {
                const img = new Image();
                img.onload = () => {
                    addResult('avatar-fix-results', 'success', `URL ${index + 1} åŠ è½½æˆåŠŸ`, url);
                };
                img.onerror = () => {
                    addResult('avatar-fix-results', 'error', `URL ${index + 1} åŠ è½½å¤±è´¥`, url);
                };
                img.src = url;
            });
        }

        function testDefaultAvatar() {
            clearResults('avatar-fix-results');
            
            addResult('avatar-fix-results', 'info', 'æµ‹è¯•é»˜è®¤å¤´åƒ', `é»˜è®¤å¤´åƒURL: ${APP_CONFIG.defaultAvatar}`);
            
            const img = new Image();
            img.onload = () => {
                addResult('avatar-fix-results', 'success', 'é»˜è®¤å¤´åƒåŠ è½½æˆåŠŸ', 'é»˜è®¤å¤´åƒå¯ä»¥æ­£å¸¸æ˜¾ç¤º');
            };
            img.onerror = () => {
                addResult('avatar-fix-results', 'error', 'é»˜è®¤å¤´åƒåŠ è½½å¤±è´¥', 'éœ€è¦æ£€æŸ¥é»˜è®¤å¤´åƒé…ç½®');
            };
            img.src = APP_CONFIG.defaultAvatar;
        }

        function refreshUserAvatar() {
            clearResults('avatar-fix-results');
            
            if (!window.authManager || !authManager.isAuthenticated()) {
                addResult('avatar-fix-results', 'warning', 'ç”¨æˆ·æœªç™»å½•', 'è¯·å…ˆç™»å½•ä»¥åˆ·æ–°å¤´åƒ');
                return;
            }

            addResult('avatar-fix-results', 'info', 'åˆ·æ–°ç”¨æˆ·å¤´åƒ', 'æ­£åœ¨é‡æ–°åŠ è½½ç”¨æˆ·å¤´åƒ...');
            
            // é‡æ–°æ›´æ–°UIä¸­çš„å¤´åƒ
            authManager.updateUI();
            updateUserStatus();
            
            addResult('avatar-fix-results', 'success', 'å¤´åƒåˆ·æ–°å®Œæˆ', 'å·²é‡æ–°åŠ è½½ç”¨æˆ·å¤´åƒ');
        }

        function copySQL() {
            const sqlCode = document.querySelector('.sql-code').textContent;
            navigator.clipboard.writeText(sqlCode).then(() => {
                alert('SQLè„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateUserStatus();
                
                // å®šæœŸæ›´æ–°çŠ¶æ€
                setInterval(updateUserStatus, 5000);
            }, 1000);
        });
    </script>
</body>
</html>
