# åŒ¿åç”¨æˆ·ç‚¹èµå¤–é”®çº¦æŸé”™è¯¯ä¿®å¤æŒ‡å—

## ğŸš¨ é”™è¯¯ä¿¡æ¯
```
ç‚¹èµæ“ä½œå¤±è´¥: insert or update on table "user_likes" violates foreign key constraint "user_likes_user_id_fkey"
```

## ğŸ” é—®é¢˜åŸå› 
åŒ¿åç”¨æˆ·çš„UUIDä¸å­˜åœ¨äº`auth.users`è¡¨ä¸­ï¼Œä½†`user_likes`è¡¨çš„`user_id`å­—æ®µæœ‰å¤–é”®çº¦æŸå¼•ç”¨`auth.users(id)`ï¼Œå¯¼è‡´æ’å…¥å¤±è´¥ã€‚

## âš¡ å¿«é€Ÿä¿®å¤æ­¥éª¤

### æ­¥éª¤1ï¼šè¿è¡ŒSQLä¿®å¤è„šæœ¬
åœ¨Supabase SQLç¼–è¾‘å™¨ä¸­è¿è¡Œä»¥ä¸‹SQLï¼š

```sql
-- åˆ é™¤å¤–é”®çº¦æŸï¼Œå…è®¸åŒ¿åç”¨æˆ·ID
ALTER TABLE user_likes DROP CONSTRAINT IF EXISTS user_likes_user_id_fkey;
ALTER TABLE user_favorites DROP CONSTRAINT IF EXISTS user_favorites_user_id_fkey;

-- æ·»åŠ ç´¢å¼•æé«˜æ€§èƒ½
CREATE INDEX IF NOT EXISTS idx_user_likes_user_id ON user_likes(user_id);
CREATE INDEX IF NOT EXISTS idx_user_likes_prompt_id ON user_likes(prompt_id);
CREATE INDEX IF NOT EXISTS idx_user_likes_user_prompt ON user_likes(user_id, prompt_id);

-- ä¸ºå­—æ®µæ·»åŠ è¯´æ˜
COMMENT ON COLUMN user_likes.user_id IS 'ç”¨æˆ·IDï¼Œå¯ä»¥æ˜¯auth.usersä¸­çš„çœŸå®ç”¨æˆ·IDï¼Œä¹Ÿå¯ä»¥æ˜¯åŒ¿åç”¨æˆ·çš„UUID';
```

### æ­¥éª¤2ï¼šéªŒè¯ä¿®å¤
è¿è¡Œä»¥ä¸‹æŸ¥è¯¢éªŒè¯çº¦æŸå·²åˆ é™¤ï¼š
```sql
SELECT conname, contype 
FROM pg_constraint 
WHERE conrelid = 'user_likes'::regclass;
```

### æ­¥éª¤3ï¼šæµ‹è¯•åŠŸèƒ½
1. æ‰“å¼€æµ‹è¯•é¡µé¢ `test_anonymous_user_like.html`
2. ç¡®ä¿æœªç™»å½•çŠ¶æ€
3. ç‚¹å‡»ç‚¹èµæŒ‰é’®æµ‹è¯•åŠŸèƒ½

## ğŸ“‹ å®Œæ•´ä¿®å¤è„šæœ¬

å¦‚æœæ‚¨å¸Œæœ›è¿è¡Œå®Œæ•´çš„ä¿®å¤è„šæœ¬ï¼Œè¯·åœ¨Supabase SQLç¼–è¾‘å™¨ä¸­è¿è¡Œ `fix_anonymous_user_constraints.sql` æ–‡ä»¶ã€‚

## ğŸ”§ æŠ€æœ¯è¯´æ˜

### ä¿®å¤å‰çš„æ•°æ®ç»“æ„
```sql
-- æœ‰å¤–é”®çº¦æŸï¼Œé™åˆ¶åªèƒ½ä½¿ç”¨auth.usersä¸­çš„ID
user_id UUID REFERENCES auth.users(id)
```

### ä¿®å¤åçš„æ•°æ®ç»“æ„
```sql
-- æ— å¤–é”®çº¦æŸï¼Œå…è®¸ä»»ä½•æœ‰æ•ˆçš„UUID
user_id UUID
```

### æ•°æ®å®Œæ•´æ€§ä¿è¯
- åº”ç”¨å±‚éªŒè¯UUIDæ ¼å¼çš„æœ‰æ•ˆæ€§
- ç™»å½•ç”¨æˆ·ä»ç„¶ä½¿ç”¨auth.usersä¸­çš„çœŸå®ID
- åŒ¿åç”¨æˆ·ä½¿ç”¨localStorageä¸­ç”Ÿæˆçš„UUID
- é€šè¿‡ç´¢å¼•ä¿è¯æŸ¥è¯¢æ€§èƒ½

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®å¤åï¼ŒåŒ¿åç”¨æˆ·åº”è¯¥èƒ½å¤Ÿï¼š
1. âœ… æ­£å¸¸ç‚¹èµå’Œå–æ¶ˆç‚¹èµ
2. âœ… ç‚¹èµè®°å½•å­˜å‚¨åœ¨user_likesè¡¨ä¸­
3. âœ… promptsè¡¨çš„like_countå­—æ®µæ­£ç¡®æ›´æ–°
4. âœ… é¡µé¢åˆ·æ–°åç‚¹èµçŠ¶æ€ä¿æŒ

## ğŸ” æ•…éšœæ’é™¤

### å¦‚æœä»ç„¶å‡ºé”™
1. **æ£€æŸ¥SQLæ‰§è¡Œç»“æœ**ï¼šç¡®è®¤çº¦æŸåˆ é™¤æˆåŠŸ
2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**ï¼šåˆ·æ–°é¡µé¢é‡æ–°æµ‹è¯•
3. **æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—**ï¼šæŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
4. **éªŒè¯åŒ¿åID**ï¼šç¡®è®¤localStorageä¸­æœ‰æœ‰æ•ˆçš„UUID

### å¸¸è§é—®é¢˜
- **Q**: åˆ é™¤å¤–é”®çº¦æŸæ˜¯å¦å®‰å…¨ï¼Ÿ
- **A**: æ˜¯çš„ï¼Œæˆ‘ä»¬é€šè¿‡åº”ç”¨å±‚é€»è¾‘ä¿è¯æ•°æ®å®Œæ•´æ€§

- **Q**: ä¼šå½±å“ç°æœ‰çš„ç™»å½•ç”¨æˆ·å—ï¼Ÿ
- **A**: ä¸ä¼šï¼Œç™»å½•ç”¨æˆ·ç»§ç»­ä½¿ç”¨auth.usersä¸­çš„çœŸå®ID

- **Q**: å¦‚ä½•åŒºåˆ†åŒ¿åç”¨æˆ·å’ŒçœŸå®ç”¨æˆ·ï¼Ÿ
- **A**: å¯ä»¥é€šè¿‡æ£€æŸ¥user_idæ˜¯å¦å­˜åœ¨äºauth.usersè¡¨ä¸­æ¥åŒºåˆ†

## ğŸ“Š æ•°æ®ç¤ºä¾‹

### ä¿®å¤åçš„user_likesè¡¨æ•°æ®
```sql
-- çœŸå®ç”¨æˆ·çš„ç‚¹èµè®°å½•
user_id: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890' (å­˜åœ¨äºauth.users)
prompt_id: 123

-- åŒ¿åç”¨æˆ·çš„ç‚¹èµè®°å½•  
user_id: '550e8400-e29b-41d4-a716-446655440000' (ä¸å­˜åœ¨äºauth.users)
prompt_id: 456
```

## ğŸš€ ä¸‹ä¸€æ­¥

ä¿®å¤å®Œæˆåï¼Œæ‚¨å¯ä»¥ï¼š
1. æµ‹è¯•å®Œæ•´çš„åŒ¿åç”¨æˆ·ç‚¹èµæµç¨‹
2. éªŒè¯æ•°æ®åº“ä¸­çš„è®°å½•æ­£ç¡®æ€§
3. æ£€æŸ¥promptsè¡¨çš„like_countæ›´æ–°
4. æµ‹è¯•ç”¨æˆ·ç™»å½•åçš„æ•°æ®ä¸€è‡´æ€§

---

**é‡è¦æç¤º**ï¼šè¯·ç¡®ä¿åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œæ­¤ä¿®å¤å‰ï¼Œå…ˆåœ¨æµ‹è¯•ç¯å¢ƒä¸­éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚
