<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡µé¢åˆ‡æ¢é€šçŸ¥æµ‹è¯• - AIæç¤ºè¯å®åº“</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
            background: var(--background-color);
        }
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            background: var(--surface-color);
        }
        .test-result {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #f0fdf4; border: 1px solid #22c55e; color: #166534; }
        .error { background: #fef2f2; border: 1px solid #ef4444; color: #dc2626; }
        .warning { background: #fffbeb; border: 1px solid #f59e0b; color: #d97706; }
        .info { background: #f0f9ff; border: 1px solid #3b82f6; color: #1d4ed8; }
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-lg);
            cursor: pointer;
            margin: var(--space-2);
            transition: var(--transition-fast);
        }
        button:hover { 
            background: var(--primary-hover);
            transform: translateY(-1px);
        }
        h2 { color: var(--text-primary); margin-top: 2rem; }
        h3 { color: var(--text-primary); }
        .notification-log {
            max-height: 300px;
            overflow-y: auto;
            background: var(--gray-50);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            font-family: monospace;
            font-size: 12px;
            margin: var(--space-3) 0;
        }
        .log-entry {
            margin: var(--space-1) 0;
            padding: var(--space-1);
            border-radius: var(--radius-sm);
        }
        .log-entry.login { background: #dcfce7; color: #166534; }
        .log-entry.logout { background: #fef3c7; color: #92400e; }
        .log-entry.normal { background: #f3f4f6; color: #374151; }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: var(--space-2);
        }
        .status-indicator.online { background: #10b981; }
        .status-indicator.offline { background: #ef4444; }
        .external-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-3);
            margin: var(--space-4) 0;
        }
        .external-link {
            display: block;
            padding: var(--space-3);
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            text-decoration: none;
            color: var(--text-primary);
            transition: var(--transition-fast);
        }
        .external-link:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/ui.js"></script>
</head>
<body>
    <h1>ğŸ”„ é¡µé¢åˆ‡æ¢é€šçŸ¥æµ‹è¯•</h1>
    <p>æ­¤å·¥å…·ç”¨äºæµ‹è¯•é¡µé¢åˆ‡æ¢å’Œæ¢å¤æ—¶æ˜¯å¦ä¼šæ˜¾ç¤ºä¸å¿…è¦çš„"ç™»å½•æˆåŠŸ"é€šçŸ¥ã€‚</p>

    <div class="test-section">
        <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
        <div class="test-result info">
ä¿®å¤å†…å®¹ï¼š
1. é˜²æ­¢é¡µé¢æ¢å¤æ—¶æ˜¾ç¤º"ç™»å½•æˆåŠŸ"é€šçŸ¥
2. é˜²æ­¢ä»å…¶ä»–ç½‘é¡µåˆ‡æ¢å›æ¥æ—¶æ˜¾ç¤ºé€šçŸ¥
3. é˜²æ­¢çª—å£æœ€å°åŒ–åæ¢å¤æ—¶æ˜¾ç¤ºé€šçŸ¥
4. åªåœ¨ç”¨æˆ·ä¸»åŠ¨ç™»å½•æ—¶æ˜¾ç¤ºé€šçŸ¥

æµ‹è¯•æ–¹æ³•ï¼š
- é¡µé¢å¯è§æ€§å˜åŒ–æµ‹è¯•
- çª—å£ç„¦ç‚¹å˜åŒ–æµ‹è¯•
- å¤–éƒ¨é“¾æ¥è·³è½¬è¿”å›æµ‹è¯•
- è®¤è¯çŠ¶æ€ç›‘å¬å™¨é‡å¤è§¦å‘æµ‹è¯•
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
        <div id="current-status">
            <div>
                <span class="status-indicator online"></span>
                <strong>è®¤è¯çŠ¶æ€ï¼š</strong>
                <span id="auth-status">æ£€æŸ¥ä¸­...</span>
            </div>
            <div style="margin-top: var(--space-2);">
                <strong>ç”¨æˆ·ä¿¡æ¯ï¼š</strong>
                <span id="user-info">æ£€æŸ¥ä¸­...</span>
            </div>
            <div style="margin-top: var(--space-2);">
                <strong>é¡µé¢å¯è§æ€§ï¼š</strong>
                <span id="visibility-status">å¯è§</span>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ§ª é€šçŸ¥ç›‘æ§</h3>
        <button onclick="startNotificationMonitoring()">å¼€å§‹ç›‘æ§é€šçŸ¥</button>
        <button onclick="stopNotificationMonitoring()">åœæ­¢ç›‘æ§</button>
        <button onclick="clearNotificationLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="notification-monitoring-status"></div>
        <div id="notification-log" class="notification-log">ç­‰å¾…é€šçŸ¥...</div>
    </div>

    <div class="test-section">
        <h3>ğŸ”„ é¡µé¢å¯è§æ€§æµ‹è¯•</h3>
        <button onclick="testPageVisibility()">æµ‹è¯•é¡µé¢å¯è§æ€§å˜åŒ–</button>
        <button onclick="simulateMinimize()">æ¨¡æ‹Ÿçª—å£æœ€å°åŒ–</button>
        <div id="visibility-test-results"></div>
    </div>

    <div class="test-section">
        <h3>ğŸŒ å¤–éƒ¨é“¾æ¥æµ‹è¯•</h3>
        <p>ç‚¹å‡»ä»¥ä¸‹é“¾æ¥è·³è½¬åˆ°å¤–éƒ¨ç½‘ç«™ï¼Œç„¶åè¿”å›æœ¬é¡µé¢ï¼Œè§‚å¯Ÿæ˜¯å¦æ˜¾ç¤º"ç™»å½•æˆåŠŸ"é€šçŸ¥ï¼š</p>
        <div class="external-links">
            <a href="https://www.google.com" target="_blank" class="external-link">
                <i class="fab fa-google"></i>
                Google (æ–°æ ‡ç­¾é¡µ)
            </a>
            <a href="https://github.com" target="_blank" class="external-link">
                <i class="fab fa-github"></i>
                GitHub (æ–°æ ‡ç­¾é¡µ)
            </a>
            <a href="https://www.baidu.com" class="external-link" onclick="recordExternalNavigation(this.href)">
                <i class="fas fa-search"></i>
                ç™¾åº¦ (å½“å‰é¡µé¢)
            </a>
            <a href="javascript:void(0)" class="external-link" onclick="simulateExternalReturn()">
                <i class="fas fa-undo"></i>
                æ¨¡æ‹Ÿå¤–éƒ¨è¿”å›
            </a>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ” è®¤è¯æµ‹è¯•</h3>
        <button onclick="testAuthStateChange()">æµ‹è¯•è®¤è¯çŠ¶æ€å˜åŒ–</button>
        <button onclick="simulateTokenRefresh()">æ¨¡æ‹ŸTokenåˆ·æ–°</button>
        <div id="auth-test-results"></div>
    </div>

    <script>
        let notificationLog = [];
        let isMonitoring = false;
        let originalShowNotification = null;

        function addResult(containerId, type, title, content) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${title}</strong>\n${content}`;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function updateStatus() {
            const authStatus = document.getElementById('auth-status');
            const userInfo = document.getElementById('user-info');
            
            if (window.authManager) {
                const isAuth = authManager.isAuthenticated();
                const user = authManager.getCurrentUser();
                
                authStatus.textContent = isAuth ? 'å·²ç™»å½•' : 'æœªç™»å½•';
                authStatus.className = isAuth ? 'status-indicator online' : 'status-indicator offline';
                
                userInfo.textContent = user ? user.email : 'æ— ';
            } else {
                authStatus.textContent = 'è®¤è¯ç®¡ç†å™¨æœªåˆå§‹åŒ–';
                userInfo.textContent = 'æ— ';
            }
        }

        function startNotificationMonitoring() {
            if (isMonitoring) return;
            
            isMonitoring = true;
            notificationLog = [];
            
            // ä¿å­˜åŸå§‹æ–¹æ³•
            if (!originalShowNotification && window.UI) {
                originalShowNotification = UI.showNotification;
                
                // é‡å†™é€šçŸ¥æ–¹æ³•
                UI.showNotification = function(message, type, title) {
                    const timestamp = new Date().toLocaleTimeString();
                    const logEntry = {
                        time: timestamp,
                        message: message,
                        type: type,
                        title: title || ''
                    };
                    
                    notificationLog.push(logEntry);
                    updateNotificationLog();
                    
                    // ç‰¹åˆ«æ ‡è®°å…³æ³¨çš„é€šçŸ¥
                    if (message === 'ç™»å½•æˆåŠŸ' || message === 'å·²ç™»å‡º') {
                        console.warn('ğŸš¨ å…³æ³¨çš„é€šçŸ¥:', logEntry);
                    }
                    
                    // è°ƒç”¨åŸå§‹æ–¹æ³•
                    return originalShowNotification.call(this, message, type, title);
                };
            }
            
            document.getElementById('notification-monitoring-status').innerHTML = 
                '<div class="test-result success">é€šçŸ¥ç›‘æ§å·²å¯åŠ¨ âœ…</div>';
        }

        function stopNotificationMonitoring() {
            if (!isMonitoring) return;
            
            isMonitoring = false;
            
            // æ¢å¤åŸå§‹æ–¹æ³•
            if (originalShowNotification && window.UI) {
                UI.showNotification = originalShowNotification;
            }
            
            document.getElementById('notification-monitoring-status').innerHTML = 
                '<div class="test-result warning">é€šçŸ¥ç›‘æ§å·²åœæ­¢ â¹ï¸</div>';
        }

        function clearNotificationLog() {
            notificationLog = [];
            updateNotificationLog();
        }

        function updateNotificationLog() {
            const logContainer = document.getElementById('notification-log');
            
            if (notificationLog.length === 0) {
                logContainer.innerHTML = 'ç­‰å¾…é€šçŸ¥...';
                return;
            }
            
            const logHtml = notificationLog.map(entry => {
                const typeClass = entry.message === 'ç™»å½•æˆåŠŸ' ? 'login' : 
                                 entry.message === 'å·²ç™»å‡º' ? 'logout' : 'normal';
                
                return `<div class="log-entry ${typeClass}">
                    [${entry.time}] ${entry.type.toUpperCase()}: ${entry.message}
                    ${entry.title ? ` (${entry.title})` : ''}
                </div>`;
            }).join('');
            
            logContainer.innerHTML = logHtml;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function testPageVisibility() {
            clearResults('visibility-test-results');
            
            addResult('visibility-test-results', 'info', 'é¡µé¢å¯è§æ€§æµ‹è¯•', 'æ­£åœ¨æµ‹è¯•é¡µé¢å¯è§æ€§å˜åŒ–...');
            
            const beforeCount = notificationLog.length;
            
            // æ¨¡æ‹Ÿé¡µé¢éšè—å’Œæ˜¾ç¤º
            Object.defineProperty(document, 'hidden', {
                writable: true,
                value: true
            });
            
            // è§¦å‘å¯è§æ€§å˜åŒ–äº‹ä»¶
            document.dispatchEvent(new Event('visibilitychange'));
            
            setTimeout(() => {
                Object.defineProperty(document, 'hidden', {
                    writable: true,
                    value: false
                });
                
                document.dispatchEvent(new Event('visibilitychange'));
                
                setTimeout(() => {
                    const afterCount = notificationLog.length;
                    const newNotifications = notificationLog.slice(beforeCount);
                    
                    if (newNotifications.length === 0) {
                        addResult('visibility-test-results', 'success', 'æµ‹è¯•é€šè¿‡', 'é¡µé¢å¯è§æ€§å˜åŒ–æ²¡æœ‰è§¦å‘ä¸å¿…è¦çš„é€šçŸ¥ âœ…');
                    } else {
                        addResult('visibility-test-results', 'warning', 'å‘ç°é€šçŸ¥', `è§¦å‘äº†é€šçŸ¥: ${newNotifications.map(n => n.message).join(', ')}`);
                    }
                }, 500);
            }, 500);
        }

        function simulateMinimize() {
            clearResults('visibility-test-results');
            
            addResult('visibility-test-results', 'info', 'æ¨¡æ‹Ÿçª—å£æœ€å°åŒ–', 'æ­£åœ¨æ¨¡æ‹Ÿçª—å£æœ€å°åŒ–å’Œæ¢å¤...');
            
            const beforeCount = notificationLog.length;
            
            // æ¨¡æ‹Ÿçª—å£å¤±å»ç„¦ç‚¹
            window.dispatchEvent(new Event('blur'));
            
            setTimeout(() => {
                // æ¨¡æ‹Ÿçª—å£è·å¾—ç„¦ç‚¹
                window.dispatchEvent(new Event('focus'));
                
                setTimeout(() => {
                    const afterCount = notificationLog.length;
                    const newNotifications = notificationLog.slice(beforeCount);
                    
                    if (newNotifications.length === 0) {
                        addResult('visibility-test-results', 'success', 'æµ‹è¯•é€šè¿‡', 'çª—å£ç„¦ç‚¹å˜åŒ–æ²¡æœ‰è§¦å‘ä¸å¿…è¦çš„é€šçŸ¥ âœ…');
                    } else {
                        addResult('visibility-test-results', 'warning', 'å‘ç°é€šçŸ¥', `è§¦å‘äº†é€šçŸ¥: ${newNotifications.map(n => n.message).join(', ')}`);
                    }
                }, 500);
            }, 1000);
        }

        function recordExternalNavigation(url) {
            localStorage.setItem('externalNavTime', Date.now().toString());
            window.location.href = url;
        }

        function simulateExternalReturn() {
            clearResults('visibility-test-results');
            
            addResult('visibility-test-results', 'info', 'æ¨¡æ‹Ÿå¤–éƒ¨è¿”å›', 'æ­£åœ¨æ¨¡æ‹Ÿä»å¤–éƒ¨ç½‘ç«™è¿”å›...');
            
            const beforeCount = notificationLog.length;
            
            // æ¨¡æ‹Ÿé¡µé¢é‡æ–°åŠ è½½ï¼ˆä»å¤–éƒ¨è¿”å›çš„æ•ˆæœï¼‰
            window.dispatchEvent(new Event('pageshow'));
            
            setTimeout(() => {
                const afterCount = notificationLog.length;
                const newNotifications = notificationLog.slice(beforeCount);
                
                if (newNotifications.length === 0) {
                    addResult('visibility-test-results', 'success', 'æµ‹è¯•é€šè¿‡', 'æ¨¡æ‹Ÿå¤–éƒ¨è¿”å›æ²¡æœ‰è§¦å‘ä¸å¿…è¦çš„é€šçŸ¥ âœ…');
                } else {
                    addResult('visibility-test-results', 'warning', 'å‘ç°é€šçŸ¥', `è§¦å‘äº†é€šçŸ¥: ${newNotifications.map(n => n.message).join(', ')}`);
                }
            }, 1000);
        }

        function testAuthStateChange() {
            clearResults('auth-test-results');
            
            if (!window.authManager) {
                addResult('auth-test-results', 'error', 'æµ‹è¯•å¤±è´¥', 'è®¤è¯ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                return;
            }
            
            addResult('auth-test-results', 'info', 'è®¤è¯çŠ¶æ€æµ‹è¯•', 'æ­£åœ¨æµ‹è¯•è®¤è¯çŠ¶æ€å˜åŒ–...');
            
            const beforeCount = notificationLog.length;
            
            // æ¨¡æ‹Ÿè®¤è¯çŠ¶æ€å˜åŒ–ï¼ˆä¸æ˜¯çœŸå®ç™»å½•ï¼‰
            setTimeout(() => {
                const afterCount = notificationLog.length;
                const newNotifications = notificationLog.slice(beforeCount);
                
                addResult('auth-test-results', 'info', 'æµ‹è¯•ç»“æœ', `è®¤è¯çŠ¶æ€æ£€æŸ¥å®Œæˆï¼Œæ–°é€šçŸ¥æ•°é‡: ${newNotifications.length}`);
                
                if (newNotifications.some(n => n.message === 'ç™»å½•æˆåŠŸ')) {
                    addResult('auth-test-results', 'warning', 'å‘ç°é—®é¢˜', 'æ£€æµ‹åˆ°"ç™»å½•æˆåŠŸ"é€šçŸ¥ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–');
                } else {
                    addResult('auth-test-results', 'success', 'æµ‹è¯•é€šè¿‡', 'æ²¡æœ‰æ£€æµ‹åˆ°ä¸å¿…è¦çš„"ç™»å½•æˆåŠŸ"é€šçŸ¥ âœ…');
                }
            }, 1000);
        }

        function simulateTokenRefresh() {
            clearResults('auth-test-results');
            
            addResult('auth-test-results', 'info', 'Tokenåˆ·æ–°æµ‹è¯•', 'æ­£åœ¨æ¨¡æ‹ŸTokenåˆ·æ–°...');
            
            const beforeCount = notificationLog.length;
            
            // æ¨¡æ‹ŸTOKEN_REFRESHEDäº‹ä»¶
            if (window.authManager && authManager.currentUser) {
                // è¿™é‡Œæ¨¡æ‹ŸSupabaseçš„TOKEN_REFRESHEDäº‹ä»¶
                setTimeout(() => {
                    const afterCount = notificationLog.length;
                    const newNotifications = notificationLog.slice(beforeCount);
                    
                    if (newNotifications.some(n => n.message === 'ç™»å½•æˆåŠŸ')) {
                        addResult('auth-test-results', 'warning', 'å‘ç°é—®é¢˜', 'Tokenåˆ·æ–°è§¦å‘äº†"ç™»å½•æˆåŠŸ"é€šçŸ¥');
                    } else {
                        addResult('auth-test-results', 'success', 'æµ‹è¯•é€šè¿‡', 'Tokenåˆ·æ–°æ²¡æœ‰è§¦å‘ä¸å¿…è¦çš„é€šçŸ¥ âœ…');
                    }
                }, 500);
            } else {
                addResult('auth-test-results', 'warning', 'æ— æ³•æµ‹è¯•', 'ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•æµ‹è¯•Tokenåˆ·æ–°');
            }
        }

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', function() {
            const status = document.getElementById('visibility-status');
            status.textContent = document.hidden ? 'éšè—' : 'å¯è§';
            
            if (isMonitoring) {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] é¡µé¢å¯è§æ€§å˜åŒ–: ${document.hidden ? 'éšè—' : 'å¯è§'}`);
            }
        });

        // ç›‘å¬çª—å£ç„¦ç‚¹å˜åŒ–
        window.addEventListener('focus', function() {
            if (isMonitoring) {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] çª—å£è·å¾—ç„¦ç‚¹`);
            }
        });

        window.addEventListener('blur', function() {
            if (isMonitoring) {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] çª—å£å¤±å»ç„¦ç‚¹`);
            }
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateStatus();
                startNotificationMonitoring();
                
                // æ£€æŸ¥æ˜¯å¦ä»å¤–éƒ¨é“¾æ¥è¿”å›
                const externalNavTime = localStorage.getItem('externalNavTime');
                if (externalNavTime) {
                    const timeDiff = Date.now() - parseInt(externalNavTime);
                    if (timeDiff < 60000) { // 1åˆ†é’Ÿå†…
                        addResult('visibility-test-results', 'info', 'å¤–éƒ¨è¿”å›æ£€æµ‹', `æ£€æµ‹åˆ°ä»å¤–éƒ¨ç½‘ç«™è¿”å› (${Math.round(timeDiff/1000)}ç§’å‰)`);
                    }
                    localStorage.removeItem('externalNavTime');
                }
            }, 1000);
        });

        // å®šæœŸæ›´æ–°çŠ¶æ€
        setInterval(updateStatus, 5000);
    </script>
</body>
</html>
