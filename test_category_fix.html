<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç±»æ˜¾ç¤ºä¿®å¤æµ‹è¯• - AIæç¤ºè¯å®åº“</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f8fafc;
        }
        .test-result {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { background: #f0fdf4; border: 1px solid #22c55e; color: #166534; }
        .error { background: #fef2f2; border: 1px solid #ef4444; color: #dc2626; }
        .warning { background: #fffbeb; border: 1px solid #f59e0b; color: #d97706; }
        .info { background: #f0f9ff; border: 1px solid #3b82f6; color: #1d4ed8; }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #4338ca; }
        h2 { color: #1f2937; margin-top: 2rem; }
        h3 { color: #374151; }
        .prompt-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            background: white;
        }
        .prompt-card-category {
            background: #4f46e5;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }
        .data-structure {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin: 1rem 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/ui.js"></script>
</head>
<body>
    <h1>ğŸ”§ åˆ†ç±»æ˜¾ç¤ºä¿®å¤æµ‹è¯•</h1>
    <p>æ­¤å·¥å…·ç”¨äºæµ‹è¯•é¦–é¡µå’Œ"æˆ‘çš„ç©ºé—´"é¡µé¢çš„åˆ†ç±»æ˜¾ç¤ºä¿®å¤æ•ˆæœã€‚</p>

    <div class="test-section">
        <h3>ğŸ  é¦–é¡µæç¤ºè¯æŸ¥è¯¢æµ‹è¯•</h3>
        <button onclick="testHomePageQuery()">æµ‹è¯•é¦–é¡µæŸ¥è¯¢</button>
        <button onclick="renderHomePageCards()">æ¸²æŸ“é¦–é¡µå¡ç‰‡</button>
        <div id="home-results"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ‘¤ æˆ‘çš„ç©ºé—´æç¤ºè¯æŸ¥è¯¢æµ‹è¯•</h3>
        <button onclick="testMySpaceQuery()">æµ‹è¯•æˆ‘çš„ç©ºé—´æŸ¥è¯¢</button>
        <button onclick="renderMySpaceCards()">æ¸²æŸ“æˆ‘çš„ç©ºé—´å¡ç‰‡</button>
        <div id="myspace-results"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“Š æ•°æ®ç»“æ„å¯¹æ¯”</h3>
        <button onclick="compareDataStructures()">å¯¹æ¯”æ•°æ®ç»“æ„</button>
        <div id="compare-results"></div>
    </div>

    <script>
        let homePageData = null;
        let mySpaceData = null;

        function addResult(containerId, type, title, content) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${title}</strong>\n${content}`;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function testHomePageQuery() {
            clearResults('home-results');
            
            try {
                addResult('home-results', 'info', 'æµ‹è¯•é¦–é¡µæŸ¥è¯¢', 'æ‰§è¡Œä¸å¸¦userIdçš„æŸ¥è¯¢...');

                const result = await apiManager.getPrompts({
                    page: 1,
                    pageSize: 3
                });

                if (result.success) {
                    homePageData = result.data;
                    addResult('home-results', 'success', 'é¦–é¡µæŸ¥è¯¢æˆåŠŸ', `æ‰¾åˆ° ${result.data.length} æ¡è®°å½•`);
                    
                    // æ˜¾ç¤ºæ•°æ®ç»“æ„
                    if (result.data.length > 0) {
                        const sample = result.data[0];
                        const dataStructure = `
æ•°æ®ç»“æ„ç¤ºä¾‹:
{
  prompt_id: ${sample.prompt_id}
  title: "${sample.title}"
  category_id: ${sample.category_id}
  category_name: "${sample.category_name || 'NULL'}"
  categories: ${JSON.stringify(sample.categories, null, 2)}
  users: ${JSON.stringify(sample.users, null, 2)}
}
                        `;
                        addResult('home-results', 'info', 'æ•°æ®ç»“æ„', dataStructure);
                    }
                } else {
                    addResult('home-results', 'error', 'é¦–é¡µæŸ¥è¯¢å¤±è´¥', result.error);
                }

            } catch (error) {
                addResult('home-results', 'error', 'æµ‹è¯•å¤±è´¥', error.message);
            }
        }

        async function testMySpaceQuery() {
            clearResults('myspace-results');
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    addResult('myspace-results', 'warning', 'éœ€è¦ç™»å½•', 'è¯·å…ˆç™»å½•ä»¥æµ‹è¯•æˆ‘çš„ç©ºé—´æŸ¥è¯¢');
                    return;
                }

                const userId = session.user.id;
                addResult('myspace-results', 'info', 'æµ‹è¯•æˆ‘çš„ç©ºé—´æŸ¥è¯¢', `ä½¿ç”¨ç”¨æˆ·ID: ${userId}`);

                const result = await apiManager.getPrompts({
                    page: 1,
                    pageSize: 3,
                    userId: userId
                });

                if (result.success) {
                    mySpaceData = result.data;
                    addResult('myspace-results', 'success', 'æˆ‘çš„ç©ºé—´æŸ¥è¯¢æˆåŠŸ', `æ‰¾åˆ° ${result.data.length} æ¡è®°å½•`);
                    
                    // æ˜¾ç¤ºæ•°æ®ç»“æ„
                    if (result.data.length > 0) {
                        const sample = result.data[0];
                        const dataStructure = `
æ•°æ®ç»“æ„ç¤ºä¾‹:
{
  prompt_id: ${sample.prompt_id}
  title: "${sample.title}"
  category_id: ${sample.category_id}
  category_name: "${sample.category_name || 'NULL'}"
  categories: ${JSON.stringify(sample.categories, null, 2)}
  users: ${JSON.stringify(sample.users, null, 2)}
}
                        `;
                        addResult('myspace-results', 'info', 'æ•°æ®ç»“æ„', dataStructure);
                    }
                } else {
                    addResult('myspace-results', 'error', 'æˆ‘çš„ç©ºé—´æŸ¥è¯¢å¤±è´¥', result.error);
                }

            } catch (error) {
                addResult('myspace-results', 'error', 'æµ‹è¯•å¤±è´¥', error.message);
            }
        }

        async function renderHomePageCards() {
            clearResults('home-results');
            
            if (!homePageData || homePageData.length === 0) {
                addResult('home-results', 'warning', 'æ²¡æœ‰æ•°æ®', 'è¯·å…ˆè¿è¡Œé¦–é¡µæŸ¥è¯¢æµ‹è¯•');
                return;
            }

            addResult('home-results', 'info', 'æ¸²æŸ“é¦–é¡µå¡ç‰‡', 'ä½¿ç”¨UI.createPromptCardæ–¹æ³•...');

            try {
                const container = document.createElement('div');
                homePageData.forEach(prompt => {
                    const card = UI.createPromptCard(prompt, 'card', {});
                    container.appendChild(card);
                });

                addResult('home-results', 'success', 'é¦–é¡µå¡ç‰‡æ¸²æŸ“æˆåŠŸ', container.innerHTML);

                // æ£€æŸ¥åˆ†ç±»æ˜¾ç¤º
                const categories = homePageData.map(p => {
                    const categoryInfo = p.categories || {};
                    const categoryName = categoryInfo.name || p.category_name || 'æœªåˆ†ç±»';
                    return `${p.title}: ${categoryName}`;
                });

                addResult('home-results', 'info', 'åˆ†ç±»æ˜¾ç¤ºæ£€æŸ¥', categories.join('\n'));

            } catch (error) {
                addResult('home-results', 'error', 'æ¸²æŸ“å¤±è´¥', error.message);
            }
        }

        async function renderMySpaceCards() {
            clearResults('myspace-results');
            
            if (!mySpaceData || mySpaceData.length === 0) {
                addResult('myspace-results', 'warning', 'æ²¡æœ‰æ•°æ®', 'è¯·å…ˆè¿è¡Œæˆ‘çš„ç©ºé—´æŸ¥è¯¢æµ‹è¯•');
                return;
            }

            addResult('myspace-results', 'info', 'æ¸²æŸ“æˆ‘çš„ç©ºé—´å¡ç‰‡', 'ä½¿ç”¨ä¿®å¤åçš„createMyPromptCardæ–¹æ³•...');

            try {
                // æ¨¡æ‹ŸMySpaceManagerçš„createMyPromptCardæ–¹æ³•
                const container = document.createElement('div');
                mySpaceData.forEach(prompt => {
                    const card = document.createElement('div');
                    card.className = 'prompt-card';
                    
                    // ä½¿ç”¨ä¿®å¤åçš„é€»è¾‘
                    const categoryName = prompt.categories?.name || prompt.category_name || 'æœªåˆ†ç±»';
                    
                    card.innerHTML = `
                        <div class="prompt-card-header">
                            <h3>${prompt.title}</h3>
                            <div class="prompt-card-meta">
                                <span class="prompt-card-category">${categoryName}</span>
                                <span>${new Date(prompt.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });

                addResult('myspace-results', 'success', 'æˆ‘çš„ç©ºé—´å¡ç‰‡æ¸²æŸ“æˆåŠŸ', container.innerHTML);

                // æ£€æŸ¥åˆ†ç±»æ˜¾ç¤º
                const categories = mySpaceData.map(p => {
                    const categoryName = p.categories?.name || p.category_name || 'æœªåˆ†ç±»';
                    return `${p.title}: ${categoryName}`;
                });

                addResult('myspace-results', 'info', 'åˆ†ç±»æ˜¾ç¤ºæ£€æŸ¥', categories.join('\n'));

            } catch (error) {
                addResult('myspace-results', 'error', 'æ¸²æŸ“å¤±è´¥', error.message);
            }
        }

        async function compareDataStructures() {
            clearResults('compare-results');
            
            if (!homePageData || !mySpaceData) {
                addResult('compare-results', 'warning', 'æ•°æ®ä¸å®Œæ•´', 'è¯·å…ˆè¿è¡Œé¦–é¡µå’Œæˆ‘çš„ç©ºé—´æŸ¥è¯¢æµ‹è¯•');
                return;
            }

            const homeStructure = homePageData[0] || {};
            const mySpaceStructure = mySpaceData[0] || {};

            const comparison = `
é¦–é¡µæ•°æ®ç»“æ„:
- category_name: ${homeStructure.category_name || 'NULL'}
- categories: ${JSON.stringify(homeStructure.categories)}
- users: ${JSON.stringify(homeStructure.users)}

æˆ‘çš„ç©ºé—´æ•°æ®ç»“æ„:
- category_name: ${mySpaceStructure.category_name || 'NULL'}
- categories: ${JSON.stringify(mySpaceStructure.categories)}
- users: ${JSON.stringify(mySpaceStructure.users)}

åˆ†ç±»æ˜¾ç¤ºé€»è¾‘:
- é¦–é¡µ: categoryInfo.name || prompt.category_name || 'æœªåˆ†ç±»'
- æˆ‘çš„ç©ºé—´: prompt.categories?.name || prompt.category_name || 'æœªåˆ†ç±»'

ç»“è®º:
${homeStructure.categories && mySpaceStructure.categories ? 
  'âœ… ä¸¤ä¸ªé¡µé¢éƒ½æœ‰categorieså…³è”æ•°æ®' : 
  'âŒ ç¼ºå°‘categorieså…³è”æ•°æ®'}
            `;

            addResult('compare-results', 'info', 'æ•°æ®ç»“æ„å¯¹æ¯”', comparison);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(() => {
                testHomePageQuery();
            }, 1000);
        });
    </script>
</body>
</html>
