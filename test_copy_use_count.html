<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤åˆ¶æŒ‰é’®ä½¿ç”¨é‡æµ‹è¯• - AIæç¤ºè¯å®åº“</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f8fafc;
        }
        .test-result {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { background: #f0fdf4; border: 1px solid #22c55e; color: #166534; }
        .error { background: #fef2f2; border: 1px solid #ef4444; color: #dc2626; }
        .warning { background: #fffbeb; border: 1px solid #f59e0b; color: #d97706; }
        .info { background: #f0f9ff; border: 1px solid #3b82f6; color: #1d4ed8; }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #4338ca; }
        h2 { color: #1f2937; margin-top: 2rem; }
        h3 { color: #374151; }
        .prompt-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            background: white;
        }
        .use-count {
            font-weight: bold;
            color: #059669;
        }
        .test-prompt {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }
        .action-buttons button {
            flex: 1;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
</head>
<body>
    <h1>ğŸ” å¤åˆ¶æŒ‰é’®ä½¿ç”¨é‡æµ‹è¯•</h1>
    <p>æ­¤å·¥å…·ç”¨äºæµ‹è¯•ç‚¹å‡»"å¤åˆ¶æç¤ºè¯"æŒ‰é’®æ—¶ä½¿ç”¨é‡æ˜¯å¦æ­£ç¡®å¢åŠ ã€‚</p>

    <div class="test-section">
        <h3>ğŸ“Š é€‰æ‹©æµ‹è¯•æç¤ºè¯</h3>
        <button onclick="loadTestPrompts()">åŠ è½½æµ‹è¯•æç¤ºè¯</button>
        <div id="prompts-list"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ§ª ä½¿ç”¨é‡æµ‹è¯•</h3>
        <div id="selected-prompt"></div>
        <div class="action-buttons">
            <button onclick="simulateCopyClick()" id="copy-btn" disabled>æ¨¡æ‹Ÿ"å¤åˆ¶æç¤ºè¯"</button>
            <button onclick="simulateUseClick()" id="use-btn" disabled>æ¨¡æ‹Ÿ"ä½¿ç”¨æç¤ºè¯"</button>
            <button onclick="checkUseCount()" id="check-btn" disabled>æ£€æŸ¥ä½¿ç”¨é‡</button>
        </div>
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“ˆ ä½¿ç”¨æ—¥å¿—å¯¹æ¯”</h3>
        <button onclick="showUsageHistory()" id="history-btn" disabled>æŸ¥çœ‹ä½¿ç”¨å†å²</button>
        <div id="history-results"></div>
    </div>

    <script>
        let selectedPromptId = null;
        let selectedPromptContent = '';
        let initialUseCount = 0;

        function addResult(containerId, type, title, content) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${title}</strong>\n${content}`;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function loadTestPrompts() {
            clearResults('prompts-list');
            
            try {
                addResult('prompts-list', 'info', 'åŠ è½½æµ‹è¯•æç¤ºè¯', 'æ­£åœ¨è·å–æç¤ºè¯åˆ—è¡¨...');

                const { data, error } = await supabase
                    .from('prompts')
                    .select('prompt_id, title, content, use_count, status')
                    .eq('status', 'published')
                    .eq('is_public', true)
                    .limit(5);

                if (error) {
                    addResult('prompts-list', 'error', 'åŠ è½½å¤±è´¥', error.message);
                    return;
                }

                if (data.length === 0) {
                    addResult('prompts-list', 'warning', 'æ²¡æœ‰æ•°æ®', 'æ²¡æœ‰æ‰¾åˆ°å…¬å¼€çš„æç¤ºè¯');
                    return;
                }

                clearResults('prompts-list');
                addResult('prompts-list', 'success', 'åŠ è½½æˆåŠŸ', `æ‰¾åˆ° ${data.length} ä¸ªæç¤ºè¯`);

                // åˆ›å»ºæç¤ºè¯é€‰æ‹©åˆ—è¡¨
                const container = document.getElementById('prompts-list');
                data.forEach(prompt => {
                    const promptDiv = document.createElement('div');
                    promptDiv.className = 'test-prompt';
                    promptDiv.innerHTML = `
                        <h4>${prompt.title}</h4>
                        <p>å½“å‰ä½¿ç”¨é‡: <span class="use-count">${prompt.use_count || 0}</span></p>
                        <p>å†…å®¹é¢„è§ˆ: ${prompt.content.substring(0, 100)}...</p>
                        <button onclick="selectPrompt(${prompt.prompt_id}, '${prompt.title.replace(/'/g, "\\'")}', '${prompt.content.replace(/'/g, "\\'")}', ${prompt.use_count || 0})">
                            é€‰æ‹©æ­¤æç¤ºè¯è¿›è¡Œæµ‹è¯•
                        </button>
                    `;
                    container.appendChild(promptDiv);
                });

            } catch (error) {
                addResult('prompts-list', 'error', 'æµ‹è¯•å¤±è´¥', error.message);
            }
        }

        function selectPrompt(promptId, title, content, useCount) {
            selectedPromptId = promptId;
            selectedPromptContent = content;
            initialUseCount = useCount;

            const container = document.getElementById('selected-prompt');
            container.innerHTML = `
                <div class="test-prompt">
                    <h4>å·²é€‰æ‹©: ${title}</h4>
                    <p>æç¤ºè¯ID: ${promptId}</p>
                    <p>åˆå§‹ä½¿ç”¨é‡: <span class="use-count">${useCount}</span></p>
                    <p>å†…å®¹: ${content.substring(0, 200)}...</p>
                </div>
            `;

            // å¯ç”¨æµ‹è¯•æŒ‰é’®
            document.getElementById('copy-btn').disabled = false;
            document.getElementById('use-btn').disabled = false;
            document.getElementById('check-btn').disabled = false;
            document.getElementById('history-btn').disabled = false;

            clearResults('test-results');
            clearResults('history-results');
        }

        async function simulateCopyClick() {
            if (!selectedPromptId) {
                addResult('test-results', 'error', 'é”™è¯¯', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæç¤ºè¯');
                return;
            }

            clearResults('test-results');
            addResult('test-results', 'info', 'æ¨¡æ‹Ÿå¤åˆ¶æ“ä½œ', 'æ­£åœ¨è°ƒç”¨ logUsage æ–¹æ³•ï¼ˆcopyï¼‰...');

            try {
                // æ¨¡æ‹Ÿå¤åˆ¶åˆ°å‰ªè´´æ¿
                await navigator.clipboard.writeText(selectedPromptContent);
                
                // è°ƒç”¨ logUsage æ–¹æ³•ï¼Œä½¿ç”¨ 'copy' åŠ¨ä½œç±»å‹
                const result = await apiManager.logUsage(selectedPromptId, 'copy');

                if (result.success) {
                    addResult('test-results', 'success', 'å¤åˆ¶æ“ä½œæˆåŠŸ', 'å·²è®°å½•å¤åˆ¶æ—¥å¿—å¹¶åº”è¯¥å¢åŠ ä½¿ç”¨é‡');
                    addResult('test-results', 'info', 'æç¤º', 'è¯·ç‚¹å‡»"æ£€æŸ¥ä½¿ç”¨é‡"æŒ‰é’®æŸ¥çœ‹æ›´æ–°åçš„æ•°å€¼');
                } else {
                    addResult('test-results', 'error', 'å¤åˆ¶æ“ä½œå¤±è´¥', result.error || 'æœªçŸ¥é”™è¯¯');
                }

            } catch (error) {
                addResult('test-results', 'error', 'æ“ä½œå¤±è´¥', error.message);
            }
        }

        async function simulateUseClick() {
            if (!selectedPromptId) {
                addResult('test-results', 'error', 'é”™è¯¯', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæç¤ºè¯');
                return;
            }

            clearResults('test-results');
            addResult('test-results', 'info', 'æ¨¡æ‹Ÿä½¿ç”¨æ“ä½œ', 'æ­£åœ¨è°ƒç”¨ logUsage æ–¹æ³•ï¼ˆuseï¼‰...');

            try {
                // æ¨¡æ‹Ÿå¤åˆ¶åˆ°å‰ªè´´æ¿
                await navigator.clipboard.writeText(selectedPromptContent);
                
                // è°ƒç”¨ logUsage æ–¹æ³•ï¼Œä½¿ç”¨ 'use' åŠ¨ä½œç±»å‹
                const result = await apiManager.logUsage(selectedPromptId, 'use');

                if (result.success) {
                    addResult('test-results', 'success', 'ä½¿ç”¨æ“ä½œæˆåŠŸ', 'å·²è®°å½•ä½¿ç”¨æ—¥å¿—å¹¶å¢åŠ ä½¿ç”¨é‡');
                    addResult('test-results', 'info', 'æç¤º', 'è¯·ç‚¹å‡»"æ£€æŸ¥ä½¿ç”¨é‡"æŒ‰é’®æŸ¥çœ‹æ›´æ–°åçš„æ•°å€¼');
                } else {
                    addResult('test-results', 'error', 'ä½¿ç”¨æ“ä½œå¤±è´¥', result.error || 'æœªçŸ¥é”™è¯¯');
                }

            } catch (error) {
                addResult('test-results', 'error', 'æ“ä½œå¤±è´¥', error.message);
            }
        }

        async function checkUseCount() {
            if (!selectedPromptId) {
                addResult('test-results', 'error', 'é”™è¯¯', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæç¤ºè¯');
                return;
            }

            try {
                addResult('test-results', 'info', 'æ£€æŸ¥ä½¿ç”¨é‡', 'æ­£åœ¨æŸ¥è¯¢æœ€æ–°çš„ä½¿ç”¨é‡...');

                const { data, error } = await supabase
                    .from('prompts')
                    .select('use_count')
                    .eq('prompt_id', selectedPromptId)
                    .single();

                if (error) {
                    addResult('test-results', 'error', 'æŸ¥è¯¢å¤±è´¥', error.message);
                    return;
                }

                const currentUseCount = data.use_count || 0;
                const increase = currentUseCount - initialUseCount;

                if (increase > 0) {
                    addResult('test-results', 'success', 'ä½¿ç”¨é‡æ£€æŸ¥ç»“æœ', `
åˆå§‹ä½¿ç”¨é‡: ${initialUseCount}
å½“å‰ä½¿ç”¨é‡: ${currentUseCount}
å¢åŠ æ•°é‡: +${increase}

âœ… ä½¿ç”¨é‡å¢åŠ åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼
                    `);
                } else if (increase === 0) {
                    addResult('test-results', 'warning', 'ä½¿ç”¨é‡æ£€æŸ¥ç»“æœ', `
åˆå§‹ä½¿ç”¨é‡: ${initialUseCount}
å½“å‰ä½¿ç”¨é‡: ${currentUseCount}
å¢åŠ æ•°é‡: ${increase}

âš ï¸ ä½¿ç”¨é‡æ²¡æœ‰å¢åŠ ï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥ï¼š
1. increment_use_count å‡½æ•°æ˜¯å¦å­˜åœ¨
2. æ•°æ®åº“æƒé™æ˜¯å¦æ­£ç¡®
3. logUsage æ–¹æ³•çš„é€»è¾‘æ˜¯å¦æ­£ç¡®
                    `);
                } else {
                    addResult('test-results', 'error', 'ä½¿ç”¨é‡æ£€æŸ¥ç»“æœ', `
åˆå§‹ä½¿ç”¨é‡: ${initialUseCount}
å½“å‰ä½¿ç”¨é‡: ${currentUseCount}
å˜åŒ–: ${increase}

âŒ ä½¿ç”¨é‡å¼‚å¸¸å‡å°‘ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“
                    `);
                }

            } catch (error) {
                addResult('test-results', 'error', 'æ£€æŸ¥å¤±è´¥', error.message);
            }
        }

        async function showUsageHistory() {
            if (!selectedPromptId) {
                addResult('history-results', 'error', 'é”™è¯¯', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæç¤ºè¯');
                return;
            }

            clearResults('history-results');

            try {
                addResult('history-results', 'info', 'æŸ¥çœ‹ä½¿ç”¨å†å²', 'æ­£åœ¨æŸ¥è¯¢ä½¿ç”¨æ—¥å¿—...');

                const { data, error } = await supabase
                    .from('usage_logs')
                    .select('*')
                    .eq('prompt_id', selectedPromptId)
                    .in('action_type', ['use', 'copy'])
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) {
                    addResult('history-results', 'error', 'æŸ¥è¯¢å¤±è´¥', error.message);
                    return;
                }

                if (data.length === 0) {
                    addResult('history-results', 'warning', 'æ²¡æœ‰ä½¿ç”¨è®°å½•', 'è¯¥æç¤ºè¯è¿˜æ²¡æœ‰ä½¿ç”¨è®°å½•');
                    return;
                }

                let historyText = `æœ€è¿‘ ${data.length} æ¬¡ä½¿ç”¨è®°å½•:\n\n`;
                data.forEach((log, index) => {
                    const date = new Date(log.created_at).toLocaleString('zh-CN');
                    const userId = log.user_id || 'åŒ¿åç”¨æˆ·';
                    const actionText = log.action_type === 'copy' ? 'å¤åˆ¶' : 'ä½¿ç”¨';
                    historyText += `${index + 1}. ${date} - ${actionText} - ${userId}\n`;
                });

                addResult('history-results', 'success', 'ä½¿ç”¨å†å²', historyText);

                // ç»Ÿè®¡ä¸åŒåŠ¨ä½œç±»å‹çš„æ•°é‡
                const copyCount = data.filter(log => log.action_type === 'copy').length;
                const useCount = data.filter(log => log.action_type === 'use').length;
                
                addResult('history-results', 'info', 'ç»Ÿè®¡ä¿¡æ¯', `
å¤åˆ¶æ¬¡æ•°: ${copyCount}
ä½¿ç”¨æ¬¡æ•°: ${useCount}
æ€»è®¡: ${copyCount + useCount}

âœ… ä¸¤ç§æ“ä½œéƒ½åº”è¯¥å¢åŠ ä½¿ç”¨é‡
                `);

            } catch (error) {
                addResult('history-results', 'error', 'æŸ¥è¯¢å¤±è´¥', error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æµ‹è¯•æç¤ºè¯
        window.addEventListener('load', () => {
            setTimeout(loadTestPrompts, 1000);
        });
    </script>
</body>
</html>
